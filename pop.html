<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTD Tracker - Modern</title>
    <link rel="icon" href="https://i.pinimg.com/736x/6a/27/26/6a2626c7f2ab9d5e9b3a91626fcc3288.jpg" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/index.min.js"></script>
    <script src="https://unpkg.com/idb@7/build/umd.js"></script>
    <script src="config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --surface: #ffffff;
            --background: #f8fafc;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --border-radius: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: var(--text);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        .tabs {
            display: flex;
            background: var(--background);
            border-bottom: 1px solid var(--border);
        }
        .tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }
        .tab:hover { background: rgba(79, 70, 229, 0.05); }
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--surface);
        }
        .content { 
            padding: 2rem; 
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
            overflow-y: visible;
            position: relative;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section {
            background: var(--background);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        .section h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .form-group label {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }
        .form-group input,
        .form-group select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            background: var(--surface);
            color: var(--text);
        }
        .form-group input:hover,
        .form-group select:hover {
            border-color: rgba(79, 70, 229, 0.5);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.1);
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 
                0 0 0 3px rgba(79, 70, 229, 0.1),
                0 4px 6px -1px rgba(79, 70, 229, 0.1),
                0 2px 4px -1px rgba(79, 70, 229, 0.06);
            transform: translateY(-1px);
            position: relative;
            z-index: 1;
        }
        .form-group input::placeholder {
            color: var(--text-muted);
            opacity: 0.6;
        }
        .form-group {
            overflow: visible;
            position: relative;
        }
        .table-container .form-group {
            margin: 0;
            padding: 0.5rem 0.5rem 0.5rem 0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            position: relative;
        }
        .table-container .form-group input {
            margin: 0;
            width: 100%;
            max-width: 100%;
        }
        .table-container .form-group input:focus {
            box-shadow: none;
            outline: none;
            border-color: var(--border);
        }
        .table-container .form-group input:hover,
        .table-container .form-group input:focus,
        .table-container .form-group input:active {
            transition: none !important;
            transform: none !important;
            box-shadow: none !important;
            border-color: var(--border) !important;
        }
        .table-container .form-group:focus-within {
            transform: none !important;
            transition: none !important;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 0.9rem;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        .btn-secondary { background: var(--text-muted); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }
        .stat-card h4 {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
        }
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 0.75rem 0.5rem 0 0.5rem;
            position: relative;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            min-width: 900px;
        }
        .table th {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .table th:hover {
            background: var(--primary-dark);
        }
        .table th.sortable::after {
            content: '↕️';
            position: absolute;
            right: 0.5rem;
            opacity: 0.7;
        }
        .table th.sort-asc::after {
            content: '↑';
        }
        .table th.sort-desc::after {
            content: '↓';
        }
        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 0;
        }
        .table td:first-child {
            min-width: 120px;
        }
        .table td:nth-child(3) {
            min-width: 120px;
            max-width: 150px;
        }
        .table td input,
        .table td select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.85rem;
            box-sizing: border-box;
        }
        .table tr:hover { background: var(--background); }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-secondary { background: #e5e7eb; color: #374151; }
        .salary-calc {
            background: linear-gradient(135deg, var(--secondary), #059669);
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
        }
        .salary-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .breakdown-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            position: relative;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        
        .breakdown-item.has-warning {
            border: 2px solid #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .breakdown-item.has-limit {
            border: 2px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .breakdown-item.has-success {
            border: 2px solid #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        .breakdown-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }
        .breakdown-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        
        .team-leader-salary-modern {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .tl-salary-hero-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            border-radius: 20px;
            padding: 2rem;
            color: white;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .tl-salary-hero-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            line-height: 16px;
            text-align: center;
            font-weight: bold;
            vertical-align: middle;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .tooltip-container:hover .tooltip-icon {
            opacity: 1;
        }
        
        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            transition: opacity 0.3s, visibility 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            white-space: normal;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.95);
        }
        
        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .limit-indicator {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 12px solid #f59e0b;
            transform: rotate(45deg);
        }
        
        .limit-indicator.limit-reached {
            border-bottom-color: #ef4444;
        }
        .tariff-item {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }
        .tariff-item:hover { border-color: var(--primary); }
        .tariff-range {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: var(--transition);
        }
        .notification.show { transform: translateX(0); }
        .notification.success { 
            background: var(--secondary);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4), 
                        0 0 24px rgba(16, 185, 129, 0.2);
            position: relative;
        }
        
        .notification.success::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                rgba(16, 185, 129, 0.3) 0%, 
                rgba(16, 185, 129, 0.1) 50%, 
                rgba(16, 185, 129, 0.3) 100%);
            border-radius: inherit;
            z-index: -1;
            animation: notification-glow 2s ease-in-out infinite;
        }
        
        @keyframes notification-glow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .notification.error { background: var(--danger); }
        .progress-container {
            margin: 1.5rem 0;
            background: linear-gradient(90deg, #e9ecef 0%, #f1f3f5 100%);
            border-radius: 9999px;
            height: 24px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .progress-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: progressShimmer 2s infinite;
        }
        
        @keyframes progressShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .progress-bar.completed { 
            background: linear-gradient(135deg, var(--secondary), #059669);
            box-shadow: 
                0 0 12px rgba(16, 185, 129, 0.5),
                0 0 24px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
        }
        
        .progress-bar.completed::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.3) 0%, 
                transparent 50%, 
                rgba(255, 255, 255, 0.3) 100%);
            animation: progressShimmer 1.5s ease-in-out infinite;
        }
        
        .progress-bar.partial { 
            background: linear-gradient(135deg, var(--warning), #d97706);
            box-shadow: 
                0 0 8px rgba(245, 158, 11, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .progress-bar.incomplete { 
            background: linear-gradient(135deg, var(--danger), #dc2626);
            box-shadow: 
                0 0 8px rgba(239, 68, 68, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .goal-setting {
            background: rgba(79, 70, 229, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid rgba(79, 70, 229, 0.2);
        }
        .goal-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .goal-item input[type="number"] {
            width: 80px;
        }
        .manager-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .manager-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .modal-content p {
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .pagination button.active {
            background: var(--primary);
            color: white;
        }
        .month-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: var(--surface);
            border-radius: var(--border-radius);
            border: 2px solid var(--border);
            box-shadow: var(--shadow);
            position: relative;
        }
        .month-selector::before {
            content: '📅';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            opacity: 0.6;
        }
        .month-selector > label {
            font-weight: 600;
            color: var(--text);
            margin-left: 2.5rem;
        }
        .month-selector select {
            min-width: 200px;
            padding: 0.75rem 1rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .month-selector select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .delta {
            font-size: 0.8rem;
            font-weight: 600;
        }
        .delta.positive { 
            color: var(--secondary);
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
            font-weight: 600;
        }
        .delta.negative { color: var(--danger); }
        .team-leader-badge {
            background: #fbbf24;
            color: #92400e;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0;
            display: inline-block;
        }
        .sale-badge {
            background: #06b6d4;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0;
            display: inline-block;
        }
        .filter-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-row .form-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 2.5rem;
        }
        .filter-row .form-group label {
            margin: 0;
        }
        .filter-row .form-group input[type="checkbox"] {
            margin: 0;
        }
        .attendance-calendar {
            margin-top: 1rem;
        }
        .attendance-calendar table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .attendance-calendar th,
        .attendance-calendar td {
            border: 1px solid var(--border);
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
        .attendance-calendar th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        .attendance-day {
            cursor: pointer;
            min-width: 40px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--transition);
        }
        .attendance-day:hover {
            transform: scale(1.05);
        }
        .attendance-day.green { background: #dcfce7; color: #166534; }
        .attendance-day.yellow { background: #fef3c7; color: #92400e; }
        .attendance-day.gray { background: #f1f5f9; color: var(--text-muted); }
        .legend {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .tip {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header { padding: 1.5rem; }
            .header h1 { font-size: 2rem; }
            .content { padding: 1.5rem; }
            .tabs { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
            .month-selector { 
                flex-direction: column; 
                align-items: stretch; 
                text-align: center;
            }
            .month-selector > label {
                margin-left: 0;
                margin-bottom: 0.5rem;
            }
            .filter-row { flex-direction: column; align-items: flex-start; }
            .legend { flex-direction: column; gap: 0.5rem; }
            .table-container {
                width: 100%;
                max-width: 100vw;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0.5rem;
                padding-bottom: 0;
                box-sizing: border-box;
            }
            .form-group input {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            .form-group input:focus {
                box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.08);
            }
            .table {
                min-width: 800px;
            }
            .table td {
                font-size: 0.85rem;
                padding: 0.75rem;
            }
        }
        .error-boundary {
            padding: 2rem;
            text-align: center;
            color: var(--danger);
            max-width: 900px;
            margin: 2rem auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #fecaca;
        }
        .error-boundary h2 {
            margin-bottom: 1rem;
            color: var(--danger);
            font-size: 1.5rem;
        }
        .error-details {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            color: #991b1b;
            line-height: 1.5;
        }
        .error-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        .error-boundary button {
            margin-top: 0;
            background: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .notification-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .bar-container {
            font-family: monospace;
            font-size: 1.2rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-10px); }
            70% { transform: translateY(-5px); }
            90% { transform: translateY(-2px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px var(--primary); }
            50% { box-shadow: 0 0 20px var(--primary), 0 0 30px var(--primary); }
        }
        
        @keyframes numberCount {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-fade-out {
            animation: fadeOut 0.3s ease-in;
        }
        
        
        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }
        
        .animate-bounce {
            animation: bounce 0.6s ease-in-out;
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }
        
        .active-scale:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
        
        .btn-animated {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-animated::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-animated:active::before {
            width: 300px;
            height: 300px;
        }
        
        .card-animated {
            transition: all 0.3s ease;
        }
        
        .table-row {
            transition: all 0.2s ease;
        }
        
        .table-row-enter {
            animation: slideInLeft 0.4s ease-out;
        }
        
        .progress-bar-animated {
            transition: width 1s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-animated::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .notification-enter {
            animation: slideInRight 0.4s ease-out;
        }
        
        .notification-error {
            animation: shake 0.5s ease-in-out;
        }
        
        .modal-content {
            animation: scaleIn 0.3s ease-out;
        }
        
        .calendar-day {
            transition: all 0.2s ease;
        }
        
        .calendar-day.clicked {
            animation: bounce 0.6s ease-in-out;
        }
        
        .calendar-day.green {
            position: relative;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4), 
                        0 0 16px rgba(16, 185, 129, 0.2),
                        0 0 24px rgba(16, 185, 129, 0.1);
            background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 50%, transparent 100%);
        }
        
        .calendar-day.green::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                rgba(16, 185, 129, 0.3) 0%, 
                rgba(16, 185, 129, 0.1) 25%, 
                rgba(16, 185, 129, 0.2) 50%, 
                rgba(16, 185, 129, 0.1) 75%, 
                rgba(16, 185, 129, 0.3) 100%);
            border-radius: inherit;
            z-index: -1;
            animation: glow-pulse 2s ease-in-out infinite;
        }
        
        @keyframes glow-pulse {
            0%, 100% { 
                opacity: 0.6;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.05);
            }
        }
        
        .calendar-day.green .icon-bounce {
            filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.6));
            animation: icon-glow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes icon-glow {
            from { 
                filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.6));
            }
            to { 
                filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.8)) 
                       drop-shadow(0 0 12px rgba(16, 185, 129, 0.4));
            }
        }
        
        .green-emoji {
            filter: drop-shadow(0 0 6px rgba(16, 185, 129, 0.6));
            animation: emoji-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes emoji-glow {
            from { 
                filter: drop-shadow(0 0 6px rgba(16, 185, 129, 0.6));
            }
            to { 
                filter: drop-shadow(0 0 12px rgba(16, 185, 129, 0.8)) 
                       drop-shadow(0 0 18px rgba(16, 185, 129, 0.4));
            }
        }
        
        @keyframes bonus-shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
            filter: drop-shadow(0 2px 8px rgba(79, 70, 229, 0.3));
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .goal-item {
            animation: goalItemEnter 0.5s ease-out backwards;
        }
        
        .goal-item:nth-child(1) { animation-delay: 0.1s; }
        .goal-item:nth-child(2) { animation-delay: 0.2s; }
        .goal-item:nth-child(3) { animation-delay: 0.3s; }
        .goal-item:nth-child(4) { animation-delay: 0.4s; }
        .goal-item:nth-child(5) { animation-delay: 0.5s; }
        .goal-item:nth-child(n+6) { animation-delay: 0.6s; }
        
        @keyframes goalItemEnter {
            0% {
                opacity: 0;
                transform: translateX(-20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .goal-item:hover {
            transform: translateX(4px) scale(1.02);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-number {
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
            display: block;
        }
        
        .stat-number.updated {
            animation: numberCount 0.6s ease-out;
        }
        
        .tab {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab.active {
            animation: pulse 0.6s ease-out;
        }
        
        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: var(--primary);
            transition: width 0.3s ease;
        }
        
        .tab.active::after {
            width: 100%;
        }
        
        .form-group {
            transition: all 0.3s ease;
        }
        
        .form-group:focus-within {
            transform: scale(1.02);
        }
        
        .form-input {
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .icon-bounce {
            transition: transform 0.2s ease;
        }
        
        .icon-bounce:hover {
            transform: scale(1.2);
        }
        
        .icon-bounce:active {
            transform: scale(0.9);
        }
        
        .login-glass-3d {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            perspective: 1000px;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .glass-3d-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1;
            overflow: hidden;
        }
        
        .glass-card-3d {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 450px;
        }
        
        .glass-card-inner {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                0 0 60px rgba(102, 126, 234, 0.2);
            overflow: hidden;
            animation: glassCardEnter 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d;
        }
        
        @keyframes glassCardEnter {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.9) rotateX(20deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg);
            }
        }
        
        .glass-reflection {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            pointer-events: none;
            border-radius: 24px 24px 0 0;
        }
        
        .glass-header-3d {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            backdrop-filter: blur(10px);
            padding: 3rem 2rem 2.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-header-3d::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .glass-icon-3d {
            position: relative;
            z-index: 2;
            margin-bottom: 1rem;
        }
        
        .icon-3d-wrapper {
            position: relative;
            display: inline-block;
            transform-style: preserve-3d;
            animation: icon3DFloat 4s ease-in-out infinite;
        }
        
        @keyframes icon3DFloat {
            0%, 100% { transform: translateY(0) rotateY(0deg); }
            50% { transform: translateY(-15px) rotateY(10deg); }
        }
        
        .icon-3d {
            font-size: 4.5rem;
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.3));
            transform: translateZ(20px);
            display: block;
        }
        
        .icon-glow-3d {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            animation: glowPulse 3s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes glowPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.3; }
        }
        
        .glass-title-3d {
            position: relative;
            z-index: 2;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transform: translateZ(10px);
            animation: textShine 3s ease-in-out infinite;
        }
        
        @keyframes textShine {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }
        
        .glass-subtitle {
            position: relative;
            z-index: 2;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }
        .glass-content-3d {
            padding: 2.5rem;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .glass-form-3d {
            transform-style: preserve-3d;
        }
        
        .glass-input-wrapper-3d {
            margin-bottom: 1.5rem;
            transform-style: preserve-3d;
        }
        
        .glass-input-container {
            position: relative;
        }
        
        .glass-input-3d {
            width: 100%;
            padding: 1rem 1rem 1rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            font-size: 1rem;
            color: #1e293b;
            transition: all 0.3s ease;
            outline: none;
            transform-style: preserve-3d;
        }
        
        .glass-input-3d::placeholder {
            color: transparent;
        }
        
        .glass-input-3d:focus {
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 0 0 4px rgba(102, 126, 234, 0.1),
                0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateZ(5px);
        }
        
        .glass-label-3d {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(100, 116, 139, 0.8);
            font-size: 1rem;
            pointer-events: none;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            padding: 0 0.5rem;
            border-radius: 4px;
        }
        
        .glass-input-3d:focus + .glass-label-3d,
        .glass-input-3d:not(:placeholder-shown) + .glass-label-3d {
            top: 0;
            font-size: 0.75rem;
            color: #667eea;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .glass-password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .glass-password-toggle:hover {
            opacity: 1;
        }
        
        .glass-input-line {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            transition: width 0.3s ease, left 0.3s ease;
            border-radius: 2px;
        }
        
        .glass-input-3d:focus ~ .glass-input-line {
            width: 100%;
            left: 0;
        }
        
        .glass-error-3d {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }
        
        .glass-button-3d {
            width: 100%;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            transform-style: preserve-3d;
        }
        
        .glass-button-3d:hover {
            transform: translateY(-2px) translateZ(5px);
            box-shadow: 
                0 10px 30px rgba(102, 126, 234, 0.4),
                0 0 20px rgba(102, 126, 234, 0.2);
        }
        
        .glass-button-3d:active {
            transform: translateY(0) translateZ(0);
        }
        
        .glass-button-3d.loading {
            opacity: 0.8;
            cursor: not-allowed;
        }
        
        .button-content-3d {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .button-spinner-3d {
            animation: spin 1s linear infinite;
        }
        
        .error-icon-3d {
            font-size: 1.2rem;
        }
        
        .button-ripple-3d {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .glass-button-3d:active .button-ripple-3d {
            animation: ripple 0.6s ease-out;
        }
        
        .glass-footer-3d {
            margin-top: 2rem;
            text-align: center;
        }
        
        .security-badge-3d {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        @media (max-width: 640px) {
            .glass-card-3d {
                max-width: 100%;
                margin: 1rem;
            }
            
            .glass-header-3d {
                padding: 2rem 1.5rem 2rem;
            }
            
            .glass-title-3d {
                font-size: 2rem;
            }
            
            .icon-3d {
                font-size: 3rem;
            }
            
            .glass-content-3d {
                padding: 2rem 1.5rem;
            }
            
        }
        .login-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            perspective: 1000px;
        }
        
        .login-loading-content {
            position: relative;
            z-index: 10;
            text-align: center;
            animation: fadeInScale 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(30px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .loading-logo-container {
            position: relative;
            margin-bottom: 3rem;
        }
        
        .loading-logo {
            font-size: 5rem;
            filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.3));
            animation: logoFloat 3s ease-in-out infinite;
            transform-style: preserve-3d;
        }
        
        @keyframes logoFloat {
            0%, 100% {
                transform: translateY(0) rotateY(0deg) scale(1);
            }
            50% {
                transform: translateY(-20px) rotateY(10deg) scale(1.05);
            }
        }
        
        .loading-logo-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, rgba(102, 126, 234, 0.3) 50%, transparent 70%);
            border-radius: 50%;
            animation: glowPulse 2s ease-in-out infinite;
            z-index: -1;
        }
        
        .loading-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: textShimmer 2s ease-in-out infinite;
        }
        
        @keyframes textShimmer {
            0%, 100% {
                filter: brightness(1);
            }
            50% {
                filter: brightness(1.4);
            }
        }
        
        .loading-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin-bottom: 3rem;
            animation: fadeInOut 2s ease-in-out infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
        }
        
        .loading-progress-container {
            width: 400px;
            max-width: 90%;
            margin: 0 auto 2rem;
            position: relative;
        }
        
        .loading-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.8) 0%, 
                rgba(102, 126, 234, 0.9) 50%, 
                rgba(118, 75, 162, 0.9) 100%);
            border-radius: 10px;
            width: 0%;
            animation: progressFill 1.5s ease-out forwards;
            box-shadow: 
                0 0 20px rgba(255, 255, 255, 0.6),
                0 0 40px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .loading-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 100%
            );
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        @keyframes progressFill {
            0% {
                width: 0%;
            }
            100% {
                width: 100%;
            }
        }
        
        .loading-spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .loading-status-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            margin-top: 1.5rem;
            animation: statusPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
        }
        
        @media (max-width: 640px) {
            .loading-title {
                font-size: 2rem;
            }
            
            .loading-logo {
                font-size: 4rem;
            }
            
            .loading-progress-container {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext } = React;
        
        // Чтение конфигурации из config.js (с fallback значениями)
        const config = window.ENV_CONFIG || {};
        
        const users = config.users || {}; 
        
        const TEAM_LEADER_NAME = config.TEAM_LEADER_NAME;
        const TEAM_LEADER_BASE_RATE = config.TEAM_LEADER_BASE_RATE;
        const DEFAULT_BASE_RATE = config.DEFAULT_BASE_RATE;
        const DEFAULT_TARIFFS = config.DEFAULT_TARIFFS || [];
        const AVAILABLE_YEARS = config.AVAILABLE_YEARS || [];
        const TEAM_LEADER_SALARY_PASSWORD = config.TEAM_LEADER_SALARY_PASSWORD;
        const DEFAULT_MANAGERS = config.DEFAULT_MANAGERS || [];
        const INITIAL_MANAGERS = config.INITIAL_MANAGERS || [];
        const INVALID_BONUS_PER_FTD = config.INVALID_BONUS_PER_FTD || 20;
        const TEAM_LEADER_PER_FTD = config.TEAM_LEADER_PER_FTD || 30;
        const TEAM_PLAN_BONUS_AMOUNT = config.TEAM_PLAN_BONUS_AMOUNT || 500;
        const TRAFFIC_OPTIONS = config.TRAFFIC_OPTIONS || [];
        const COUNTRY_OPTIONS = config.COUNTRY_OPTIONS || [];
        
        const DateUtils = {
            getMonthKey(dateStr) {
                const date = new Date(dateStr);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            },
            
            getTodayString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            
            getCurrentMonthKey() {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            },
            
            formatDateShort(dateStr) {
                return new Date(dateStr).toLocaleDateString('ru-RU');
            },
            
            formatMonthWithYear(monthKey) {
                const [year, month] = monthKey.split('-').map(Number);
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long' });
            },
            
            filterByMonth(records, monthKey) {
                const [year, month] = monthKey.split('-').map(Number);
                return records.filter(r => {
                    const date = new Date(r.date);
                    return date.getFullYear() === year && (date.getMonth() + 1) === month;
                });
            },
            
            generateMonthOptions(years = AVAILABLE_YEARS) {
                return years.flatMap(year => 
                    Array.from({length: 12}, (_, m) => {
                        const monthKey = `${year}-${String(m + 1).padStart(2, '0')}`;
                        const date = new Date(year, m);
                        return {
                            value: monthKey,
                            label: date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long' })
                        };
                    })
                );
            }
        };
        
        const DataHelpers = {
            calculatePenaltiesSum(penalties, manager) {
                return penalties
                    .filter(p => p.manager === manager)
                    .reduce((sum, p) => sum + (Math.abs(p.amount) || 0), 0);
            },
            
            calculateBonusesSum(bonuses, manager) {
                return bonuses
                    .filter(b => b.manager === manager)
                    .reduce((sum, b) => sum + (Math.abs(b.amount) || 0), 0);
            },
            
            normalizeBaseRate(manager, storedRate, defaultTariffRate) {
                const numericRate = typeof storedRate === 'number' ? storedRate : parseFloat(storedRate);
                const fallbackRate = manager === TEAM_LEADER_NAME ? TEAM_LEADER_BASE_RATE : defaultTariffRate;
                return !Number.isNaN(numericRate) && numericRate > 0 ? numericRate : fallbackRate;
            }
        };
        
        const FormatUtils = {
            formatCurrency(amount, options = {}) {
                const { 
                    decimals = 0, 
                    showSign = false, 
                    locale = 'ru-RU' 
                } = options;
                const rounded = MathUtils.round(amount);
                const formatted = rounded.toLocaleString(locale);
                const sign = showSign && amount > 0 ? '+' : '';
                return `${sign}$${formatted}`;
            },
            
            formatRatio(value, decimals = 2) {
                return `×${value.toFixed(decimals)}`;
            },
            
            formatDays(value) {
                if (Number.isInteger(value)) {
                    return value.toString();
                }
                return value.toFixed(1);
            }
        };
        
        const MathUtils = {
            clamp(value, min, max) {
                return Math.min(max, Math.max(min, value));
            },
            
            clampProgress(progress) {
                return this.clamp(progress, 0, 100);
            },
            
            round(value) {
                return Math.round(value);
            },
            
            max(...values) {
                return Math.max(...values);
            },
            
            min(...values) {
                return Math.min(...values);
            }
        };
        
        const ProgressUtils = {
            getProgressClass(progress) {
                if (progress === 100) return 'completed';
                if (progress > 70) return 'partial';
                return 'incomplete';
            },
            
            getProgressColor(progress) {
                if (progress === 100) return '#10b981'; 
                if (progress > 70) return '#f59e0b';  
                return '#ef4444'; 
            }
        };
        
        const ManagerUtils = {
            isTeamLeader(manager) {
                return manager === TEAM_LEADER_NAME;
            },
            
            isNewManager(manager, initialManagers) {
                return !initialManagers.includes(manager);
            },
            
            getManagerType(manager, initialManagers) {
                if (this.isTeamLeader(manager)) return 'teamLeader';
                if (this.isNewManager(manager, initialManagers)) return 'sale';
                return 'initial';
            }
        };
        
        const BarUtils = {
            createAttendanceBar(worked, planned, barLength = 22) {
                const filled = MathUtils.round((worked / planned) * barLength);
                let bar = '▓'.repeat(MathUtils.min(filled, barLength)) + '░'.repeat(barLength - MathUtils.min(filled, barLength));
                
                if (worked > planned) {
                    const extra = MathUtils.round(((worked - planned) / planned) * barLength);
                    bar += '▓'.repeat(extra) + ` (+${FormatUtils.formatDays(worked - planned)})`;
                }
                
                return { bar, worked, planned, filled };
            }
        };
        
        const SortUtils = {
            sortRecords(records, sortConfig) {
                if (!sortConfig || !sortConfig.key) return records;
                return [...records].sort((a, b) => {
                    let aValue = a[sortConfig.key];
                    let bValue = b[sortConfig.key];
                    if (sortConfig.key === 'date') {
                        aValue = new Date(aValue);
                        bValue = new Date(bValue);
                    }
                    if (aValue < bValue) {
                        return sortConfig.direction === 'asc' ? -1 : 1;
                    }
                    if (aValue > bValue) {
                        return sortConfig.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            },
            
            getSortClass(key, sortConfig) {
                if (!sortConfig || sortConfig.key !== key) return 'sortable';
                return sortConfig.direction === 'asc' ? 'sort-asc' : 'sort-desc';
            },
            
            getSortDirection(key, currentSortConfig) {
                if (key === 'date') return 'desc';
                if (currentSortConfig && currentSortConfig.key === key && currentSortConfig.direction === 'asc') {
                    return 'desc';
                }
                return 'asc';
            }
        };
        
        const CommonStyles = {
            statCard: {
                marginBottom: '1rem',
                padding: '1rem',
                borderRadius: '8px',
                background: '#f8fafc'
            },
            flexBetween: {
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
            },
            bonusCard: {
                background: 'linear-gradient(135deg, #dcfce7, #bbf7d0)',
                color: '#166534',
                padding: '0.75rem',
                borderRadius: '8px',
                textAlign: 'center',
                fontWeight: '600',
                boxShadow: '0 0 12px rgba(16, 185, 129, 0.3), 0 0 24px rgba(16, 185, 129, 0.1)',
                position: 'relative',
                overflow: 'hidden'
            },
            statsGrid: {
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))',
                gap: '1rem',
                margin: '1rem 0'
            },
            managerHeader: {
                fontSize: '1.1rem',
                color: '#1e293b'
            },
            sectionMargin: {
                margin: '1rem 0'
            },
            progressLabel: {
                fontWeight: '600',
                color: '#1e293b'
            },
            attendanceInfo: {
                marginTop: '1rem',
                opacity: 0.9,
                fontSize: '0.85rem'
            },
            shimmerOverlay: {
                position: 'absolute',
                top: 0,
                left: '-100%',
                width: '100%',
                height: '100%',
                background: 'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent)',
                animation: 'bonus-shimmer 2s ease-in-out infinite'
            },
            columnFlex: {
                display: 'flex',
                flexDirection: 'column',
                gap: '1rem'
            },
            marginBottom: {
                marginBottom: '0.5rem'
            },
            secondaryText: {
                color: 'var(--secondary)',
                fontWeight: '600'
            },
            dangerText: {
                color: 'var(--danger)',
                fontWeight: '600'
            },
            mutedText: {
                color: 'var(--text-muted)'
            },
            mutedTextWithMargin: {
                color: 'var(--text-muted)',
                marginBottom: '1rem'
            },
            centeredText: {
                textAlign: 'center',
                color: 'var(--text-muted)'
            },
            flexAlignCenter: {
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem'
            },
            flexColumnStart: {
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'flex-start'
            },
            flexColumnStartSmall: {
                display: 'flex',
                flexDirection: 'column',
                gap: '0.25rem',
                alignItems: 'flex-start'
            },
            statsGridMedium: {
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
                gap: '1rem',
                margin: '1rem 0'
            },
            statsGridSmall: {
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
                gap: '0.5rem',
                fontSize: '0.9rem'
            },
            plansGrid: {
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                gap: '1rem'
            },
            managerCard: {
                padding: '0.75rem',
                background: 'white',
                borderRadius: '8px',
                border: '1px solid #e2e8f0'
            },
            managerCardHeader: {
                fontWeight: '600',
                color: '#1e293b',
                marginBottom: '0.25rem'
            },
            managerInfoCard: {
                background: '#f8fafc',
                padding: '1rem',
                borderRadius: '8px',
                marginTop: '1rem'
            },
            sectionTitle: {
                color: '#1e293b',
                marginBottom: '0.5rem',
                fontWeight: 600
            },
            bonusBadge: {
                background: '#dcfce7',
                color: '#166534',
                padding: '0.25rem 0.5rem',
                borderRadius: '4px',
                fontSize: '0.8rem',
                fontWeight: '600',
                display: 'inline-block'
            },
            plansSection: {
                margin: '1.5rem 0 1rem 0',
                padding: '1rem',
                background: '#f8fafc',
                borderRadius: '8px'
            },
            flexAlignBaseline: {
                display: 'flex',
                alignItems: 'baseline',
                gap: '0.5rem'
            },
            largeStat: {
                fontSize: '2rem',
                fontWeight: 800
            },
            mediumStat: {
                fontSize: '1.2rem',
                color: '#1e293b'
            },
            smallText: {
                color: '#64748b',
                fontSize: '0.9rem'
            },
            paddingLarge: {
                padding: '2rem'
            },
            marginBottomSmall: {
                marginBottom: '1rem'
            },
            marginTopSmall: {
                marginTop: '1rem'
            },
            flexGap: {
                display: 'flex',
                gap: '1rem'
            },
            warningSection: {
                background: '#fef3c7',
                border: '1px solid #f59e0b'
            },
            warningText: {
                color: '#1e293b',
                fontSize: '0.9rem',
                marginBottom: '0.5rem'
            },
            warningTitle: {
                color: '#f59e0b'
            },
            scrollableTable: {
                maxHeight: '400px',
                overflowY: 'auto'
            },
            compactTable: {
                width: '100%',
                borderCollapse: 'collapse',
                fontSize: '0.9rem'
            },
            stickyTableHeader: {
                background: 'rgba(79, 70, 229, 0.1)',
                position: 'sticky',
                top: 0,
                zIndex: 1
            },
            tableHeaderCell: {
                padding: '0.75rem',
                textAlign: 'left',
                fontWeight: '600',
                borderBottom: '2px solid rgba(79, 70, 229, 0.3)'
            },
            tableHeaderCellCenter: {
                padding: '0.75rem',
                textAlign: 'center',
                fontWeight: '600',
                borderBottom: '2px solid rgba(79, 70, 229, 0.3)'
            },
            tableRowEven: {
                borderBottom: '1px solid rgba(0, 0, 0, 0.1)',
                background: 'rgba(255, 255, 255, 0.5)'
            },
            tableRowOdd: {
                borderBottom: '1px solid rgba(0, 0, 0, 0.1)',
                background: 'rgba(255, 255, 255, 0.3)'
            },
            tableCell: {
                padding: '0.75rem'
            },
            tableCellCenter: {
                padding: '0.75rem',
                textAlign: 'center'
            },
            tableCellBold: {
                padding: '0.75rem',
                fontWeight: '600'
            },
            tableCellCenterBold: {
                padding: '0.75rem',
                textAlign: 'center',
                fontWeight: '600'
            },
            hiddenInput: {
                display: 'none'
            },
            cursorPointer: {
                cursor: 'pointer'
            },
            statCardBackground: {
                background: 'rgba(255, 255, 255, 0.15)',
                padding: '1rem',
                borderRadius: '8px',
                textAlign: 'center'
            },
            statCardLabel: {
                fontSize: '0.85rem',
                opacity: 0.9,
                marginBottom: '0.25rem'
            },
            statCardValue: {
                fontSize: '1.8rem',
                fontWeight: '700'
            },
            statCardValueSmall: {
                fontSize: '1.2rem',
                fontWeight: '600'
            },
            bonusCardInline: {
                flex: 1,
                background: '#d1fae5',
                padding: '0.75rem',
                borderRadius: '8px',
                textAlign: 'center',
                border: '1px solid #a7f3d0'
            }
        };
        
        const StorageUtils = (() => {
            let db = null;
            const DB_NAME = config.DB_NAME || 'FTDTrackerDB';
            const DB_VERSION = config.DB_VERSION || 1;
            const STORE_NAME = config.STORE_NAME || 'data';
            const MIGRATION_KEY = config.MIGRATION_KEY || 'migration_completed';

            const initDB = async () => {
                if (db) return db;
                
                try {
                    db = await idb.openDB(DB_NAME, DB_VERSION, {
                        upgrade(db) {
                            if (!db.objectStoreNames.contains(STORE_NAME)) {
                                db.createObjectStore(STORE_NAME, { keyPath: 'key' });
                            }
                        }
                    });
                    return db;
                } catch (error) {
                    throw error;
                }
            };

            const migrateFromLocalStorage = async () => {
                try {
                    const migrationCompleted = localStorage.getItem(MIGRATION_KEY);
                    if (migrationCompleted) return;

                    
                    const keys = [
                        'ftdRecords', 'penalties', 'bonuses', 'tariffs', 
                        'monthlyGoals', 'plannedDays', 'attendance', 
                        'managers', 'managerBaseRates', 'sortConfig', 'invalidBonusPerFTD', 
                        'teamLeaderPerFTD', 'teamPlanBonusAmount', 'activeTab', 'loggedIn', 'loginTime'
                    ];

                    const database = await initDB();
                    const tx = database.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);

                    let migratedCount = 0;
                    for (const key of keys) {
                        const value = localStorage.getItem(key);
                        if (value !== null) {
                            try {
                                const parsedValue = JSON.parse(value);
                                await store.put({ key, value: parsedValue });
                                migratedCount++;
                            } catch (parseError) {
                            }
                        }
                    }

                    await tx.done;
                    
                    localStorage.setItem(MIGRATION_KEY, 'true');
                    
                    const systemKeys = ['activeTab', 'loggedIn', 'loginTime'];
                    for (const key of keys) {
                        if (!systemKeys.includes(key)) {
                            localStorage.removeItem(key);
                        }
                    }
                } catch (error) {
                }
            };

            return {
                async getItem(key, defaultValue = null) {
                    try {
                        await migrateFromLocalStorage();
                        const database = await initDB();
                        const tx = database.transaction(STORE_NAME, 'readonly');
                        const store = tx.objectStore(STORE_NAME);
                        const result = await store.get(key);
                        return result ? result.value : defaultValue;
                    } catch (error) {
                        return defaultValue;
                    }
                },
                
                async setItem(key, value) {
                    try {
                        await migrateFromLocalStorage();
                        const database = await initDB();
                        const tx = database.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        await store.put({ key, value });
                        return true;
                    } catch (error) {
                        return false;
                    }
                },
                
                async removeItem(key) {
                    try {
                        await migrateFromLocalStorage();
                        const database = await initDB();
                        const tx = database.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        await store.delete(key);
                        return true;
                    } catch (error) {
(`Ошибка при удалении ${key} из IndexedDB:`, error);
                        return false;
                    }
                }
            };
        })();
        
        const useSelectedMonth = () => {
            const [selectedMonth, setSelectedMonth] = useState(() => DateUtils.getCurrentMonthKey());
            return [selectedMonth, setSelectedMonth];
        };
        
        const Validator = {
            validateRecord(record) {
                const errors = {};
                if (!record.clientId?.trim()) {
                    errors.clientId = 'ID клиента обязателен';
                }
                if (!record.date) {
                    errors.date = 'Дата обязательна';
                } else if (new Date(record.date) > new Date()) {
                    errors.date = 'Дата не может быть в будущем';
                }
                if (!record.manager) {
                    errors.manager = 'Менеджер обязателен';
                }
                if (!['valid', 'invalid', 'pending', 'not_counted'].includes(record.validity)) {
                    errors.validity = 'Некорректный статус валидности';
                }
                return {
                    isValid: Object.keys(errors).length === 0,
                    errors
                };
            },
            validateTariff(tariff, index, tariffs) {
                const errors = {};
                if (tariff.baseRate < 0) {
                    errors.baseRate = 'Базовая ставка не может быть отрицательной';
                }
                if (tariff.bonusPerFTD < 0) {
                    errors.bonusPerFTD = 'Бонус не может быть отрицательным';
                }
                if (tariff.min >= tariff.max && tariff.max !== 999) {
                    errors.range = 'Минимум должен быть меньше максимума';
                }
                const overlapping = tariffs.find((t, i) => {
                    if (i === index) return false;
                    return (tariff.min >= t.min && tariff.min <= t.max) ||
                           (tariff.max >= t.min && tariff.max <= t.max);
                });
                if (overlapping) {
                    errors.range = 'Диапазон пересекается с существующим';
                }
                return {
                    isValid: Object.keys(errors).length === 0,
                    errors
                };
            }
        };
        const ErrorDisplay = ({ error, onClose, onReload }) => {
            const [copied, setCopied] = useState(false);
            
            const getErrorDetails = () => {
                if (!error) return 'Неизвестная ошибка';
                
                let details = '';
                
                if (error.type) {
                    details += `Тип: ${error.type}\n\n`;
                }
                
                details += `Ошибка: ${error.message || error.toString() || 'Неизвестная ошибка'}\n\n`;
                
                if (error.filename) {
                    details += `Файл: ${error.filename}\n`;
                }
                
                if (error.lineno !== undefined) {
                    details += `Строка: ${error.lineno}\n`;
                }
                
                if (error.colno !== undefined) {
                    details += `Колонка: ${error.colno}\n`;
                }
                
                if (error.timestamp) {
                    details += `Время: ${new Date(error.timestamp).toLocaleString('ru-RU')}\n`;
                }
                
                if (error.stack) {
                    details += `\nStack Trace:\n${error.stack}\n`;
                }
                
                if (error.error) {
                    details += `\nДетали ошибки:\n${error.error.message || error.error.toString()}\n`;
                    if (error.error.stack) {
                        details += `\n${error.error.stack}`;
                    }
                }
                
                if (error.message && error.message.includes('Unexpected token')) {
                    details += `\n⚠️ Это синтаксическая ошибка. Проверьте код на наличие:\n`;
                    details += `- Незакрытых скобок или кавычек\n`;
                    details += `- Лишних или отсутствующих запятых\n`;
                    details += `- Неправильного синтаксиса\n`;
                }
                
                return details;
            };
            
            const errorDetails = getErrorDetails();
            
            const copyToClipboard = async () => {
                try {
                    await navigator.clipboard.writeText(errorDetails);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    const textArea = document.createElement('textarea');
                    textArea.value = errorDetails;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        setCopied(true);
                        setTimeout(() => setCopied(false), 2000);
                    } catch (e) {
                    }
                    document.body.removeChild(textArea);
                }
            };
            
            return (
                <div className="error-boundary">
                    <h2>⚠️ Произошла ошибка</h2>
                    <p style={{ marginBottom: '1rem', color: '#64748b' }}>
                        {error?.message || 'Неизвестная ошибка'}
                    </p>
                    
                    <div className="error-details">
                        {errorDetails}
                    </div>
                    
                    <div className="error-actions">
                        <button 
                            className="btn btn-primary"
                            onClick={copyToClipboard}
                            style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}
                        >
                            {copied ? '✅ Скопировано!' : '📋 Копировать ошибку'}
                        </button>
                        {onClose && (
                            <button 
                                className="btn btn-secondary"
                                onClick={onClose}
                            >
                                Закрыть
                            </button>
                        )}
                        <button 
                            className="btn btn-danger"
                            onClick={onReload || (() => window.location.reload())}
                        >
                            🔄 Перезагрузить приложение
                        </button>
                    </div>
                </div>
            );
        };
        
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    hasError: false,
                    error: null
                };
            }
            
            static getDerivedStateFromError(error) {
                return {
                    hasError: true,
                    error: {
                        message: error.message || 'Ошибка в компоненте React',
                        error: error,
                        stack: error.stack,
                        type: 'React Component Error',
                        timestamp: new Date().toISOString()
                    }
                };
            }
            
            componentDidCatch(error, errorInfo) {
                const errorData = {
                    message: error.message || 'Ошибка в компоненте React',
                    error: error,
                    stack: error.stack,
                    componentStack: errorInfo?.componentStack,
                    type: 'React Component Error',
                    timestamp: new Date().toISOString()
                };
                this.setState({
                    hasError: true,
                    error: errorData
                });
            }
            
            render() {
                if (this.state.hasError && this.state.error) {
                    return (
                        <ErrorDisplay 
                            error={this.state.error}
                            onClose={() => {
                                this.setState({
                                    hasError: false,
                                    error: null
                                });
                            }}
                            onReload={() => window.location.reload()}
                        />
                    );
                }
                
                return this.props.children;
            }
        }
        const NotificationContext = createContext();
        const NotificationProvider = ({ children }) => {
            const [notifications, setNotifications] = useState([]);
            const addNotification = useCallback((message, type = 'success', duration = 3000) => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, message, type }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), duration);
            }, []);
            return (
                <NotificationContext.Provider value={{ addNotification }}>
                    {children}
                    <div className="notification-container">
                        {notifications.map(({ id, message, type }) => (
                            <div key={id} className={`notification notification-enter ${type} ${type === 'error' ? 'notification-error' : ''} show`}>
                                <span className="icon-bounce">
                                    {type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
                                </span>
                                {message}
                            </div>
                        ))}
                    </div>
                </NotificationContext.Provider>
            );
        };
        
        const UserContext = createContext({ currentUser: null, login: () => {}, logout: () => {} });
        const UserProvider = ({ children }) => {
            const [currentUser, setCurrentUser] = useState(null);
            
            const login = (username) => {
                const user = users[username];
                if (user) {
                    const userData = {
                        username
                    };
                    setCurrentUser(userData);
                    return true;
                }
                return false;
            };
            
            const logout = () => {
                setCurrentUser(null);
            };
            
            return (
                <UserContext.Provider value={{ currentUser, login, logout }}>
                    {children}
                </UserContext.Provider>
            );
        };
        
        const useUser = () => useContext(UserContext);
        
        const DataContext = createContext();
        const DataProvider = ({ children }) => {
            const [records, setRecords] = useState([]);
            const [penalties, setPenalties] = useState([]);
            const [bonuses, setBonuses] = useState([]);
            const [tariffs, setTariffs] = useState([...DEFAULT_TARIFFS]);
            const [monthlyGoals, setMonthlyGoals] = useState({});
            const [plannedDays, setPlannedDays] = useState({});
            const [attendance, setAttendance] = useState({});
            const defaultManagers = [...DEFAULT_MANAGERS];
            const [managers, setManagers] = useState([...defaultManagers]);
            const [sortConfig, setSortConfig] = useState({ key: 'date', direction: 'desc' });
            const [invalidBonusPerFTD, setInvalidBonusPerFTD] = useState(INVALID_BONUS_PER_FTD);
            const [teamLeaderPerFTD, setTeamLeaderPerFTD] = useState(TEAM_LEADER_PER_FTD);
            const [teamPlanBonusAmount, setTeamPlanBonusAmount] = useState(TEAM_PLAN_BONUS_AMOUNT);
            const [managerBaseRates, setManagerBaseRates] = useState(() => {
                return defaultManagers.reduce((acc, manager) => {
                    acc[manager] = manager === TEAM_LEADER_NAME ? TEAM_LEADER_BASE_RATE : DEFAULT_BASE_RATE;
                    return acc;
                }, {});
            });
            const [disabledAgents, setDisabledAgents] = useState({}); // { monthKey: [manager1, manager2, ...] }
            const [isLoading, setIsLoading] = useState(true);
            const trafficOptions = TRAFFIC_OPTIONS;
            const countryOptions = COUNTRY_OPTIONS;
            const initialManagers = [...INITIAL_MANAGERS];

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const [
                            loadedRecords,
                            loadedPenalties,
                            loadedBonuses,
                            loadedTariffs,
                            loadedMonthlyGoals,
                            loadedPlannedDays,
                            loadedAttendance,
                            loadedManagers,
                            loadedManagerBaseRates,
                            loadedSortConfig,
                            loadedInvalidBonusPerFTD,
                            loadedTeamLeaderPerFTD,
                            loadedTeamPlanBonusAmount,
                            loadedDisabledAgents
                        ] = await Promise.all([
                            StorageUtils.getItem('ftdRecords', []),
                            StorageUtils.getItem('penalties', []),
                            StorageUtils.getItem('bonuses', []),
                            StorageUtils.getItem('tariffs', [...DEFAULT_TARIFFS]),
                            StorageUtils.getItem('monthlyGoals', {}),
                            StorageUtils.getItem('plannedDays', {}),
                            StorageUtils.getItem('attendance', {}),
                            StorageUtils.getItem('managers', [...defaultManagers]),
                            StorageUtils.getItem('managerBaseRates', null),
                            StorageUtils.getItem('sortConfig', { key: 'date', direction: 'desc' }),
                            StorageUtils.getItem('invalidBonusPerFTD', 20),
                            StorageUtils.getItem('teamLeaderPerFTD', 30),
                            StorageUtils.getItem('teamPlanBonusAmount', 500),
                            StorageUtils.getItem('disabledAgents', {})
                        ]);

                        setRecords(loadedRecords);
                        setPenalties(loadedPenalties);
                        setBonuses(loadedBonuses);
                        setTariffs(loadedTariffs);
                        setMonthlyGoals(loadedMonthlyGoals);
                        setPlannedDays(loadedPlannedDays);
                        setAttendance(loadedAttendance);
                        setManagers(loadedManagers);
                        const baseTariffRate = loadedTariffs?.[0]?.baseRate ?? DEFAULT_BASE_RATE;
                        const normalizedBaseRates = (loadedManagers || []).reduce((acc, manager) => {
                            acc[manager] = DataHelpers.normalizeBaseRate(
                                manager, 
                                loadedManagerBaseRates?.[manager], 
                                baseTariffRate
                            );
                            return acc;
                        }, {});
                        setManagerBaseRates(normalizedBaseRates);
                        setSortConfig(loadedSortConfig);
                        setInvalidBonusPerFTD(loadedInvalidBonusPerFTD);
                        setTeamLeaderPerFTD(loadedTeamLeaderPerFTD);
                        setTeamPlanBonusAmount(loadedTeamPlanBonusAmount);
                        setDisabledAgents(loadedDisabledAgents || {});
                        setIsLoading(false);
                    } catch (error) {
                        setIsLoading(false);
                    }
                };

                loadData();
            }, []);
                        
            const getGoalsForMonth = (monthKey) => {
                return monthlyGoals[monthKey] || {};
            };
            const updateMonthlyGoal = async (monthKey, manager, goal) => {
                const monthGoals = { ...getGoalsForMonth(monthKey), [manager]: parseInt(goal) || 0 };
                const newMonthlyGoals = { ...monthlyGoals, [monthKey]: monthGoals };
                setMonthlyGoals(newMonthlyGoals);
                await StorageUtils.setItem('monthlyGoals', newMonthlyGoals);
            };
            const initializeMonthGoals = async (monthKey) => {
                if (!monthlyGoals[monthKey]) {
                    const defaultGoals = {};
                    managers.forEach(manager => {
                        defaultGoals[manager] = 15;
                    });
                    const newMonthlyGoals = { ...monthlyGoals, [monthKey]: defaultGoals };
                    setMonthlyGoals(newMonthlyGoals);
                    await StorageUtils.setItem('monthlyGoals', newMonthlyGoals);
                }
            };
            const getWorkedDays = (monthKey, manager) => {
                const att = attendance[monthKey]?.[manager] || {};
                return Object.values(att).reduce((sum, value) => {
                    if (value === true) return sum + 1;
                    if (value === false) return sum;
                    return sum + (Number(value) || 0);
                }, 0);
            };
            const updatePlannedDays = async (monthKey, days) => {
                const newPlanned = { ...plannedDays, [monthKey]: parseInt(days) || 22 };
                setPlannedDays(newPlanned);
                await StorageUtils.setItem('plannedDays', newPlanned);
            };
            const updateAttendance = async (monthKey, manager, dateStr, value) => {
                let newAttendance = { ...attendance };
                if (!newAttendance[monthKey]) newAttendance[monthKey] = {};
                if (!newAttendance[monthKey][manager]) newAttendance[monthKey][manager] = {};
                
                if (value === undefined) {
                    const currentValue = newAttendance[monthKey][manager][dateStr];
                    if (currentValue === true || currentValue === 1) {
                        delete newAttendance[monthKey][manager][dateStr];
                    } else if (currentValue === 0.5) {
                        newAttendance[monthKey][manager][dateStr] = 1;
                    } else {
                        newAttendance[monthKey][manager][dateStr] = 0.5;
                    }
                } else {
                    if (value === true) {
                        newAttendance[monthKey][manager][dateStr] = 1;
                    } else if (value === false) {
                        delete newAttendance[monthKey][manager][dateStr];
                    } else {
                        newAttendance[monthKey][manager][dateStr] = value;
                    }
                }
                
                setAttendance(newAttendance);
                await StorageUtils.setItem('attendance', newAttendance);
            };
            const addRecord = async (record) => {
                const newRecord = { 
                    ...record, 
                    id: Date.now(),
                    traffic: record.traffic || trafficOptions[0],
                    country: record.country || countryOptions[0]
                };
                const newRecords = [...records, newRecord];
                setRecords(newRecords);
                await StorageUtils.setItem('ftdRecords', newRecords);
                
                const monthKey = DateUtils.getMonthKey(newRecord.date);
                let newAttendance = { ...attendance };
                if (!newAttendance[monthKey]) newAttendance[monthKey] = {};
                if (!newAttendance[monthKey][newRecord.manager]) newAttendance[monthKey][newRecord.manager] = {};
                if (!newAttendance[monthKey][newRecord.manager][newRecord.date]) {
                    newAttendance[monthKey][newRecord.manager][newRecord.date] = 1;
                }
                setAttendance(newAttendance);
                await StorageUtils.setItem('attendance', newAttendance);
            };
            const deleteRecord = async (id) => {
                const newRecords = records.filter(r => r.id !== id);
                setRecords(newRecords);
                await StorageUtils.setItem('ftdRecords', newRecords);
            };
            const updateRecord = async (id, updatedRecord) => {
                const newRecords = records.map(r => (r.id === id ? { ...updatedRecord, id } : r));
                setRecords(newRecords);
                await StorageUtils.setItem('ftdRecords', newRecords);
                
                const oldRecord = records.find(r => r.id === id);
                if (oldRecord) {
                    const oldMonth = DateUtils.getMonthKey(oldRecord.date);
                    const newMonth = DateUtils.getMonthKey(updatedRecord.date);
                    let newAttendance = { ...attendance };
                    
                    if (oldRecord.date !== updatedRecord.date || oldRecord.manager !== updatedRecord.manager) {
                        if (newAttendance[oldMonth]?.[oldRecord.manager]?.[oldRecord.date]) {
                            delete newAttendance[oldMonth][oldRecord.manager][oldRecord.date];
                        }
                    }
                    
                    if (!newAttendance[newMonth]) newAttendance[newMonth] = {};
                    if (!newAttendance[newMonth][updatedRecord.manager]) newAttendance[newMonth][updatedRecord.manager] = {};
                    if (!newAttendance[newMonth][updatedRecord.manager][updatedRecord.date]) {
                        newAttendance[newMonth][updatedRecord.manager][updatedRecord.date] = 1;
                    }
                    setAttendance(newAttendance);
                    await StorageUtils.setItem('attendance', newAttendance);
                }
            };
            const updateTariff = async (index, field, value) => {
                const newTariffs = [...tariffs];
                newTariffs[index][field] = parseFloat(value) || 0;
                const validation = Validator.validateTariff(newTariffs[index], index, newTariffs);
                if (!validation.isValid) {
                    return validation.errors;
                }
                setTariffs(newTariffs);
                await StorageUtils.setItem('tariffs', newTariffs);
                return null;
            };
            const resetTariffs = async () => {
                setTariffs([...DEFAULT_TARIFFS]);
                await StorageUtils.setItem('tariffs', [...DEFAULT_TARIFFS]);
            };
            const updateInvalidBonus = async (value) => {
                const newValue = parseFloat(value) || 0;
                setInvalidBonusPerFTD(newValue);
                await StorageUtils.setItem('invalidBonusPerFTD', newValue);
            };
            const updateTeamLeaderPerFTD = async (value) => {
                const newValue = parseFloat(value) || 0;
                setTeamLeaderPerFTD(newValue);
                await StorageUtils.setItem('teamLeaderPerFTD', newValue);
            };
            const updateTeamPlanBonusAmount = async (value) => {
                const newValue = parseFloat(value) || 0;
                setTeamPlanBonusAmount(newValue);
                await StorageUtils.setItem('teamPlanBonusAmount', newValue);
            };
            const addManager = async (name, baseRateValue, monthKey = null) => {
                if (!name) return;
                const baseTariffRate = tariffs?.[0]?.baseRate ?? DEFAULT_BASE_RATE;
                const defaultBaseRateForNewManager = name === TEAM_LEADER_NAME ? TEAM_LEADER_BASE_RATE : baseTariffRate;
                const parsedBaseRate = parseFloat(baseRateValue);
                const managerRate = !Number.isNaN(parsedBaseRate) && parsedBaseRate > 0
                    ? parsedBaseRate
                    : defaultBaseRateForNewManager;
                const newManagers = [...managers, name];
                setManagers(newManagers);
                await StorageUtils.setItem('managers', newManagers);
                
                const targetMonthKey = monthKey || DateUtils.getCurrentMonthKey();
                const updatedMonthlyGoals = { ...monthlyGoals };
                if (!updatedMonthlyGoals[targetMonthKey]) {
                    updatedMonthlyGoals[targetMonthKey] = {};
                }
                updatedMonthlyGoals[targetMonthKey][name] = 15;
                setMonthlyGoals(updatedMonthlyGoals);
                await StorageUtils.setItem('monthlyGoals', updatedMonthlyGoals);
                
                const updatedAttendance = { ...attendance };
                if (!updatedAttendance[targetMonthKey]) {
                    updatedAttendance[targetMonthKey] = {};
                }
                if (!updatedAttendance[targetMonthKey][name]) {
                    updatedAttendance[targetMonthKey][name] = {};
                }
                setAttendance(updatedAttendance);
                await StorageUtils.setItem('attendance', updatedAttendance);
                
                const newManagerBaseRates = { ...managerBaseRates, [name]: managerRate };
                setManagerBaseRates(newManagerBaseRates);
                await StorageUtils.setItem('managerBaseRates', newManagerBaseRates);
            };
            const deleteManager = async (name) => {
                const newManagers = managers.filter(m => m !== name);
                setManagers(newManagers);
                await StorageUtils.setItem('managers', newManagers);
                const updatedMonthlyGoals = { ...monthlyGoals };
                Object.keys(updatedMonthlyGoals).forEach(monthKey => {
                    delete updatedMonthlyGoals[monthKey][name];
                });
                setMonthlyGoals(updatedMonthlyGoals);
                await StorageUtils.setItem('monthlyGoals', updatedMonthlyGoals);
                const newRecords = records.filter(r => r.manager !== name);
                setRecords(newRecords);
                await StorageUtils.setItem('ftdRecords', newRecords);
                
                let newAttendance = { ...attendance };
                Object.keys(newAttendance).forEach(monthKey => {
                    delete newAttendance[monthKey][name];
                });
                setAttendance(newAttendance);
                await StorageUtils.setItem('attendance', newAttendance);
                const newManagerBaseRates = { ...managerBaseRates };
                delete newManagerBaseRates[name];
                setManagerBaseRates(newManagerBaseRates);
                await StorageUtils.setItem('managerBaseRates', newManagerBaseRates);
            };
            const updateManagerBaseRate = async (manager, value) => {
                const numericValue = parseFloat(value);
                if (Number.isNaN(numericValue) || numericValue < 0) {
                    return false;
                }
                const newManagerBaseRates = { ...managerBaseRates, [manager]: numericValue };
                setManagerBaseRates(newManagerBaseRates);
                await StorageUtils.setItem('managerBaseRates', newManagerBaseRates);
                return true;
            };
            const updateSortConfig = async (newConfig) => {
                setSortConfig(newConfig);
                await StorageUtils.setItem('sortConfig', newConfig);
            };
            const toggleAgentDisabled = async (monthKey, manager) => {
                const monthDisabled = disabledAgents[monthKey] || [];
                const isDisabled = monthDisabled.includes(manager);
                let newDisabledAgents = { ...disabledAgents };
                
                if (!newDisabledAgents[monthKey]) {
                    newDisabledAgents[monthKey] = [];
                }
                
                if (isDisabled) {
                    newDisabledAgents[monthKey] = monthDisabled.filter(m => m !== manager);
                } else {
                    newDisabledAgents[monthKey] = [...monthDisabled, manager];
                }
                
                if (newDisabledAgents[monthKey].length === 0) {
                    delete newDisabledAgents[monthKey];
                }
                
                setDisabledAgents(newDisabledAgents);
                await StorageUtils.setItem('disabledAgents', newDisabledAgents);
            };
            const isAgentDisabled = (monthKey, manager) => {
                return (disabledAgents[monthKey] || []).includes(manager);
            };
            const exportData = () => {
                const data = {
                    ftdRecords: records,
                    penalties: penalties,
                    bonuses: bonuses,
                    tariffs: tariffs,
                    monthlyGoals: monthlyGoals,
                    plannedDays: plannedDays,
                    attendance: attendance,
                    managers: managers,
                    managerBaseRates: managerBaseRates,
                    sortConfig: sortConfig,
                    invalidBonusPerFTD: invalidBonusPerFTD,
                    teamLeaderPerFTD: teamLeaderPerFTD,
                    disabledAgents: disabledAgents
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ftd-tracker-backup.json';
                a.click();
                URL.revokeObjectURL(url);
            };
            const createBackup = async () => {
                const data = {
                    ftdRecords: records,
                    penalties: penalties,
                    bonuses: bonuses,
                    tariffs: tariffs,
                    monthlyGoals: monthlyGoals,
                    plannedDays: plannedDays,
                    attendance: attendance,
                    managers: managers,
                    managerBaseRates: managerBaseRates,
                    sortConfig: sortConfig,
                    invalidBonusPerFTD: invalidBonusPerFTD,
                    teamLeaderPerFTD: teamLeaderPerFTD,
                    disabledAgents: disabledAgents,
                    backupTimestamp: new Date().toISOString()
                };
                const json = JSON.stringify(data, null, 2);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const backupKey = `auto_backup_${timestamp}`;
                await StorageUtils.setItem(backupKey, json);
                const backupList = await StorageUtils.getItem('backupList', []);
                backupList.push({
                    key: backupKey,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Kiev' })
                });
                const maxBackups = 30;
                if (backupList.length > maxBackups) {
                    const oldestBackup = backupList.shift();
                    await StorageUtils.removeItem(oldestBackup.key);
                }
                await StorageUtils.setItem('backupList', backupList);
                await StorageUtils.setItem('lastBackupTime', Date.now());
                return backupKey;
            };
            const importData = (file, onSuccess, onError) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        const validatedRecords = (data.ftdRecords || []).map(record => ({
                            ...record,
                            traffic: trafficOptions.includes(record.traffic) ? record.traffic : trafficOptions[0],
                            country: countryOptions.includes(record.country) ? record.country : countryOptions[0]
                        }));
                        setRecords(validatedRecords);
                        StorageUtils.setItem('ftdRecords', validatedRecords);
                        const validatedPenalties = (data.penalties || []).map(p => ({
                            ...p,
                            amount: Math.abs(parseFloat(p.amount) || 0)
                        }));
                        setPenalties(validatedPenalties);
                        StorageUtils.setItem('penalties', validatedPenalties);
                        const validatedBonuses = (data.bonuses || []).map(b => ({
                            ...b,
                            amount: Math.abs(parseFloat(b.amount) || 0)
                        }));
                        setBonuses(validatedBonuses);
                        StorageUtils.setItem('bonuses', validatedBonuses);
                        const importedTariffs = data.tariffs || [...DEFAULT_TARIFFS];
                        setTariffs(importedTariffs);
                        StorageUtils.setItem('tariffs', importedTariffs);
                        setMonthlyGoals(data.monthlyGoals || {});
                        StorageUtils.setItem('monthlyGoals', data.monthlyGoals || {});
                        setPlannedDays(data.plannedDays || {});
                        StorageUtils.setItem('plannedDays', data.plannedDays || {});
                        setAttendance(data.attendance || {});
                        StorageUtils.setItem('attendance', data.attendance || {});
                        const uniqueManagers = [...new Set(data.managers || [])];
                        setManagers(uniqueManagers);
                        StorageUtils.setItem('managers', uniqueManagers);
                        const defaultTariffRate = data.tariffs?.[0]?.baseRate ?? DEFAULT_BASE_RATE;
                        const importedManagerBaseRates = uniqueManagers.reduce((acc, manager) => {
                            acc[manager] = DataHelpers.normalizeBaseRate(
                                manager, 
                                data.managerBaseRates?.[manager], 
                                defaultTariffRate
                            );
                            return acc;
                        }, {});
                        setManagerBaseRates(importedManagerBaseRates);
                        StorageUtils.setItem('managerBaseRates', importedManagerBaseRates);
                        setSortConfig(data.sortConfig || { key: 'date', direction: 'desc' });
                        StorageUtils.setItem('sortConfig', data.sortConfig || { key: 'date', direction: 'desc' });
                        setInvalidBonusPerFTD(data.invalidBonusPerFTD || 20);
                        StorageUtils.setItem('invalidBonusPerFTD', data.invalidBonusPerFTD || 20);
                        setTeamLeaderPerFTD(data.teamLeaderPerFTD || 30);
                        StorageUtils.setItem('teamLeaderPerFTD', data.teamLeaderPerFTD || 30);
                        setDisabledAgents(data.disabledAgents || {});
                        StorageUtils.setItem('disabledAgents', data.disabledAgents || {});
                        onSuccess('Данные успешно восстановлены!');
                    } catch (err) {
                        onError('Ошибка при восстановлении данных: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            const addPenalty = async (penalty) => {
                const amount = parseFloat(penalty.amount) || 0;
                const newPenalty = {
                    id: Date.now(),
                    date: penalty.date,
                    manager: penalty.manager,
                    comment: penalty.comment || '',
                    amount: Math.abs(amount)
                };
                const newPenalties = [...penalties, newPenalty];
                setPenalties(newPenalties);
                await StorageUtils.setItem('penalties', newPenalties);
            };
            const deletePenalty = async (id) => {
                const newPenalties = penalties.filter(p => p.id !== id);
                setPenalties(newPenalties);
                await StorageUtils.setItem('penalties', newPenalties);
            };
            const updatePenalty = async (id, updated) => {
                const newPenalties = penalties.map(p => (p.id === id ? { ...p, ...updated, amount: Math.abs(parseFloat(updated.amount) || 0) } : p));
                setPenalties(newPenalties);
                await StorageUtils.setItem('penalties', newPenalties);
            };
            const addBonus = async (bonus) => {
                const amount = parseFloat(bonus.amount) || 0;
                const newBonus = {
                    id: Date.now(),
                    date: bonus.date,
                    manager: bonus.manager,
                    comment: bonus.comment || '',
                    amount: Math.abs(amount)
                };
                const newBonuses = [...bonuses, newBonus];
                setBonuses(newBonuses);
                await StorageUtils.setItem('bonuses', newBonuses);
            };
            const deleteBonus = async (id) => {
                const newBonuses = bonuses.filter(b => b.id !== id);
                setBonuses(newBonuses);
                await StorageUtils.setItem('bonuses', newBonuses);
            };
            const updateBonus = async (id, updated) => {
                const newBonuses = bonuses.map(b => (b.id === id ? { ...b, ...updated, amount: Math.abs(parseFloat(updated.amount) || 0) } : b));
                setBonuses(newBonuses);
                await StorageUtils.setItem('bonuses', newBonuses);
            };
            const value = {
                records,
                penalties,
                bonuses,
                tariffs,
                monthlyGoals,
                plannedDays,
                attendance,
                managers,
                managerBaseRates,
                sortConfig,
                invalidBonusPerFTD,
                teamLeaderPerFTD,
                teamPlanBonusAmount,
                disabledAgents,
                trafficOptions,
                countryOptions,
                initialManagers,
                isLoading,
                getMonthKey: DateUtils.getMonthKey,
                getGoalsForMonth,
                updateMonthlyGoal,
                initializeMonthGoals,
                getWorkedDays,
                updatePlannedDays,
                updateAttendance,
                addRecord,
                deleteRecord,
                updateRecord,
                updateTariff,
                resetTariffs,
                updateInvalidBonus,
                updateTeamLeaderPerFTD,
                updateTeamPlanBonusAmount,
                toggleAgentDisabled,
                isAgentDisabled,
                addManager,
                deleteManager,
                updateManagerBaseRate,
                setSortConfig: updateSortConfig,
                exportData,
                importData,
                createBackup,
                addPenalty,
                deletePenalty,
                updatePenalty,
                addBonus,
                deleteBonus,
                updateBonus
            };
            if (isLoading) {
                return (
                    <div className="animate-fade-in" style={{
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        height: '100vh',
                        fontSize: '1.2rem',
                        color: 'var(--primary)',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                    }}>
                        <div className="animate-scale-in" style={{ textAlign: 'center' }}>
                            <div className="loading-spinner" style={{ marginBottom: '1rem', fontSize: '2rem' }}>🔄</div>
                            <div className="animate-fade-in">Загрузка данных<span className="loading-dots"></span></div>
                            <div className="animate-fade-in" style={{ fontSize: '0.9rem', marginTop: '0.5rem', opacity: 0.7 }}>
                                Миграция в IndexedDB
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <DataContext.Provider value={value}>
                    {children}
                </DataContext.Provider>
            );
        };
        const useData = () => useContext(DataContext);
        const useNotification = () => useContext(NotificationContext);
        
        const useMonthData = (selectedMonth) => {
            const { records, penalties, bonuses } = useData();
            
            const monthRecords = useMemo(() => 
                DateUtils.filterByMonth(records, selectedMonth), 
                [records, selectedMonth]
            );
            
            const monthPenalties = useMemo(() => 
                DateUtils.filterByMonth(penalties || [], selectedMonth), 
                [penalties, selectedMonth]
            );
            
            const monthBonuses = useMemo(() => 
                DateUtils.filterByMonth(bonuses || [], selectedMonth), 
                [bonuses, selectedMonth]
            );
            
            return { monthRecords, monthPenalties, monthBonuses };
        };
        
        const ManagerDataCalculator = {
            calculateBaseStats(manager, monthRecords, goals, monthKey, disabledAgents = {}) {
                const stats = Calculator.getManagerStats(monthRecords, manager);
                const monthDisabled = disabledAgents[monthKey] || [];
                const goal = monthDisabled.includes(manager) ? 0 : (goals[manager] || 0);
                const progress = Calculator.getProgressPercentage(goals, manager, stats.valid, monthKey, disabledAgents);
                const bonus = Calculator.getBonusForGoal(goals, manager, stats.valid, monthKey, disabledAgents);
                
                return { stats, goal, progress, bonus };
            },
            
            calculateStatusInfo(manager, monthKey, initialManagers, getWorkedDays) {
                const workedDays = getWorkedDays(monthKey, manager);
                const isTeamLeader = ManagerUtils.isTeamLeader(manager);
                const isNewManager = ManagerUtils.isNewManager(manager, initialManagers);
                
                return { workedDays, isTeamLeader, isNewManager };
            },
            
            calculatePenaltiesAndBonuses(manager, monthPenalties, monthBonuses) {
                const penaltiesSum = DataHelpers.calculatePenaltiesSum(monthPenalties, manager);
                const managerBonuses = DataHelpers.calculateBonusesSum(monthBonuses, manager);
                
                return { penaltiesSum, managerBonuses };
            },
            
            calculateOtherManagersData(manager, managers, monthRecords) {
                const otherManagers = managers.filter(m => m !== manager);
                const otherManagersValid = otherManagers.map(emp => ({
                    emp,
                    valid: Calculator.getManagerStats(monthRecords, emp).valid
                }));
                
                return { otherManagers, otherManagersValid };
            },
            
            calculateTeamData(manager, isTeamLeader, stats, totalValid, managers, initialManagers, goals, monthRecords, teamPlanBonusAmount, monthKey, disabledAgents = {}) {
                if (!isTeamLeader) {
                    return { teamValidForBonus: 0, teamPlanBonus: 0 };
                }
                
                const teamValidForBonus = totalValid - stats.valid;
                const teamPlanBonus = Calculator.getTeamPlanBonus(
                    managers, initialManagers, goals, monthRecords, teamPlanBonusAmount, monthKey, disabledAgents
                );
                
                return { teamValidForBonus, teamPlanBonus };
            },
            
            calculateSalary(config) {
                const {
                    stats,
                    tariffs,
                    invalidBonusPerFTD,
                    plannedDays,
                    manager,
                    goals,
                    otherManagersValid,
                    teamLeaderPerFTD,
                    workedDays,
                    teamValidForBonus,
                    penaltiesSum,
                    teamPlanBonus,
                    managerBonuses,
                    managerBaseRates
                } = config;
                
                return Calculator.calculateSalary({
                    validDeposits: stats.valid,
                    invalidDeposits: stats.invalid,
                    tariffs,
                    invalidBonusPerFTD,
                    plannedDays,
                    manager,
                    goals,
                    otherManagersValid,
                    teamLeaderPerFTD,
                    workedDays,
                    teamValidForBonus,
                    penaltiesAmount: penaltiesSum,
                    teamPlanBonus,
                    managerBonuses,
                    managerBaseRates
                });
            },
            
            calculateTotalWithBonus(salary, bonus, managerBonuses) {
                return salary.totalSalary + bonus + managerBonuses;
            }
        };
        
        const getManagerData = (manager, config) => {
            const {
                monthRecords,
                monthPenalties,
                monthBonuses,
                goals,
                plannedDays,
                monthKey,
                managers,
                initialManagers,
                totalValid,
                tariffs,
                invalidBonusPerFTD,
                teamLeaderPerFTD,
                teamPlanBonusAmount,
                managerBaseRates,
                getWorkedDays
            } = config;
            
            const disabledAgents = config.disabledAgents || {};
            const { stats, goal, progress, bonus } = ManagerDataCalculator.calculateBaseStats(
                manager, monthRecords, goals, monthKey, disabledAgents
            );
            
            const { workedDays, isTeamLeader, isNewManager } = ManagerDataCalculator.calculateStatusInfo(
                manager, monthKey, initialManagers, getWorkedDays
            );
            
            const { penaltiesSum, managerBonuses } = ManagerDataCalculator.calculatePenaltiesAndBonuses(
                manager, monthPenalties, monthBonuses
            );
            
            const { otherManagers, otherManagersValid } = ManagerDataCalculator.calculateOtherManagersData(
                manager, managers, monthRecords
            );
            
            const { teamValidForBonus, teamPlanBonus } = ManagerDataCalculator.calculateTeamData(
                manager, isTeamLeader, stats, totalValid, managers, initialManagers, 
                goals, monthRecords, teamPlanBonusAmount, monthKey, disabledAgents
            );
            
            const salary = ManagerDataCalculator.calculateSalary({
                stats,
                tariffs,
                invalidBonusPerFTD,
                plannedDays,
                manager,
                goals,
                otherManagersValid,
                teamLeaderPerFTD,
                workedDays,
                teamValidForBonus,
                penaltiesSum,
                teamPlanBonus,
                managerBonuses,
                managerBaseRates
            });
            
            const totalWithBonus = ManagerDataCalculator.calculateTotalWithBonus(
                salary, bonus, managerBonuses
            );
            
            return {
                stats,
                goal,
                progress,
                bonus,
                workedDays,
                isTeamLeader,
                isNewManager,
                penaltiesSum,
                managerBonuses,
                otherManagers,
                otherManagersValid,
                teamValidForBonus,
                teamPlanBonus,
                salary,
                totalWithBonus
            };
        };
        const Calculator = {
            calculateSalary(config) {
                const {
                    validDeposits,
                    invalidDeposits,
                    tariffs,
                    invalidBonusPerFTD,
                    plannedDays,
                    manager,
                    goals,
                    otherManagersValid = [],
                    teamLeaderPerFTD = 0,
                    workedDays,
                    teamValidForBonus = 0,
                    penaltiesAmount = 0,
                    teamPlanBonus = 0,
                    managerBonuses = 0,
                    managerBaseRates = {}
                } = config;
                
                const { baseRate, bonusPerFTD } = this._calculateBaseRate(
                    validDeposits, tariffs, manager, managerBaseRates
                );
                
                const bonusAmount = validDeposits * bonusPerFTD;
                const invalidBonus = invalidDeposits * invalidBonusPerFTD;
                const teamLeaderBonus = this._calculateTeamLeaderBonus(
                    manager, teamValidForBonus, teamLeaderPerFTD
                );
                
                const { adjustedBaseRate, adjustmentAmount, dailyRate, overDays, underRatio } = 
                    this._calculateAdjustedRate(baseRate, plannedDays, workedDays);
                
                const totalSalary = adjustedBaseRate + bonusAmount + invalidBonus + 
                    teamLeaderBonus + teamPlanBonus - penaltiesAmount;
                
                return {
                    baseRate,
                    bonusPerFTD,
                    bonusAmount,
                    invalidBonus,
                    totalSalary,
                    dailyRate: dailyRate.toFixed(2),
                    teamLeaderBonus,
                    teamPlanBonus,
                    adjustedBaseRate,
                    adjustmentAmount,
                    underRatio,
                    overDays,
                    penaltiesAmount
                };
            },
            
            _calculateBaseRate(validDeposits, tariffs, manager, managerBaseRates) {
                if (!tariffs || tariffs.length === 0) {
                    const defaultRate = managerBaseRates?.[manager] || 800;
                    return {
                        baseRate: defaultRate,
                        bonusPerFTD: 0
                    };
                }
                
                let tariff = tariffs.find(t => validDeposits >= t.min && validDeposits <= t.max);
                
                if (!tariff) {
                    if (validDeposits === 0) {
                        tariff = tariffs[0];
                    } else {
                        tariff = tariffs[tariffs.length - 1];
                    }
                }
                
                if (!tariff) {
                    const defaultRate = managerBaseRates?.[manager] || 800;
                    return {
                        baseRate: defaultRate,
                        bonusPerFTD: 0
                    };
                }
                
                const minTariffRate = tariffs.length > 0 
                    ? Math.min(...tariffs.map(t => t.baseRate || 800))
                    : 800;
                const currentTariffRate = tariff?.baseRate || 800;
                
                const tariffDifference = currentTariffRate - minTariffRate;
                
                const overrideBaseRate = managerBaseRates?.[manager];
                let managerBaseRate;
                
                if (overrideBaseRate !== undefined) {
                    const parsedOverride = typeof overrideBaseRate === 'number' 
                        ? overrideBaseRate 
                        : parseFloat(overrideBaseRate);
                    if (!Number.isNaN(parsedOverride) && parsedOverride >= 0) {
                        managerBaseRate = parsedOverride;
                    } else {
                        managerBaseRate = minTariffRate;
                    }
                } else {
                    managerBaseRate = minTariffRate;
                }
                
                const finalBaseRate = managerBaseRate + tariffDifference;
                
                return {
                    baseRate: finalBaseRate,
                    bonusPerFTD: tariff?.bonusPerFTD || 0
                };
            },
            
            _calculateTeamLeaderBonus(manager, teamValidForBonus, teamLeaderPerFTD) {
                const isTeamLeader = ManagerUtils.isTeamLeader(manager);
                if (!isTeamLeader) return 0;
                
                return MathUtils.min(teamValidForBonus * teamLeaderPerFTD, 50000);
            },
            
            _calculateAdjustedRate(baseRate, plannedDays, workedDays) {
                if (plannedDays <= 0) {
                    return {
                        adjustedBaseRate: baseRate,
                        adjustmentAmount: 0,
                        dailyRate: 0,
                        overDays: 0,
                        underRatio: 1
                    };
                }
                
                const dailyRate = baseRate / plannedDays;
                const overDays = MathUtils.max(0, workedDays - plannedDays);
                
                let adjustedBaseRate;
                let adjustmentAmount;
                let underRatio;
                
                if (workedDays > plannedDays) {
                    adjustmentAmount = overDays * dailyRate;
                    adjustedBaseRate = baseRate + adjustmentAmount;
                    underRatio = 1;
                } else {
                    underRatio = workedDays / plannedDays;
                    adjustmentAmount = 0;
                    adjustedBaseRate = baseRate * underRatio;
                }
                
                return {
                    adjustedBaseRate,
                    adjustmentAmount,
                    dailyRate,
                    overDays,
                    underRatio
                };
            },
            calculateStats(records) {
                const total = records.length;
                const valid = records.filter(r => r.validity === 'valid').length;
                const invalid = records.filter(r => r.validity === 'invalid').length;
                const conversion = total > 0 ? parseFloat(((valid / total) * 100).toFixed(1)) : 0;
                return { total, valid, invalid, conversion };
            },
            getManagerStats(records, manager) {
                const managerRecords = records.filter(r => r.manager === manager);
                return this.calculateStats(managerRecords);
            },
            getProgressPercentage(goals, manager, validCount, monthKey, disabledAgents = {}) {
                const monthDisabled = disabledAgents[monthKey] || [];
                if (monthDisabled.includes(manager)) return 0;
                const goal = goals[manager] || 0;
                if (goal === 0) return 0;
                return MathUtils.round((validCount / goal) * 100);
            },
            getBonusForGoal(goals, manager, validCount, monthKey, disabledAgents = {}) {
                const monthDisabled = disabledAgents[monthKey] || [];
                if (monthDisabled.includes(manager)) return 0;
                const goal = goals[manager] || 0;
                if (goal === 0) return 0;
                return validCount >= goal ? 100 : 0;
            },
            getTeamPlanBonus(managers, initialManagers, goals, records, bonusAmount = 500, monthKey, disabledAgents = {}) {
                const salesCount = managers.filter(m => 
                    m !== TEAM_LEADER_NAME && !initialManagers.includes(m)
                ).length;
                
                if (salesCount < 2) return 0;
                
                const monthDisabled = disabledAgents[monthKey] || [];
                const activeManagers = managers.filter(m => 
                    !monthDisabled.includes(m) && (goals[m] || 0) > 0
                );
                const totalGoal = activeManagers.reduce((sum, manager) => sum + (goals[manager] || 0), 0);
                
                const monthRecords = records.filter(r => {
                    const recordMonth = DateUtils.getMonthKey(r.date);
                    return recordMonth === monthKey;
                });
                
                const totalValid = monthRecords.filter(r => 
                    r.validity === 'valid' && activeManagers.includes(r.manager)
                ).length;
                
                return totalValid >= totalGoal && totalGoal > 0 ? bonusAmount : 0;
            },
            getTeamProgress(records, goals, managers, monthKey, disabledAgents = {}) {
                const salesManagers = managers.filter(m => m !== TEAM_LEADER_NAME);
                const monthDisabled = disabledAgents[monthKey] || [];
                const activeManagers = salesManagers.filter(m => 
                    !monthDisabled.includes(m) && (goals[m] || 0) > 0
                );
                const totalGoal = activeManagers.reduce((sum, manager) => sum + (goals[manager] || 0), 0);
                
                const monthRecords = records.filter(r => {
                    const recordMonth = DateUtils.getMonthKey(r.date);
                    return recordMonth === monthKey;
                });
                
                const validDeposits = monthRecords.filter(r => 
                    r.validity === 'valid' && r.manager !== TEAM_LEADER_NAME && activeManagers.includes(r.manager)
                ).length;
                const progress = totalGoal > 0 ? MathUtils.round((validDeposits / totalGoal) * 100) : 0;
                return { totalGoal, validDeposits, progress };
            },
            calculateDelta(current, previous) {
                if (previous === 0) {
                    return current > 0 ? 100 : 0;
                }
                const delta = ((current - previous) / previous * 100);
                return isFinite(delta) ? parseFloat(delta.toFixed(1)) : 0;
            }
        };
        
        const TeamLeaderSalaryCalculator = {
            BASE_RATE: 1200,
            INVALID_DEPOSIT_BONUS: 10,
            VALID_DEPOSIT_BONUS: 30,
            TEAM_TARGET_BONUS: 500,
            SALE_BONUS_REWARD: 50,
            WEEKLY_TARGET_BONUS: 150,
            WEEKLY_TARGET_MAX: 450,
            
            calculateBaseSalary() {
                return this.BASE_RATE;
            },
            
            calculateDepositsBonus(records) {
                const invalidCount = records.filter(r => r.validity === 'invalid').length;
                const validCount = records.filter(r => r.validity === 'valid').length;
                
                const invalidBonus = invalidCount * this.INVALID_DEPOSIT_BONUS;
                const validBonus = validCount * this.VALID_DEPOSIT_BONUS;
                
                return {
                    invalidCount,
                    validCount,
                    invalidBonus,
                    validBonus,
                    total: invalidBonus + validBonus
                };
            },
            
            calculateTeamTargetBonus(managers, initialManagers, goals, records) {
                const salesManagers = managers.filter(m => 
                    m !== TEAM_LEADER_NAME && (goals[m] || 0) > 0
                );
                const totalGoal = salesManagers.reduce((sum, manager) => sum + (goals[manager] || 0), 0);
                const totalValid = records.filter(r => 
                    r.validity === 'valid' && r.manager !== TEAM_LEADER_NAME && salesManagers.includes(r.manager)
                ).length;
                
                const isTargetCompleted = totalValid >= totalGoal && totalGoal > 0;
                
                return {
                    totalGoal,
                    totalValid,
                    isTargetCompleted,
                    bonus: isTargetCompleted ? this.TEAM_TARGET_BONUS : 0
                };
            },
            
            calculateSaleBonusesReward(bonuses, managers) {
                const salesManagers = managers.filter(m => m !== TEAM_LEADER_NAME);
                const saleBonuses = bonuses.filter(b => salesManagers.includes(b.manager));
                const bonusCount = saleBonuses.length;
                const totalReward = bonusCount * this.SALE_BONUS_REWARD;
                
                return {
                    bonusCount,
                    totalReward
                };
            },
            
            getPeriodForDate(dateStr) {
                const date = new Date(dateStr);
                const day = date.getDate();
                
                if (day >= 1 && day <= 10) return 1;
                if (day >= 11 && day <= 20) return 2;
                return 3;
            },
            
            calculateWeeklyTargetBonus(records, goals, managers, selectedMonth) {
                const salesManagers = managers.filter(m => m !== TEAM_LEADER_NAME);
                const totalTarget = salesManagers.reduce((sum, manager) => sum + (goals[manager] || 0), 0);
                const targetPerPeriod = Math.round(totalTarget / 3) + 1;
                
                if (targetPerPeriod === 0) {
                    return {
                        totalTarget: 0,
                        targetPerPeriod: 0,
                        periods: [],
                        totalBonus: 0
                    };
                }
                
                const [year, month] = selectedMonth.split('-').map(Number);
                const monthRecords = records.filter(r => {
                    const recordDate = new Date(r.date);
                    return recordDate.getFullYear() === year && (recordDate.getMonth() + 1) === month;
                });
                
                const periods = [1, 2, 3].map(period => {
                    const periodRecords = monthRecords.filter(r => {
                        const periodForRecord = this.getPeriodForDate(r.date);
                        return periodForRecord === period && r.validity === 'valid';
                    });
                    const validCount = periodRecords.length;
                    const isCompleted = validCount >= targetPerPeriod;
                    
                    return {
                        period,
                        target: targetPerPeriod,
                        validCount,
                        isCompleted,
                        bonus: isCompleted ? this.WEEKLY_TARGET_BONUS : 0
                    };
                });
                
                const totalBonus = Math.min(
                    periods.reduce((sum, p) => sum + p.bonus, 0),
                    this.WEEKLY_TARGET_MAX
                );
                
                return {
                    totalTarget,
                    targetPerPeriod,
                    periods,
                    totalBonus
                };
            },
            
            calculateSalary(config) {
                const {
                    records,
                    bonuses,
                    managers,
                    initialManagers,
                    goals,
                    selectedMonth
                } = config;
                
                const baseSalary = this.calculateBaseSalary();
                const depositsBonus = this.calculateDepositsBonus(records);
                const teamTargetBonus = this.calculateTeamTargetBonus(managers, initialManagers, goals, records);
                const saleBonusesReward = this.calculateSaleBonusesReward(bonuses, managers);
                const weeklyTargetBonus = this.calculateWeeklyTargetBonus(records, goals, managers, selectedMonth);
                
                const totalSalary = baseSalary + 
                    depositsBonus.total + 
                    teamTargetBonus.bonus + 
                    saleBonusesReward.totalReward + 
                    weeklyTargetBonus.totalBonus;
                
                return {
                    baseSalary,
                    depositsBonus,
                    teamTargetBonus,
                    saleBonusesReward,
                    weeklyTargetBonus,
                    totalSalary
                };
            }
        };
        const StatCard = ({ title, value, icon }) => (
            <div className="stat-card">
                <h4>{title}</h4>
                <div className="stat-value">{icon} {value}</div>
            </div>
        );
        const Badge = ({ children, variant }) => (
            <span className={`badge badge-${variant}`}>
                {children}
            </span>
        );
        const Modal = ({ isOpen, onClose, onConfirm, message }) => {
            if (!isOpen) return null;
            return (
                <div className="modal">
                    <div className="modal-content">
                        <p>{message}</p>
                        <div className="modal-buttons">
                            <button className="btn btn-secondary" onClick={onClose}>Отмена</button>
                            <button className="btn btn-danger" onClick={onConfirm}>Удалить</button>
                        </div>
                    </div>
                </div>
            );
        };
        const BreakdownItem = ({ value, label }) => (
            <div className="breakdown-item">
                <span className="breakdown-value">{value}</span>
                <div className="breakdown-label">{label}</div>
            </div>
        );
        
        const SalaryBreakdown = ({ salaryData }) => {
            const { 
                salary, stats, bonus, managerBonuses, teamPlanBonus, 
                isTeamLeader, teamLeaderPerFTD, teamValidForBonus, 
                invalidBonusPerFTD, plannedD, workedDays 
            } = salaryData;
            
            const [isExpanded, setIsExpanded] = useState(false);
            const adjustmentDisplay = salary.overDays > 0 
                ? FormatUtils.formatCurrency(salary.adjustmentAmount, { showSign: true })
                : FormatUtils.formatRatio(salary.underRatio);
            const adjustmentLabel = salary.overDays > 0 ? 'За переработку' : 'Коэффициент';
            const totalWithBonus = salary.totalSalary + bonus + managerBonuses;
            
            const baseRateItems = [
                { value: FormatUtils.formatCurrency(salary.baseRate), label: 'Базовая' },
                { value: adjustmentDisplay, label: adjustmentLabel },
                { value: FormatUtils.formatCurrency(salary.adjustedBaseRate), label: 'Итоговая ставка' }
            ];
            
            const bonusItems = [
                { value: FormatUtils.formatCurrency(salary.bonusAmount), label: `За валидные FTD (${FormatUtils.formatCurrency(salary.bonusPerFTD)} × ${stats.valid})` },
                { value: FormatUtils.formatCurrency(salary.invalidBonus), label: `За невалидные FTD (${FormatUtils.formatCurrency(invalidBonusPerFTD)} × ${stats.invalid})` },
                ...(isTeamLeader ? [{ value: FormatUtils.formatCurrency(salary.teamLeaderBonus), label: `Тим-лидер бонус (${FormatUtils.formatCurrency(teamLeaderPerFTD)}/valid × ${teamValidForBonus})` }] : []),
                { value: FormatUtils.formatCurrency(bonus > 0 ? 100 : 0), label: 'Бонус за план' },
                ...(teamPlanBonus > 0 ? [{ value: FormatUtils.formatCurrency(teamPlanBonus, { showSign: true }), label: 'Бонус за общий план команды' }] : []),
                ...(managerBonuses > 0 ? [{ value: FormatUtils.formatCurrency(managerBonuses, { showSign: true }), label: 'Дополнительные бонусы' }] : [])
            ];
            
            const deductionItems = [
                ...(salary.penaltiesAmount > 0 ? [{ value: FormatUtils.formatCurrency(-salary.penaltiesAmount), label: 'Штрафы' }] : [])
            ];

            return (
                <div className="salary-calc">
                    <div style={{...CommonStyles.flexBetween, marginBottom: '1rem'}}>
                        <h4 style={{margin: 0}}>💰 Расчет зарплаты</h4>
                        <button 
                            onClick={() => setIsExpanded(!isExpanded)}
                            style={{
                                background: 'rgba(255, 255, 255, 0.2)',
                                border: 'none',
                                color: 'white',
                                padding: '0.5rem 1rem',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                fontSize: '0.85rem',
                                fontWeight: '600'
                            }}
                        >
                            {isExpanded ? '▼ Свернуть' : '▶ Развернуть'}
                        </button>
                    </div>
                    
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                        gap: '1rem',
                        marginBottom: isExpanded ? '1rem' : 0
                    }}>
                        <div style={CommonStyles.statCardBackground}>
                            <div style={CommonStyles.statCardLabel}>Итого</div>
                            <div style={CommonStyles.statCardValue}>{FormatUtils.formatCurrency(totalWithBonus)}</div>
                        </div>
                        <div style={CommonStyles.statCardBackground}>
                            <div style={CommonStyles.statCardLabel}>В день</div>
                            <div style={CommonStyles.statCardValueSmall}>{FormatUtils.formatCurrency(salary.dailyRate)}</div>
                        </div>
                        <div style={CommonStyles.statCardBackground}>
                            <div style={CommonStyles.statCardLabel}>Посещаемость</div>
                            <div style={CommonStyles.statCardValueSmall}>{FormatUtils.formatDays(workedDays)}/{plannedD} дней</div>
                        </div>
                    </div>
                    
                    {isExpanded && (
                        <div className="salary-breakdown" style={{marginTop: '1rem'}}>
                            <div style={{marginBottom: '1rem'}}>
                                <div style={{fontSize: '0.9rem', fontWeight: '600', marginBottom: '0.5rem', opacity: 0.9}}>📊 Базовая ставка</div>
                                {baseRateItems.map((item, idx) => (
                                    <BreakdownItem key={idx} value={item.value} label={item.label} />
                                ))}
                            </div>
                            
                            {bonusItems.length > 0 && (
                                <div style={{marginBottom: '1rem'}}>
                                    <div style={{fontSize: '0.9rem', fontWeight: '600', marginBottom: '0.5rem', opacity: 0.9}}>🎁 Бонусы</div>
                                    {bonusItems.map((item, idx) => (
                                        <BreakdownItem key={idx} value={item.value} label={item.label} />
                                    ))}
                                </div>
                            )}
                            
                            {deductionItems.length > 0 && (
                                <div style={{marginBottom: '1rem'}}>
                                    <div style={{fontSize: '0.9rem', fontWeight: '600', marginBottom: '0.5rem', opacity: 0.9}}>⚠️ Штрафы</div>
                                    {deductionItems.map((item, idx) => (
                                        <BreakdownItem key={idx} value={item.value} label={item.label} />
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    
                    <p style={{...CommonStyles.attendanceInfo, marginTop: '1rem', marginBottom: 0}}>
                        Тариф: {FormatUtils.formatCurrency(salary.bonusPerFTD)} за валидный FTD, {FormatUtils.formatCurrency(invalidBonusPerFTD)} за невалидный
                    </p>
                </div>
            );
        };
        
        const TeamLeaderSalaryBreakdown = ({ salaryData, workedDays, plannedD, selectedMonth, records, monthlyGoals, bonuses, managers, initialManagers, plannedDays, getWorkedDays }) => {
            const [expandedSections, setExpandedSections] = useState({});
            const [showComparison, setShowComparison] = useState(true);
            const baseRate = TeamLeaderSalaryCalculator.BASE_RATE;
            const coefficient = plannedD > 0 ? (workedDays / plannedD) : 1;
            const finalRate = baseRate * coefficient;
            const totalBonuses = salaryData.depositsBonus.total + 
                salaryData.teamTargetBonus.bonus + 
                salaryData.saleBonusesReward.totalReward + 
                salaryData.weeklyTargetBonus.totalBonus;
            const totalSalary = finalRate + totalBonuses;
            const dailyRate = workedDays > 0 ? totalSalary / workedDays : 0;
            const attendancePercent = plannedD > 0 ? Math.round((workedDays / plannedD) * 100) : 0;
            const previousMonthData = useMemo(() => {
                if (!selectedMonth) return null;
                try {
                    const [year, month] = selectedMonth.split('-').map(Number);
                    let prevYear = year;
                    let prevMonth = month - 1;
                    if (prevMonth === 0) {
                        prevMonth = 12;
                        prevYear = year - 1;
                    }
                    const prevMonthKey = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
                    const prevRecords = DateUtils.filterByMonth(records, prevMonthKey);
                    const prevGoals = monthlyGoals[prevMonthKey] || {};
                    const prevSalaryData = TeamLeaderSalaryCalculator.calculateSalary({
                        records: prevRecords,
                        bonuses: bonuses.filter(b => {
                            const bonusDate = new Date(b.date);
                            return bonusDate.getFullYear() === prevYear && (bonusDate.getMonth() + 1) === prevMonth;
                        }),
                        managers,
                        initialManagers,
                        goals: prevGoals,
                        selectedMonth: prevMonthKey
                    });
                    const prevPlannedDays = plannedDays[prevMonthKey] || 22;
                    const prevWorkedDays = getWorkedDays(prevMonthKey, TEAM_LEADER_NAME);
                    const prevCoefficient = prevPlannedDays > 0 ? (prevWorkedDays / prevPlannedDays) : 1;
                    const prevFinalRate = baseRate * prevCoefficient;
                    const prevTotalBonuses = prevSalaryData.depositsBonus.total + 
                        prevSalaryData.teamTargetBonus.bonus + 
                        prevSalaryData.saleBonusesReward.totalReward + 
                        prevSalaryData.weeklyTargetBonus.totalBonus;
                    const prevTotalSalary = prevFinalRate + prevTotalBonuses;
                    return {
                        monthKey: prevMonthKey,
                        totalSalary: prevTotalSalary,
                        baseRate: prevFinalRate,
                        bonuses: prevTotalBonuses
                    };
                } catch (error) {
                    return null;
                }
            }, [selectedMonth, records, monthlyGoals, bonuses, managers, initialManagers, plannedDays, getWorkedDays, baseRate]);
            
            const salaryChange = previousMonthData 
                ? ((totalSalary - previousMonthData.totalSalary) / previousMonthData.totalSalary * 100)
                : null;
            
            const salaryDistribution = [
                { label: 'Базовая ставка', value: finalRate, color: '#8b5cf6', percentage: (finalRate / totalSalary * 100).toFixed(1) },
                { label: 'Бонусы за депозиты', value: salaryData.depositsBonus.total, color: '#10b981', percentage: (salaryData.depositsBonus.total / totalSalary * 100).toFixed(1) },
                { label: 'Бонус за план', value: salaryData.teamTargetBonus.bonus, color: '#f59e0b', percentage: (salaryData.teamTargetBonus.bonus / totalSalary * 100).toFixed(1) },
                { label: 'Долив сейлам', value: salaryData.saleBonusesReward.totalReward, color: '#ec4899', percentage: (salaryData.saleBonusesReward.totalReward / totalSalary * 100).toFixed(1) },
                { label: 'Недельный таргет', value: salaryData.weeklyTargetBonus.totalBonus, color: '#3b82f6', percentage: (salaryData.weeklyTargetBonus.totalBonus / totalSalary * 100).toFixed(1) }
            ].filter(item => item.value > 0);
            
            const metrics = {
                averageLast3Months: null, 
                recordSalary: totalSalary, 
                totalDeposits: salaryData.depositsBonus.validCount + salaryData.depositsBonus.invalidCount,
                validDeposits: salaryData.depositsBonus.validCount,
                invalidDeposits: salaryData.depositsBonus.invalidCount
            };
            
            const toggleSection = (section) => {
                setExpandedSections(prev => ({
                    ...prev,
                    [section]: !prev[section]
                }));
            };
            
            const baseRateItems = [
                { value: FormatUtils.formatCurrency(baseRate), label: 'Базовая', icon: '💼' },
                { value: `x${coefficient.toFixed(2)}`, label: 'Коэффициент', icon: '📊' },
                { value: FormatUtils.formatCurrency(finalRate), label: 'Итоговая ставка', icon: '✅' }
            ];
            
            const bonusItems = [
                { 
                    value: FormatUtils.formatCurrency(salaryData.depositsBonus.validBonus), 
                    label: `Валидные FTD`,
                    sublabel: `$${TeamLeaderSalaryCalculator.VALID_DEPOSIT_BONUS} × ${salaryData.depositsBonus.validCount}`,
                    icon: '✅',
                    color: '#10b981'
                },
                { 
                    value: FormatUtils.formatCurrency(salaryData.depositsBonus.invalidBonus), 
                    label: `Невалидные FTD`,
                    sublabel: `$${TeamLeaderSalaryCalculator.INVALID_DEPOSIT_BONUS} × ${salaryData.depositsBonus.invalidCount}`,
                    icon: '⚠️',
                    color: '#f59e0b'
                },
                { 
                    value: FormatUtils.formatCurrency(salaryData.teamTargetBonus.bonus), 
                    label: 'Бонус за план',
                    sublabel: salaryData.teamTargetBonus.isTargetCompleted ? 'План выполнен' : 'План не выполнен',
                    icon: '🎯',
                    color: salaryData.teamTargetBonus.isTargetCompleted ? '#10b981' : '#ef4444'
                },
                { 
                    value: FormatUtils.formatCurrency(salaryData.saleBonusesReward.totalReward), 
                    label: 'Долив сейлам',
                    sublabel: salaryData.saleBonusesReward.bonusCount > 0 
                        ? `$${TeamLeaderSalaryCalculator.SALE_BONUS_REWARD} × ${salaryData.saleBonusesReward.bonusCount}`
                        : 'Нет бонусов сейлам',
                    icon: '💎',
                    color: '#ec4899'
                },
                ...(salaryData.weeklyTargetBonus.totalBonus > 0 ? [{ 
                    value: FormatUtils.formatCurrency(salaryData.weeklyTargetBonus.totalBonus), 
                    label: 'Недельный таргет',
                    sublabel: `${salaryData.weeklyTargetBonus.periods.filter(p => p.isCompleted).length}/3 периодов`,
                    icon: '📅',
                    color: '#3b82f6'
                }] : [])
            ];
            
            const CircularChart = ({ data, size = 120 }) => {
                const radius = size / 2 - 10;
                const circumference = 2 * Math.PI * radius;
                let accumulatedOffset = 0;
                
                return (
                    <div style={{ position: 'relative', width: size, height: size }}>
                        <svg width={size} height={size} style={{ transform: 'rotate(-90deg)' }}>
                            {data.map((item, idx) => {
                                const percentage = parseFloat(item.percentage);
                                const segmentLength = (percentage / 100) * circumference;
                                const strokeDasharray = `${segmentLength} ${circumference}`;
                                const strokeDashoffset = -accumulatedOffset;
                                accumulatedOffset += segmentLength;
                                return (
                                    <circle
                                        key={idx}
                                        cx={size / 2}
                                        cy={size / 2}
                                        r={radius}
                                        fill="none"
                                        stroke={item.color}
                                        strokeWidth="20"
                                        strokeDasharray={strokeDasharray}
                                        strokeDashoffset={strokeDashoffset}
                                        style={{ 
                                            transition: 'all 0.5s ease',
                                            strokeLinecap: 'round'
                                        }}
                                    />
                                );
                            })}
                        </svg>
                        <div style={{
                            position: 'absolute',
                            top: '50%',
                            left: '50%',
                            transform: 'translate(-50%, -50%)',
                            textAlign: 'center'
                        }}>
                            <div style={{ fontSize: '1.5rem', fontWeight: '700', color: 'var(--text)' }}>
                                {FormatUtils.formatCurrency(totalSalary)}
                            </div>
                            <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>Итого</div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="team-leader-salary-modern" style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                    <div className="tl-salary-hero-card" style={{
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%)',
                        backgroundSize: '200% 200%',
                        animation: 'gradientShift 8s ease infinite',
                        borderRadius: '24px',
                        padding: '2.5rem',
                        position: 'relative',
                        overflow: 'hidden',
                        boxShadow: '0 20px 60px rgba(102, 126, 234, 0.4)',
                        border: '2px solid rgba(255, 255, 255, 0.2)'
                    }}>
                        <div style={{
                            position: 'absolute',
                            top: '-50%',
                            right: '-50%',
                            width: '200%',
                            height: '200%',
                            background: 'radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%)',
                            animation: 'rotate 20s linear infinite'
                        }}></div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', position: 'relative', zIndex: 1 }}>
                            <div style={{ flex: 1 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1rem' }}>
                                    <div style={{ fontSize: '3rem', filter: 'drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2))' }}>👑</div>
                                    <div>
                                        <div style={{ fontSize: '1rem', color: 'rgba(255, 255, 255, 0.9)', marginBottom: '0.25rem', fontWeight: '500' }}>
                                            Итоговая зарплата за месяц
                                        </div>
                                        <div style={{ fontSize: '3.5rem', fontWeight: '800', color: 'white', lineHeight: '1', textShadow: '0 4px 12px rgba(0, 0, 0, 0.3)' }}>
                                            {FormatUtils.formatCurrency(totalSalary)}
                                        </div>
                                    </div>
                                </div>
                                {previousMonthData && salaryChange !== null && (
                                    <div style={{
                                        display: 'inline-flex',
                                        alignItems: 'center',
                                        gap: '0.5rem',
                                        padding: '0.5rem 1rem',
                                        background: 'rgba(255, 255, 255, 0.2)',
                                        borderRadius: '12px',
                                        backdropFilter: 'blur(10px)',
                                        marginTop: '1rem'
                                    }}>
                                        <span style={{ fontSize: '1.2rem' }}>{salaryChange >= 0 ? '📈' : '📉'}</span>
                                        <span style={{ color: 'white', fontWeight: '600' }}>
                                            {salaryChange >= 0 ? '+' : ''}{salaryChange.toFixed(1)}% к прошлому месяцу
                                        </span>
                                    </div>
                                )}
                            </div>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem', minWidth: '200px' }}>
                                <div style={{
                                    padding: '1rem',
                                    background: 'rgba(255, 255, 255, 0.15)',
                                    borderRadius: '16px',
                                    backdropFilter: 'blur(10px)',
                                    border: '1px solid rgba(255, 255, 255, 0.2)'
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.5rem' }}>
                                        <span style={{ fontSize: '1.5rem' }}>💰</span>
                                        <div>
                                            <div style={{ fontSize: '0.75rem', color: 'rgba(255, 255, 255, 0.8)', marginBottom: '0.25rem' }}>В день</div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: '700', color: 'white' }}>
                                                {FormatUtils.formatCurrency(dailyRate)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style={{
                                    padding: '1rem',
                                    background: 'rgba(255, 255, 255, 0.15)',
                                    borderRadius: '16px',
                                    backdropFilter: 'blur(10px)',
                                    border: '1px solid rgba(255, 255, 255, 0.2)'
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.5rem' }}>
                                        <span style={{ fontSize: '1.5rem' }}>📅</span>
                                        <div>
                                            <div style={{ fontSize: '0.75rem', color: 'rgba(255, 255, 255, 0.8)', marginBottom: '0.25rem' }}>Посещаемость</div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: '700', color: 'white' }}>
                                                {FormatUtils.formatDays(workedDays)}/{plannedD}
                                            </div>
                                            <div style={{ fontSize: '0.75rem', color: 'rgba(255, 255, 255, 0.8)', marginTop: '0.25rem' }}>
                                                {attendancePercent}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {previousMonthData && (
                        <div style={{
                            padding: '1.5rem',
                            background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1))',
                            borderRadius: '16px',
                            border: '1px solid rgba(59, 130, 246, 0.2)'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                <h4 style={{ margin: 0, fontSize: '1.1rem', fontWeight: '700' }}>📊 Сравнение с предыдущим месяцем</h4>
                                <button
                                    onClick={() => setShowComparison(!showComparison)}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        background: 'rgba(59, 130, 246, 0.2)',
                                        border: '1px solid rgba(59, 130, 246, 0.3)',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        fontSize: '0.875rem',
                                        fontWeight: '600'
                                    }}
                                >
                                    {showComparison ? 'Скрыть' : 'Показать'}
                                </button>
                            </div>
                            {showComparison && (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                                    <div style={{ padding: '1rem', background: 'white', borderRadius: '12px' }}>
                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginBottom: '0.5rem' }}>Текущий месяц</div>
                                        <div style={{ fontSize: '1.5rem', fontWeight: '700' }}>{FormatUtils.formatCurrency(totalSalary)}</div>
                                    </div>
                                    <div style={{ padding: '1rem', background: 'white', borderRadius: '12px' }}>
                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginBottom: '0.5rem' }}>Предыдущий месяц</div>
                                        <div style={{ fontSize: '1.5rem', fontWeight: '700' }}>{FormatUtils.formatCurrency(previousMonthData.totalSalary)}</div>
                                    </div>
                                    <div style={{ padding: '1rem', background: salaryChange >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)', borderRadius: '12px', border: `2px solid ${salaryChange >= 0 ? '#10b981' : '#ef4444'}` }}>
                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginBottom: '0.5rem' }}>Изменение</div>
                                        <div style={{ fontSize: '1.5rem', fontWeight: '700', color: salaryChange >= 0 ? '#10b981' : '#ef4444' }}>
                                            {salaryChange >= 0 ? '+' : ''}{salaryChange.toFixed(1)}%
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
                        gap: '1.5rem'
                    }}>
                        <div style={{
                            padding: '1.5rem',
                            background: 'white',
                            borderRadius: '16px',
                            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)',
                            border: '1px solid var(--border)'
                        }}>
                            <h4 style={{ margin: '0 0 1rem 0', fontSize: '1.1rem', fontWeight: '700' }}>📊 Распределение зарплаты</h4>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1.5rem' }}>
                                <CircularChart data={salaryDistribution} size={140} />
                                <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                    {salaryDistribution.map((item, idx) => (
                                        <div key={idx} style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                            <div style={{
                                                width: '12px',
                                                height: '12px',
                                                borderRadius: '50%',
                                                background: item.color
                                            }}></div>
                                            <div style={{ flex: 1, fontSize: '0.875rem' }}>
                                                <div style={{ fontWeight: '600' }}>{item.label}</div>
                                                <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                                                    {item.percentage}% • {FormatUtils.formatCurrency(item.value)}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Дополнительные метрики */}
                        <div style={{
                            padding: '1.5rem',
                            background: 'white',
                            borderRadius: '16px',
                            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)',
                            border: '1px solid var(--border)'
                        }}>
                            <h4 style={{ margin: '0 0 1rem 0', fontSize: '1.1rem', fontWeight: '700' }}>📈 Дополнительные метрики</h4>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                <div style={{
                                    padding: '1rem',
                                    background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05))',
                                    borderRadius: '12px',
                                    border: '1px solid rgba(16, 185, 129, 0.2)'
                                }}>
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginBottom: '0.25rem' }}>Всего депозитов</div>
                                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#10b981' }}>{metrics.totalDeposits}</div>
                                </div>
                                <div style={{
                                    padding: '1rem',
                                    background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05))',
                                    borderRadius: '12px',
                                    border: '1px solid rgba(59, 130, 246, 0.2)'
                                }}>
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginBottom: '0.25rem' }}>Валидные депозиты</div>
                                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#3b82f6' }}>{metrics.validDeposits}</div>
                                </div>
                                <div style={{
                                    padding: '1rem',
                                    background: 'linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05))',
                                    borderRadius: '12px',
                                    border: '1px solid rgba(245, 158, 11, 0.2)'
                                }}>
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginBottom: '0.25rem' }}>Невалидные депозиты</div>
                                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#f59e0b' }}>{metrics.invalidDeposits}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Карточки с бонусами - УЛУЧШЕННЫЕ */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                        gap: '1rem'
                    }}>
                        <div style={{
                            padding: '1.5rem',
                            background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.05))',
                            borderRadius: '16px',
                            border: '2px solid rgba(139, 92, 246, 0.3)',
                            boxShadow: '0 4px 12px rgba(139, 92, 246, 0.2)',
                            transition: 'all 0.3s ease',
                            cursor: 'pointer'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-4px)';
                            e.currentTarget.style.boxShadow = '0 8px 24px rgba(139, 92, 246, 0.3)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.2)';
                        }}
                        onClick={() => toggleSection('baseRate')}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1rem' }}>
                                <div style={{ fontSize: '2rem' }}>💼</div>
                                <div style={{ flex: 1 }}>
                                    <div style={{ fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.25rem' }}>Базовая ставка</div>
                                    <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#8b5cf6' }}>
                                        {FormatUtils.formatCurrency(finalRate)}
                                    </div>
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>
                                        {FormatUtils.formatCurrency(baseRate)} × {coefficient.toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {bonusItems.map((item, idx) => (
                            <div key={idx} style={{
                                padding: '1.5rem',
                                background: 'white',
                                borderRadius: '16px',
                                border: `2px solid ${item.color}40`,
                                borderLeft: `4px solid ${item.color}`,
                                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)',
                                transition: 'all 0.3s ease',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-4px)';
                                e.currentTarget.style.boxShadow = `0 8px 24px ${item.color}30`;
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                            }}
                            onClick={() => toggleSection(`bonus-${idx}`)}
                            >
                                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1rem' }}>
                                    <div style={{ fontSize: '2rem' }}>{item.icon}</div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.25rem' }}>{item.label}</div>
                                        <div style={{ fontSize: '1.75rem', fontWeight: '700', color: item.color }}>
                                            {item.value}
                                        </div>
                                        {item.sublabel && (
                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>
                                                {item.sublabel}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Детальная разбивка с аккордеоном */}
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        border: '1px solid var(--border)',
                        overflow: 'hidden'
                    }}>
                        <div style={{
                            padding: '1rem 1.5rem',
                            background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05))',
                            borderBottom: '1px solid var(--border)',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.75rem',
                            fontWeight: '600'
                        }}
                        onClick={() => toggleSection('details')}
                        >
                            <span style={{ fontSize: '1.2rem' }}>{expandedSections.details ? '▼' : '▶'}</span>
                            <span>Детальная разбивка зарплаты</span>
                        </div>
                        
                        {expandedSections.details && (
                            <div style={{ padding: '1.5rem', animation: 'fadeIn 0.3s ease' }}>
                                <div style={{ marginBottom: '1.5rem' }}>
                                    <div style={{ fontSize: '1rem', fontWeight: '700', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                        <span>🏠</span> Базовая ставка
                                    </div>
                                    {baseRateItems.map((item, idx) => (
                                        <div key={idx} style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: '0.75rem',
                                            background: idx % 2 === 0 ? 'var(--background)' : 'transparent',
                                            borderRadius: '8px',
                                            marginBottom: '0.5rem'
                                        }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                                <span style={{ fontSize: '1.2rem' }}>{item.icon}</span>
                                                <span style={{ fontWeight: '500' }}>{item.label}</span>
                                            </div>
                                            <span style={{ fontWeight: '700' }}>{item.value}</span>
                                        </div>
                                    ))}
                                </div>
                                
                                {bonusItems.length > 0 && (
                                    <div>
                                        <div style={{ fontSize: '1rem', fontWeight: '700', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <span>🎁</span> Бонусы
                                        </div>
                                        {bonusItems.map((item, idx) => (
                                            <div key={idx} style={{
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                padding: '0.75rem',
                                                background: idx % 2 === 0 ? 'var(--background)' : 'transparent',
                                                borderRadius: '8px',
                                                marginBottom: '0.5rem'
                                            }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', flex: 1 }}>
                                                    <span style={{ fontSize: '1.2rem' }}>{item.icon}</span>
                                                    <div>
                                                        <div style={{ fontWeight: '500' }}>{item.label}</div>
                                                        {item.sublabel && (
                                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>{item.sublabel}</div>
                                                        )}
                                                    </div>
                                                </div>
                                                <span style={{ fontWeight: '700', color: item.color }}>{item.value}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                <div style={{
                                    marginTop: '1.5rem',
                                    padding: '1rem',
                                    background: 'rgba(102, 126, 234, 0.05)',
                                    borderRadius: '12px',
                                    fontSize: '0.875rem',
                                    color: 'var(--text-muted)'
                                }}>
                                    💡 Тариф: ${TeamLeaderSalaryCalculator.VALID_DEPOSIT_BONUS} за валидный FTD, ${TeamLeaderSalaryCalculator.INVALID_DEPOSIT_BONUS} за невалидный
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        const ManagerHeader = ({ manager, initialManagers }) => {
            const isTeamLeader = ManagerUtils.isTeamLeader(manager);
            const isNewManager = ManagerUtils.isNewManager(manager, initialManagers);
            
            return (
                <div className="animate-fade-in" style={{...CommonStyles.managerHeader, display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                    <h4 style={{margin: 0}}>{manager}</h4>
                    <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                        {isTeamLeader && <span className="team-leader-badge animate-pulse">Тим-Лидер</span>}
                        {isNewManager && <span className="sale-badge animate-bounce">Сейл</span>}
                    </div>
                </div>
            );
        };
        
        const ManagerStats = ({ stats }) => (
            <div style={CommonStyles.statsGrid}>
                <div><strong>Всего:</strong> {stats.total}</div>
                <div><strong>Валидные:</strong> {stats.valid}</div>
                <div><strong>Невалидные:</strong> {stats.invalid}</div>
                <div><strong>Конверсия:</strong> {stats.conversion}%</div>
            </div>
        );
        
        const ProgressSection = ({ goal, progress, stats }) => {
            const progressClass = ProgressUtils.getProgressClass(progress);
            const displayWidth = MathUtils.clampProgress(progress);
            const displayProgress = MathUtils.max(0, progress); 
            
            return (
                <div style={CommonStyles.sectionMargin}>
                    <div style={CommonStyles.flexBetween}>
                        <span>План: {goal} FTD</span>
                        <span style={CommonStyles.progressLabel}>
                            {stats.valid}/{goal} ({displayProgress}%)
                        </span>
                    </div>
                    <div className="progress-container">
                        <div 
                            className={`progress-bar progress-bar-animated ${progressClass} ${progress >= 100 ? 'animate-glow' : ''}`} 
                            style={{width: `${displayWidth}%`, '--progress-width': `${displayWidth}%`}}
                        >
                            <span className="stat-number">{displayProgress}%</span>
                        </div>
                    </div>
                </div>
            );
        };
        
        const AttendanceSection = ({ workedDays, plannedD }) => {
            const { bar } = BarUtils.createAttendanceBar(workedDays, plannedD, plannedD);
            const hasOvertime = workedDays > plannedD;
            const hasUnderwork = workedDays < plannedD;
            
            return (
                <>
                    <div className="bar-container" style={CommonStyles.sectionMargin}>
                        {bar} {FormatUtils.formatDays(workedDays)}/{plannedD} дня
                    </div>
                    {hasOvertime && (
                        <div style={CommonStyles.secondaryText}>
                            <span className="green-emoji">🟢</span> Переработка: +{FormatUtils.formatDays(workedDays - plannedD)} дня
                        </div>
                    )}
                    {hasUnderwork && (
                        <div style={CommonStyles.dangerText}>
                            ⚠️ Недоработка: -{FormatUtils.formatDays(plannedD - workedDays)} дня
                        </div>
                    )}
                </>
            );
        };
        
        const BonusCard = ({ bonus }) => {
            if (bonus <= 0) return null;
            
            return (
                <div style={CommonStyles.bonusCard}>
                    <div style={CommonStyles.shimmerOverlay}></div>
                    <span className="green-emoji">🎉</span> План выполнен! +$100 бонус
                </div>
            );
        };
        
        const MonthSelector = ({ label, value, onChange }) => (
            <div className="month-selector">
                <label>{label}</label>
                <select value={value} onChange={onChange}>
                    {DateUtils.generateMonthOptions().map(option => (
                        <option key={option.value} value={option.value}>{option.label}</option>
                    ))}
                </select>
            </div>
        );
        
        const DeltaDisplay = ({ delta, isConversion = false, showIfEmpty = false }) => {
            if (!showIfEmpty && (delta === undefined || delta === null)) return null;
            const sign = delta > 0 ? '+' : '';
            const symbol = isConversion ? 'pp' : '%';
            const value = delta === Infinity ? '∞' : sign + delta + symbol;
            const className = `delta ${delta > 0 ? 'positive' : delta < 0 ? 'negative' : ''}`;
            return <span className={className}>{value}</span>;
        };
        
        const ProgressBar = ({ progress, showLabel = true, animated = false, className = '' }) => {
            const progressClass = ProgressUtils.getProgressClass(progress);
            const displayWidth = MathUtils.clampProgress(progress);
            const displayProgress = MathUtils.max(0, progress);
            
            return (
                <div className="progress-container">
                    <div 
                        className={`progress-bar ${animated ? 'progress-bar-animated' : ''} ${progressClass} ${className}`}
                        style={{ width: `${displayWidth}%` }}
                    >
                        {showLabel && <span className="stat-number">{displayProgress}%</span>}
                    </div>
                </div>
            );
        };
        
        const ManagerBadges = ({ manager, initialManagers }) => {
            const isTeamLeader = ManagerUtils.isTeamLeader(manager);
            const isNewManager = ManagerUtils.isNewManager(manager, initialManagers);
            
            return (
                <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                    {isTeamLeader && <span className="team-leader-badge">Тим-Лидер</span>}
                    {isNewManager && <span className="sale-badge">Сейл</span>}
                </div>
            );
        };
        
        const ManagerProgress = ({ manager, validCount, goal, initialManagers, monthlyGoals, monthKey, disabledAgents = {} }) => {
            const progress = Calculator.getProgressPercentage(monthlyGoals, manager, validCount, monthKey, disabledAgents);
            const bonus = Calculator.getBonusForGoal(monthlyGoals, manager, validCount, monthKey, disabledAgents);
            const progressClass = ProgressUtils.getProgressClass(progress);
            
            return (
                <div style={CommonStyles.statCard}>
                    <div style={CommonStyles.flexBetween}>
                        <strong style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                            <span>{manager}</span>
                            <ManagerBadges manager={manager} initialManagers={initialManagers} />
                        </strong>
                        <span style={{fontWeight: '600', color: '#1e293b'}}>
                            {validCount}/{goal} FTD
                            {bonus > 0 && <span style={{color: '#10b981', marginLeft: '0.5rem'}}>+ $100 бонус</span>}
                        </span>
                    </div>
                    <ProgressBar progress={progress} />
                </div>
            );
        };
        const AttendanceTab = () => {
            const { attendance, plannedDays, managers, updateAttendance, getMonthKey, getWorkedDays } = useData();
            const { addNotification } = useNotification();
            const [selectedMonth, setSelectedMonth] = useSelectedMonth();
            const [selectedManager, setSelectedManager] = useState(managers[0] || '');
            useEffect(() => {
                if (managers.length > 0 && !selectedManager) {
                    setSelectedManager(managers[0]);
                }
            }, [managers, selectedManager]);
            const monthKey = selectedMonth;
            const planned = plannedDays[monthKey] || 22;
            const worked = getWorkedDays(monthKey, selectedManager);
            const unMarked = Math.max(0, Math.ceil(planned - worked)); 
            const isOverworkError = worked > planned + 3;
            const [year, mon] = selectedMonth.split('-').map(Number);
            const monthStart = new Date(year, mon - 1, 1);
            const firstDayOfWeek = monthStart.getDay() || 7;
            const daysInMonth = new Date(year, mon, 0).getDate();
            const calendarDays = [];
            let currentDate = new Date(year, mon - 1, 1 - firstDayOfWeek + 1);
            for (let i = 0; i < 42; i++) {
                calendarDays.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            const handleDayClick = (date, dayNum, currentValue) => {
                if (!selectedManager) return;
                if (dayNum < 1 || dayNum > daysInMonth) return;
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                let value = currentValue;
                if (value === true) value = 1;
                if (value === false) value = 0;
                
                let newValue;
                let message;
                if (!value || value === 0) {
                    newValue = 0.5;
                    message = `День ${dayNum} отмечен как полдня`;
                } else if (value === 0.5) {
                    newValue = 1;
                    message = `День ${dayNum} отмечен как полный день`;
                } else {
                    newValue = undefined; 
                    message = `День ${dayNum} снят`;
                }
                
                updateAttendance(monthKey, selectedManager, dateStr, newValue);
                addNotification(message, 'success');
            };
            const barLength = 22;
            const filled = MathUtils.round((worked / planned) * barLength);
            let bar = '▓'.repeat(Math.min(filled, barLength)) + '░'.repeat(barLength - Math.min(filled, barLength));
            if (worked > planned) {
                const extra = MathUtils.round(((worked - planned) / planned) * barLength);
                bar += '▓'.repeat(extra) + ` (+${FormatUtils.formatDays(worked - planned)})`;
            }
            
            return (
                <div>
                    <div style={{
                        display: 'flex', 
                        gap: '2rem', 
                        alignItems: 'flex-start', 
                        flexWrap: 'wrap', 
                        marginBottom: '1.5rem',
                        padding: '1.25rem',
                        background: 'var(--surface)',
                        borderRadius: '12px',
                        border: '1px solid var(--border)'
                    }}>
                        <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                            <label style={{
                                fontWeight: '600',
                                color: 'var(--text)',
                                fontSize: '0.9rem',
                                margin: 0
                            }}>Месяц:</label>
                            <select 
                                value={selectedMonth} 
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                style={{
                                    minWidth: '200px',
                                    padding: '0.75rem 1rem',
                                    background: 'white',
                                    border: '2px solid var(--border)',
                                    borderRadius: '8px',
                                    fontSize: '1rem',
                                    cursor: 'pointer',
                                    appearance: 'none',
                                    backgroundImage: 'url("data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 20 20\'%3e%3cpath stroke=\'%236b7280\' stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'m6 8 4 4 4-4\'/%3e%3c/svg%3e")',
                                    backgroundPosition: 'right 0.5rem center',
                                    backgroundRepeat: 'no-repeat',
                                    backgroundSize: '1.5em 1.5em',
                                    paddingRight: '2.5rem'
                                }}
                            >
                                {DateUtils.generateMonthOptions().map(option => (
                                    <option key={option.value} value={option.value}>{option.label}</option>
                                ))}
                            </select>
                        </div>
                        <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                            <label style={{
                                fontWeight: '600',
                                color: 'var(--text)',
                                fontSize: '0.9rem',
                                margin: 0
                            }}>Менеджер:</label>
                            <select 
                                value={selectedManager} 
                                onChange={(e) => setSelectedManager(e.target.value)}
                                style={{
                                    minWidth: '200px',
                                    padding: '0.75rem 1rem',
                                    background: 'white',
                                    border: '2px solid var(--border)',
                                    borderRadius: '8px',
                                    fontSize: '1rem',
                                    cursor: 'pointer',
                                    appearance: 'none',
                                    backgroundImage: 'url("data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 20 20\'%3e%3cpath stroke=\'%236b7280\' stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'m6 8 4 4 4-4\'/%3e%3c/svg%3e")',
                                    backgroundPosition: 'right 0.5rem center',
                                    backgroundRepeat: 'no-repeat',
                                    backgroundSize: '1.5em 1.5em',
                                    paddingRight: '2.5rem'
                                }}
                            >
                                {managers.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="bar-container">
                        {bar} {FormatUtils.formatDays(worked)}/{planned} дня
                    </div>
                    {worked > planned && <div style={CommonStyles.secondaryText}><span className="green-emoji">🟢</span> Переработка: +{FormatUtils.formatDays(worked - planned)} дня</div>}
                    {worked < planned && <div style={CommonStyles.dangerText}>⚠️ Недоработка: -{FormatUtils.formatDays(planned - worked)} дня</div>}
                    {unMarked > 0 && (
                        <div className="warning">
                            ⚠️ Внимание: В {DateUtils.formatMonthWithYear(selectedMonth)} осталось {unMarked} дня не отмечено. Проверьте календарь перед расчетом зарплаты.
                        </div>
                    )}
                    {isOverworkError && (
                        <div className="warning">
                            🚨 {selectedManager} отработал {FormatUtils.formatDays(worked)} дней из {planned} — проверьте, это может быть ошибка!
                        </div>
                    )}
                    <div className="attendance-calendar">
                        <table>
                            <thead>
                                <tr>
                                    <th>ПН</th><th>ВТ</th><th>СР</th><th>ЧТ</th><th>ПТ</th><th>СБ</th><th>ВС</th>
                                </tr>
                            </thead>
                            <tbody>
                                {Array.from({length: 6}, (_, week) => (
                                    <tr key={week}>
                                        {Array.from({length: 7}, (_, dayIdx) => {
                                            const date = calendarDays[week * 7 + dayIdx];
                                            const dayNum = date.getDate();
                                            const isCurrentMonth = date.getMonth() === mon - 1;
                                            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                            let dayValue = attendance[monthKey]?.[selectedManager]?.[dateStr];
                                            if (dayValue === true) dayValue = 1;
                                            if (dayValue === false || !dayValue) dayValue = 0;
                                            
                                            if (!isCurrentMonth) {
                                                return <td key={dayIdx}>&nbsp;</td>;
                                            }
                                            let className = 'attendance-day calendar-day';
                                            let mark = '';
                                            if (dayValue === 1) {
                                                className += ' green';
                                                mark = '🟢';
                                            } else if (dayValue === 0.5) {
                                                className += ' yellow';
                                                mark = '🟡';
                                            } else {
                                                className += ' gray';
                                                mark = '⚪';
                                            }
                                            return (
                                                <td key={dayIdx}>
                                                    <div 
                                                        className={className} 
                                                        onClick={async (event) => {
                                                            await handleDayClick(date, dayNum, dayValue);
                                                            const element = event.target.closest('.calendar-day');
                                                            element.classList.add('animate-bounce');
                                                            setTimeout(() => element.classList.remove('animate-bounce'), 600);
                                                        }}
                                                    >
                                                        <div className="icon-bounce" style={{fontSize: '1.2rem', marginBottom: '0.25rem'}}>{mark}</div>
                                                        <div className="stat-number">{dayNum}</div>
                                                    </div>
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        <div className="legend">
                            <div className="legend-item"><div style={{width: '20px', height: '20px', background: '#dcfce7', borderRadius: '4px', marginRight: '0.5rem'}}></div>🟢 Полный день</div>
                            <div className="legend-item"><div style={{width: '20px', height: '20px', background: '#fef3c7', borderRadius: '4px', marginRight: '0.5rem'}}></div>🟡 Полдня</div>
                            <div className="legend-item"><div style={{width: '20px', height: '20px', background: '#f1f5f9', borderRadius: '4px', marginRight: '0.5rem'}}></div>⚪ Не отмечен</div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const GeneralPlanTab = () => {
            const { records, penalties, bonuses, monthlyGoals, managers, initialManagers, initializeMonthGoals, addPenalty, deletePenalty, addBonus, deleteBonus, disabledAgents, tariffs, plannedDays, managerBaseRates, invalidBonusPerFTD, teamLeaderPerFTD, getWorkedDays } = useData();
            const { addNotification } = useNotification();
            const [selectedMonth, setSelectedMonth] = useSelectedMonth();
            const [penaltyForm, setPenaltyForm] = useState({
                date: '',
                manager: '',
                comment: '',
                amount: ''
            });
            const [bonusForm, setBonusForm] = useState({
                date: '',
                manager: '',
                comment: '',
                amount: ''
            });
            useEffect(() => {
                initializeMonthGoals(selectedMonth);
                const today = DateUtils.getTodayString();
                setPenaltyForm(prev => ({ ...prev, date: today }));
                setBonusForm(prev => ({ ...prev, date: today }));
            }, [selectedMonth, initializeMonthGoals]);
            const monthRecords = useMemo(() => 
                DateUtils.filterByMonth(records, selectedMonth), 
                [records, selectedMonth]
            );
            const monthPenalties = useMemo(() => 
                DateUtils.filterByMonth(penalties || [], selectedMonth), 
                [penalties, selectedMonth]
            );
            const monthBonuses = useMemo(() => 
                DateUtils.filterByMonth(bonuses || [], selectedMonth), 
                [bonuses, selectedMonth]
            );
            const teamProgress = Calculator.getTeamProgress(monthRecords, monthlyGoals[selectedMonth] || {}, managers, selectedMonth, disabledAgents);
            let progressClass = 'incomplete';
            if (teamProgress.progress === 100) progressClass = 'completed';
            else if (teamProgress.progress > 70) progressClass = 'partial';
            
            const handlePenaltySubmit = (e) => {
                e.preventDefault();
                const amountNum = parseFloat(penaltyForm.amount);
                if (!penaltyForm.manager) { addNotification('Выберите менеджера для штрафа', 'error'); return; }
                if (!penaltyForm.date) { addNotification('Выберите дату штрафа', 'error'); return; }
                if (!amountNum) { addNotification('Введите сумму штрафа', 'error'); return; }
                if (amountNum < 0) { addNotification('Внимание: Штраф с отрицательной суммой будет сохранен как положительный', 'warning'); }
                addPenalty({ ...penaltyForm, amount: amountNum });
                setPenaltyForm({ date: DateUtils.getTodayString(), manager: '', comment: '', amount: '' });
                addNotification('Штраф добавлен', 'success');
            };
            
            const handleBonusSubmit = (e) => {
                e.preventDefault();
                const amountNum = parseFloat(bonusForm.amount);
                if (!bonusForm.manager) { addNotification('Выберите менеджера для бонуса', 'error'); return; }
                if (!bonusForm.date) { addNotification('Выберите дату бонуса', 'error'); return; }
                if (!amountNum) { addNotification('Введите сумму бонуса', 'error'); return; }
                if (amountNum < 0) { addNotification('Внимание: Бонус с отрицательной суммой будет сохранен как положительный', 'warning'); }
                addBonus({ ...bonusForm, amount: amountNum });
                setBonusForm({ date: DateUtils.getTodayString(), manager: '', comment: '', amount: '' });
                addNotification('Бонус добавлен', 'success');
            };
            
            const goals = monthlyGoals[selectedMonth] || {};
            
            return (
                <div>
                    <MonthSelector 
                        label="Месяц:" 
                        value={selectedMonth} 
                        onChange={(e) => setSelectedMonth(e.target.value)} 
                    />
                    <div className="section">
                        <h3>🏆 Общий план команды за {DateUtils.formatMonthWithYear(selectedMonth)}</h3>
                        <div className="stats-grid">
                            <StatCard title="Общая цель" value={teamProgress.totalGoal} icon="🎯" />
                            <StatCard title="Валидные FTD" value={teamProgress.validDeposits} icon="✅" />
                            <StatCard title="Прогресс" value={`${teamProgress.progress}%`} icon="📈" />
                        </div>
                        <div className="progress-container">
                            <div 
                                className={`progress-bar ${progressClass}`} 
                                style={{width: `${MathUtils.clampProgress(teamProgress.progress)}%`}}
                            >
                                {teamProgress.progress}%
                            </div>
                        </div>
                    </div>
                    <div className="section">
                        <h3>👥 Планы менеджеров</h3>
                        <div style={CommonStyles.columnFlex}>
                            {useMemo(() => {
                                const salesManagers = managers.filter(m => m !== TEAM_LEADER_NAME);
                                const managerValidCounts = {};
                                monthRecords.forEach(r => {
                                    if (r.validity === 'valid' && r.manager !== TEAM_LEADER_NAME) {
                                        managerValidCounts[r.manager] = (managerValidCounts[r.manager] || 0) + 1;
                                    }
                                });
                                return salesManagers.map(manager => (
                                    <ManagerProgress 
                                        key={manager} 
                                        manager={manager} 
                                        validCount={managerValidCounts[manager] || 0} 
                                        goal={goals[manager] || 0} 
                                        initialManagers={initialManagers} 
                                        monthlyGoals={goals}
                                        monthKey={selectedMonth}
                                        disabledAgents={disabledAgents}
                                    />
                                ));
                            }, [managers, monthRecords, goals, initialManagers, selectedMonth, disabledAgents])}
                        </div>
                    </div>
                    <div className="section">
                        <h3>⛔ Штрафы</h3>
                        <form onSubmit={handlePenaltySubmit}>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label>Дата:</label>
                                    <input
                                        type="date"
                                        value={penaltyForm.date}
                                        onChange={(e) => setPenaltyForm({...penaltyForm, date: e.target.value})}
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Менеджер:</label>
                                    <select
                                        value={penaltyForm.manager}
                                        onChange={(e) => setPenaltyForm({...penaltyForm, manager: e.target.value})}
                                        required
                                    >
                                        <option value="">Выберите менеджера</option>
                                        {managers.map(m => <option key={m} value={m}>{m}</option>)}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Комментарий:</label>
                                    <input
                                        type="text"
                                        value={penaltyForm.comment}
                                        onChange={(e) => setPenaltyForm({...penaltyForm, comment: e.target.value})}
                                        placeholder="Причина штрафа"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Сумма ($):</label>
                                    <input
                                        type="number"
                                        value={penaltyForm.amount}
                                        onChange={(e) => setPenaltyForm({...penaltyForm, amount: e.target.value})}
                                        min="0"
                                        step="0.01"
                                        placeholder="50"
                                        required
                                    />
                                </div>
                            </div>
                            <button type="submit" className="btn btn-danger">Добавить штраф</button>
                        </form>
                        <div className="table-container" style={{marginTop: '1rem'}}>
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Менеджер</th>
                                        <th>Комментарий</th>
                                        <th>Сумма</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {monthPenalties.map(p => (
                                        <tr key={p.id}>
                                            <td>{DateUtils.formatDateShort(p.date)}</td>
                                            <td>{p.manager}</td>
                                            <td>{p.comment}</td>
                                            <td>{FormatUtils.formatCurrency(-p.amount)}</td>
                                            <td>
                                                <button className="btn btn-danger btn-sm" onClick={() => deletePenalty(p.id)}>Удалить</button>
                                            </td>
                                        </tr>
                                    ))}
                                    {monthPenalties.length === 0 && (
                                        <tr><td colSpan="5" style={CommonStyles.centeredText}>Нет штрафов за этот месяц</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div className="section">
                        <h3>💰 Бонусы</h3>
                        <form onSubmit={handleBonusSubmit}>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label>Дата:</label>
                                    <input
                                        type="date"
                                        value={bonusForm.date}
                                        onChange={(e) => setBonusForm({...bonusForm, date: e.target.value})}
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Менеджер:</label>
                                    <select
                                        value={bonusForm.manager}
                                        onChange={(e) => setBonusForm({...bonusForm, manager: e.target.value})}
                                        required
                                    >
                                        <option value="">Выберите менеджера</option>
                                        {managers.map(m => <option key={m} value={m}>{m}</option>)}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Комментарий:</label>
                                    <input
                                        type="text"
                                        value={bonusForm.comment}
                                        onChange={(e) => setBonusForm({...bonusForm, comment: e.target.value})}
                                        placeholder="Причина бонуса"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Сумма ($):</label>
                                    <input
                                        type="number"
                                        value={bonusForm.amount}
                                        onChange={(e) => setBonusForm({...bonusForm, amount: e.target.value})}
                                        min="0"
                                        step="0.01"
                                        placeholder="50"
                                        required
                                    />
                                </div>
                            </div>
                            <button type="submit" className="btn btn-primary">Добавить бонус</button>
                        </form>
                        <div className="table-container" style={{marginTop: '1rem'}}>
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Менеджер</th>
                                        <th>Комментарий</th>
                                        <th>Сумма</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {monthBonuses.map(b => (
                                        <tr key={b.id}>
                                            <td>{DateUtils.formatDateShort(b.date)}</td>
                                            <td>{b.manager}</td>
                                            <td>{b.comment}</td>
                                            <td>{FormatUtils.formatCurrency(b.amount, { showSign: true })}</td>
                                            <td>
                                                <button className="btn btn-danger btn-sm" onClick={() => deleteBonus(b.id)}>Удалить</button>
                                            </td>
                                        </tr>
                                    ))}
                                    {monthBonuses.length === 0 && (
                                        <tr><td colSpan="5" style={CommonStyles.centeredText}>Нет бонусов за этот месяц</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        const DataEntryTab = () => {
            const { records, managers, trafficOptions, countryOptions, addRecord, deleteRecord, initializeMonthGoals, disabledAgents } = useData();
            const { addNotification } = useNotification();
            const [form, setForm] = useState({
                date: '',
                manager: '',
                clientId: '',
                validity: '',
                traffic: trafficOptions[0],
                country: countryOptions[0]
            });
            const [modalOpen, setModalOpen] = useState(false);
            const [deleteId, setDeleteId] = useState(null);
            const [selectedMonth, setSelectedMonth] = useSelectedMonth();
            useEffect(() => {
                initializeMonthGoals(selectedMonth);
                setForm(prev => ({ ...prev, date: DateUtils.getTodayString() }));
            }, [selectedMonth, initializeMonthGoals]);
            const monthRecords = useMemo(() => 
                DateUtils.filterByMonth(records, selectedMonth), 
                [records, selectedMonth]
            );
            const handleSubmit = (e) => {
                e.preventDefault();
                const validation = Validator.validateRecord(form);
                if (!validation.isValid) {
                    Object.values(validation.errors).forEach(err => addNotification(err, 'error'));
                    return;
                }
                addRecord(form);
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const localToday = `${year}-${month}-${day}`;
                setForm({ 
                    date: localToday, 
                    manager: '', 
                    clientId: '', 
                    validity: '',
                    traffic: trafficOptions[0],
                    country: countryOptions[0]
                });
                addNotification('Запись добавлена', 'success');
            };
            const handleDeleteClick = (id) => {
                setDeleteId(id);
                setModalOpen(true);
            };
            const confirmDelete = () => {
                deleteRecord(deleteId);
                setModalOpen(false);
                setDeleteId(null);
                addNotification('Запись удалена', 'success');
            };
            const closeModal = () => {
                setModalOpen(false);
                setDeleteId(null);
            };
            return (
                <div>
                    <MonthSelector 
                        label="Месяц для ввода данных:" 
                        value={selectedMonth} 
                        onChange={(e) => setSelectedMonth(e.target.value)} 
                    />
                    <div className="section">
                        <h3>Добавить новую запись FTD за {DateUtils.formatMonthWithYear(selectedMonth)}</h3>
                        <form onSubmit={handleSubmit} className="animate-fade-in">
                            <div className="form-grid">
                                <div className="form-group">
                                    <label>Дата:</label>
                                    <input
                                        type="date"
                                        value={form.date}
                                        onChange={(e) => setForm({...form, date: e.target.value})}
                                        className="form-input"
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Менеджер:</label>
                                    <select
                                        value={form.manager}
                                        onChange={(e) => setForm({...form, manager: e.target.value})}
                                        className="form-input"
                                        required
                                    >
                                        <option value="">Выберите менеджера</option>
                                        {managers.map(m => <option key={m} value={m}>{m}</option>)}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>ID клиента:</label>
                                    <input
                                        type="text"
                                        value={form.clientId}
                                        onChange={(e) => setForm({...form, clientId: e.target.value})}
                                        placeholder="Введите ID"
                                        className="form-input"
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Валидность:</label>
                                    <select
                                        value={form.validity}
                                        onChange={(e) => setForm({...form, validity: e.target.value})}
                                        className="form-input"
                                        required
                                    >
                                        <option value="">Выберите</option>
                                        <option value="valid">Валидный</option>
                                        <option value="invalid">Невалидный</option>
                                        <option value="pending">На рассмотрении</option>
                                        <option value="not_counted">Не засчитано</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Трафик:</label>
                                    <select
                                        value={form.traffic}
                                        onChange={(e) => setForm({...form, traffic: e.target.value})}
                                        className="form-input"
                                        required
                                    >
                                        <option value="">Выберите трафик</option>
                                        {trafficOptions.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Страна:</label>
                                    <select
                                        value={form.country}
                                        onChange={(e) => setForm({...form, country: e.target.value})}
                                        className="form-input"
                                        required
                                    >
                                        <option value="">Выберите страну</option>
                                        {countryOptions.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                            </div>
                            <button type="submit" className="btn btn-primary btn-animated active-scale">
                                <span className="icon-bounce">➕</span> Добавить запись
                            </button>
                        </form>
                        <div className="tip">
                            💡 Совет: Когда вы добавляете FTD, день автоматически отмечается как рабочий в календаре посещаемости.
                        </div>
                    </div>
                    <SortableTable onDelete={handleDeleteClick} monthFilter={selectedMonth} />
                    <Modal 
                        isOpen={modalOpen} 
                        onClose={closeModal} 
                        onConfirm={confirmDelete} 
                        message="Удалить запись?" 
                    />
                </div>
            );
        };
        const PlanCompletionHistory = ({ manager, records, monthlyGoals }) => {
            const history = useMemo(() => {
                const monthsData = {};
                records.filter(r => r.manager === manager && r.validity === 'valid').forEach(record => {
                    const date = new Date(record.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthsData[monthKey]) {
                        monthsData[monthKey] = { count: 0, monthKey, monthName: DateUtils.formatMonthWithYear(monthKey) };
                    }
                    monthsData[monthKey].count++;
                });
                
                const history = Object.values(monthsData).map(monthData => {
                    const goal = monthlyGoals[monthData.monthKey]?.[manager] || 0;
                    const valid = monthData.count;
                    const progress = goal > 0 ? MathUtils.round((valid / goal) * 100) : 0;
                    const isCompleted = valid >= goal && goal > 0;
                    
                    return {
                        monthKey: monthData.monthKey,
                        monthName: monthData.monthName,
                        goal,
                        valid,
                        progress,
                        isCompleted
                    };
                });
                
                return history.sort((a, b) => b.monthKey.localeCompare(a.monthKey));
            }, [manager, records, monthlyGoals]);
            
            if (history.length === 0) {
                return (
                    <div style={{...CommonStyles.centeredText, padding: '1rem'}}>
                        Нет данных для отображения истории
                    </div>
                );
            }
            
            const completedCount = history.filter(h => h.isCompleted).length;
            const totalCount = history.length;
            const completionRate = totalCount > 0 ? MathUtils.round((completedCount / totalCount) * 100) : 0;
            
            return (
                <div>
                    <div style={{...CommonStyles.flexBetween, marginBottom: '1rem', padding: '0.75rem', background: 'rgba(79, 70, 229, 0.1)', borderRadius: '8px'}}>
                        <span style={{fontWeight: '600'}}>📊 Общая статистика выполнения планов:</span>
                        <span style={{fontWeight: '600', color: completionRate === 100 ? '#10b981' : completionRate >= 70 ? '#f59e0b' : '#ef4444'}}>
                            {completedCount}/{totalCount} выполнено ({completionRate}%)
                        </span>
                    </div>
                    <div style={CommonStyles.scrollableTable}>
                        <table style={CommonStyles.compactTable}>
                            <thead>
                                <tr style={CommonStyles.stickyTableHeader}>
                                    <th style={CommonStyles.tableHeaderCell}>Месяц</th>
                                    <th style={CommonStyles.tableHeaderCellCenter}>Цель</th>
                                    <th style={CommonStyles.tableHeaderCellCenter}>Факт</th>
                                    <th style={CommonStyles.tableHeaderCellCenter}>Прогресс</th>
                                    <th style={CommonStyles.tableHeaderCellCenter}>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                {history.map((item, index) => (
                                    <tr 
                                        key={item.monthKey} 
                                        style={index % 2 === 0 ? CommonStyles.tableRowEven : CommonStyles.tableRowOdd}
                                    >
                                        <td style={CommonStyles.tableCellBold}>{item.monthName}</td>
                                        <td style={CommonStyles.tableCellCenter}>{item.goal || '-'}</td>
                                        <td style={CommonStyles.tableCellCenterBold}>{item.valid}</td>
                                        <td style={{...CommonStyles.tableCellCenterBold, color: ProgressUtils.getProgressColor(item.progress)}}>
                                            {item.progress}%
                                        </td>
                                        <td style={CommonStyles.tableCellCenter}>
                                            {item.isCompleted ? (
                                                <span style={{color: '#10b981', fontWeight: '700'}}>✅ Выполнено</span>
                                            ) : item.goal > 0 ? (
                                                <span style={{color: '#ef4444', fontWeight: '600'}}>❌ Не выполнено</span>
                                            ) : (
                                                <span style={{color: '#6b7280'}}>—</span>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        
        const StatisticsTab = () => {
            const { records, penalties, bonuses, monthlyGoals, tariffs, invalidBonusPerFTD, teamLeaderPerFTD, teamPlanBonusAmount, plannedDays, attendance, managers, initialManagers, managerBaseRates, initializeMonthGoals, getWorkedDays, disabledAgents } = useData();
            const [selectedMonth, setSelectedMonth] = useSelectedMonth();
            useEffect(() => {
                initializeMonthGoals(selectedMonth);
            }, [selectedMonth, initializeMonthGoals]);
            
            const { monthRecords, monthPenalties, monthBonuses } = useMonthData(selectedMonth);
            
            const goals = monthlyGoals[selectedMonth] || {};
            const plannedD = plannedDays[selectedMonth] || 22;
            const totalStats = Calculator.calculateStats(monthRecords);
            const totalValid = totalStats.valid;
            
            const managersData = useMemo(() => {
                const config = {
                    monthRecords,
                    monthPenalties,
                    monthBonuses,
                    goals,
                    plannedDays: plannedD,
                    monthKey: selectedMonth,
                    managers,
                    initialManagers,
                    totalValid,
                    tariffs,
                    invalidBonusPerFTD,
                    teamLeaderPerFTD,
                    teamPlanBonusAmount,
                    managerBaseRates,
                    getWorkedDays,
                    disabledAgents
                };
                
                const salesManagers = managers.filter(m => m !== TEAM_LEADER_NAME);
                return salesManagers.map(manager => ({
                    manager,
                    data: getManagerData(manager, config)
                }));
            }, [managers, monthRecords, monthPenalties, monthBonuses, goals, plannedD, selectedMonth, initialManagers, totalValid, tariffs, invalidBonusPerFTD, teamLeaderPerFTD, teamPlanBonusAmount, managerBaseRates, getWorkedDays]);
            return (
                <div>
                    <MonthSelector 
                        label="Месяц:" 
                        value={selectedMonth} 
                        onChange={(e) => setSelectedMonth(e.target.value)} 
                    />
                    <div className="stats-grid">
                        <StatCard title="Всего депозитов" value={totalStats.total} icon="📊" />
                        <StatCard title="Валидных депозитов" value={totalStats.valid} icon="✅" />
                        <StatCard title="Невалидных депозитов" value={totalStats.invalid} icon="❌" />
                        <StatCard title="Конверсия" value={`${totalStats.conversion}%`} icon="📈" />
                    </div>
                    <div className="section">
                        <h3>🎯 Прогресс по планам за {DateUtils.formatMonthWithYear(selectedMonth)}</h3>
                        <div style={CommonStyles.columnFlex}>
                            {managersData.map(({ manager, data }, index) => {
                                const { stats, goal, progress, bonus, workedDays, isTeamLeader, 
                                    teamValidForBonus, teamPlanBonus, salary, totalWithBonus, 
                                    managerBonuses, penaltiesSum } = data;
                                
                                return (
                                    <div 
                                        key={manager} 
                                        className="stat-card animate-scale-in" 
                                        style={{...CommonStyles.statCard, animationDelay: `${index * 0.1}s`}}
                                    >
                                        <ManagerHeader manager={manager} initialManagers={initialManagers} />
                                        <ManagerStats stats={stats} />
                                        <ProgressSection goal={goal} progress={progress} stats={stats} />
                                        <AttendanceSection workedDays={workedDays} plannedD={plannedD} />
                                        <BonusCard bonus={bonus} />
                                        <SalaryBreakdown 
                                            salaryData={{
                                                salary,
                                                stats,
                                                bonus,
                                                managerBonuses,
                                                teamPlanBonus,
                                                isTeamLeader,
                                                teamLeaderPerFTD,
                                                teamValidForBonus,
                                                invalidBonusPerFTD,
                                                plannedD,
                                                workedDays
                                            }}
                                        />
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <div className="section">
                        <h3>📋 История выполнения планов</h3>
                        <div style={CommonStyles.columnFlex}>
                            {useMemo(() => {
                                const salesManagers = managers.filter(m => m !== TEAM_LEADER_NAME);
                                return salesManagers.map(manager => (
                                <div key={manager} style={{...CommonStyles.statCard, marginBottom: '1rem'}}>
                                    <div style={{...CommonStyles.flexBetween, marginBottom: '1rem', paddingBottom: '0.75rem', borderBottom: '2px solid rgba(79, 70, 229, 0.2)'}}>
                                        <h4 style={{margin: 0, fontSize: '1.1rem', fontWeight: '700', display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                                            <span>{manager}</span>
                                            <ManagerBadges manager={manager} initialManagers={initialManagers} />
                                        </h4>
                                    </div>
                                    <PlanCompletionHistory manager={manager} records={records} monthlyGoals={monthlyGoals} />
                                </div>
                                ));
                            }, [managers, initialManagers, records, monthlyGoals])}
                        </div>
                    </div>
                </div>
            );
        };
        const MonthlyStatsTab = () => {
            const { records, penalties, bonuses, monthlyGoals, tariffs, invalidBonusPerFTD, teamLeaderPerFTD, teamPlanBonusAmount, plannedDays, attendance, managers, initialManagers, managerBaseRates, initializeMonthGoals, getWorkedDays, disabledAgents, isAgentDisabled } = useData();
            const [yearFilter, setYearFilter] = useState('2026');
            const [comparePrevious, setComparePrevious] = useState(false);
            const filteredRecords = useMemo(() => {
                let recs = records;
                if (yearFilter) {
                    recs = recs.filter(r => new Date(r.date).getFullYear().toString() === yearFilter);
                }
                return recs;
            }, [records, yearFilter]);
            const monthlyData = useMemo(() => {
                const data = {};
                const yearFilterNum = yearFilter ? parseInt(yearFilter) : null;
                
                filteredRecords.forEach(record => {
                    const date = new Date(record.date);
                    if (yearFilterNum && date.getFullYear() !== yearFilterNum) return;
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!data[monthKey]) {
                        data[monthKey] = { 
                            name: DateUtils.formatMonthWithYear(monthKey), 
                            records: [], 
                            managers: {}, 
                            plan: monthlyGoals[monthKey] || {}, 
                            penalties: [], 
                            bonuses: [] 
                        };
                        initializeMonthGoals(monthKey);
                    }
                    data[monthKey].records.push(record);
                    const mgr = record.manager;
                    if (!data[monthKey].managers[mgr]) {
                        data[monthKey].managers[mgr] = { total: 0, valid: 0, invalid: 0 };
                    }
                    data[monthKey].managers[mgr].total++;
                    if (record.validity === 'valid') {
                        data[monthKey].managers[mgr].valid++;
                    } else {
                        data[monthKey].managers[mgr].invalid++;
                    }
                });
                
                if (penalties) {
                    penalties.forEach(p => {
                    const date = new Date(p.date);
                        if (yearFilterNum && date.getFullYear() !== yearFilterNum) return;
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!data[monthKey]) {
                            data[monthKey] = { 
                                name: DateUtils.formatMonthWithYear(monthKey), 
                                records: [], 
                                managers: {}, 
                                plan: monthlyGoals[monthKey] || {}, 
                                penalties: [], 
                                bonuses: [] 
                            };
                        initializeMonthGoals(monthKey);
                    }
                    data[monthKey].penalties.push(p);
                });
                }
                
                if (bonuses) {
                    bonuses.forEach(b => {
                    const date = new Date(b.date);
                        if (yearFilterNum && date.getFullYear() !== yearFilterNum) return;
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!data[monthKey]) {
                            data[monthKey] = { 
                                name: DateUtils.formatMonthWithYear(monthKey), 
                                records: [], 
                                managers: {}, 
                                plan: monthlyGoals[monthKey] || {}, 
                                penalties: [], 
                                bonuses: [] 
                            };
                        initializeMonthGoals(monthKey);
                    }
                    data[monthKey].bonuses.push(b);
                });
                }
                
                Object.keys(data).forEach(monthKey => {
                    managers.forEach(manager => {
                        if (!data[monthKey].managers[manager]) {
                            data[monthKey].managers[manager] = { total: 0, valid: 0, invalid: 0 };
                        }
                    });
                });
                
                return data;
            }, [filteredRecords, penalties, bonuses, monthlyGoals, initializeMonthGoals, yearFilter, managers]);
            const getPreviousMonthData = useCallback((monthKey) => {
                const date = new Date(monthKey + '-01');
                date.setMonth(date.getMonth() - 1);
                const prevYear = date.getFullYear();
                const prevMonthNum = date.getMonth() + 1;
                const prevMonthKey = `${prevYear}-${String(prevMonthNum).padStart(2, '0')}`;
                initializeMonthGoals(prevMonthKey);
                const prevGoals = monthlyGoals[prevMonthKey] || {};
                const prevRecords = records.filter(r => {
                    const rDate = new Date(r.date);
                    return rDate.getFullYear() === prevYear && (rDate.getMonth() + 1) === prevMonthNum;
                });
                if (prevRecords.length === 0) return null;
                const prevManagers = {};
                prevRecords.forEach(record => {
                    const mgr = record.manager;
                    if (!prevManagers[mgr]) {
                        prevManagers[mgr] = { total: 0, valid: 0, invalid: 0 };
                    }
                    prevManagers[mgr].total++;
                    if (record.validity === 'valid') {
                        prevManagers[mgr].valid++;
                    } else {
                        prevManagers[mgr].invalid++;
                    }
                });
                const prevStats = Calculator.calculateStats(prevRecords);
                const prevPenalties = (penalties || []).filter(p => {
                    const pDate = new Date(p.date);
                    return pDate.getFullYear() === prevYear && (pDate.getMonth() + 1) === prevMonthNum;
                });
                const prevBonuses = (bonuses || []).filter(b => {
                    const bDate = new Date(b.date);
                    return bDate.getFullYear() === prevYear && (bDate.getMonth() + 1) === prevMonthNum;
                });
                return { monthKey: prevMonthKey, records: prevRecords, managers: prevManagers, stats: prevStats, goals: prevGoals, penalties: prevPenalties, bonuses: prevBonuses };
            }, [records, penalties, bonuses, monthlyGoals, initializeMonthGoals]);
            return (
                <div>
                    <div className="section">
                        <div className="filter-row">
                            <div className="form-group">
                                <label>Год:</label>
                                <select value={yearFilter} onChange={(e) => setYearFilter(e.target.value)}>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <input
                                    type="checkbox"
                                    id="compare-checkbox"
                                    checked={comparePrevious}
                                    onChange={(e) => setComparePrevious(e.target.checked)}
                                />
                                <label htmlFor="compare-checkbox">Сравнить с прошлым месяцем</label>
                            </div>
                        </div>
                    </div>
                    {Object.keys(monthlyData).length === 0 ? (
                        <p style={{...CommonStyles.centeredText, ...CommonStyles.paddingLarge}}>
                            Нет данных за выбранный период
                        </p>
                    ) : (
                        Object.keys(monthlyData).sort().reverse().map(monthKey => {
                            const monthData = monthlyData[monthKey];
                            const stats = Calculator.calculateStats(monthData.records);
                            const goals = monthlyGoals[monthKey] || {};
                            const prevMonthData = comparePrevious ? getPreviousMonthData(monthKey) : null;
                            const prevStats = prevMonthData ? prevMonthData.stats : null;
                            const plannedD = plannedDays[monthKey] || 22;
                            const totalValid = stats.valid;
                            const deltas = prevStats ? {
                                total: Calculator.calculateDelta(stats.total, prevStats.total),
                                valid: Calculator.calculateDelta(stats.valid, prevStats.valid),
                                invalid: Calculator.calculateDelta(stats.invalid, prevStats.invalid),
                                conversion: Calculator.calculateDelta(parseFloat(stats.conversion), parseFloat(prevStats.conversion))
                            } : {};
                            const renderDelta = (delta, isConversion = false) => {
                                if (!comparePrevious || !prevStats) return null;
                                return <DeltaDisplay delta={delta} isConversion={isConversion} />;
                            };
                            return (
                                <div key={monthKey} className="stat-card" style={{marginBottom: '1.5rem'}}>
                                    <h4 style={CommonStyles.mediumStat}>
                                        📅 {monthData.name}
                                    </h4>
                                    <div style={CommonStyles.statsGridMedium}>
                                        <div style={CommonStyles.flexColumnStart}>
                                            <div style={CommonStyles.flexAlignBaseline}>
                                                <span style={{...CommonStyles.largeStat, color: '#4f46e5'}}>{stats.total}</span>
                                                {renderDelta(deltas.total)}
                                            </div>
                                            <div style={CommonStyles.smallText}>Всего записей</div>
                                        </div>
                                        <div style={CommonStyles.flexColumnStart}>
                                            <div style={CommonStyles.flexAlignBaseline}>
                                                <span style={{...CommonStyles.largeStat, color: '#10b981'}}>{stats.valid}</span>
                                                {renderDelta(deltas.valid)}
                                            </div>
                                            <div style={CommonStyles.smallText}>Валидные</div>
                                        </div>
                                        <div style={CommonStyles.flexColumnStart}>
                                            <div style={CommonStyles.flexAlignBaseline}>
                                                <span style={{...CommonStyles.largeStat, color: '#ef4444'}}>{stats.invalid}</span>
                                                {renderDelta(deltas.invalid)}
                                            </div>
                                            <div style={CommonStyles.smallText}>Невалидные</div>
                                        </div>
                                        <div style={CommonStyles.flexColumnStart}>
                                            <div style={CommonStyles.flexAlignBaseline}>
                                                <span style={{...CommonStyles.largeStat, color: '#f59e0b'}}>{stats.conversion}%</span>
                                                {renderDelta(deltas.conversion, true)}
                                            </div>
                                            <div style={CommonStyles.smallText}>Конверсия</div>
                                        </div>
                                <div style={CommonStyles.flexColumnStart}>
                                    <div style={CommonStyles.flexAlignBaseline}>
                                        <span style={{...CommonStyles.largeStat, color: '#ef4444'}}>
                                            -${(monthData.penalties || []).reduce((s, p) => s + (Math.abs(p.amount) || 0), 0)}
                                        </span>
                                    </div>
                                    <div style={CommonStyles.smallText}>Штрафы (месяц)</div>
                                        </div>
                                    </div>
                                    <div style={CommonStyles.plansSection}>
                                        <h5 style={CommonStyles.sectionTitle}>
                                            🎯 Планы на месяц
                                        </h5>
                                        <div style={CommonStyles.plansGrid}>
                                            {managers.filter(manager => !isAgentDisabled(monthKey, manager)).map(manager => {
                                                const managerPlan = goals[manager] || 0;
                                                const managerValid = monthData.managers[manager]?.valid || 0;
                                                const progress = Calculator.getProgressPercentage(goals, manager, managerValid);
                                                const progressClass = ProgressUtils.getProgressClass(progress);
                                                const isTeamLeader = ManagerUtils.isTeamLeader(manager);
                                                const isNewManager = ManagerUtils.isNewManager(manager, initialManagers);
                                                return (
                                                    <div key={manager} style={CommonStyles.managerCard}>
                                                        <div style={{...CommonStyles.managerCardHeader, display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                                                            <div style={{fontWeight: '600', color: '#1e293b'}}>{manager}</div>
                                                            <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                                                {isTeamLeader && <span className="team-leader-badge">Тим-Лидер</span>}
                                                                {isNewManager && <span className="sale-badge">Сейл</span>}
                                                            </div>
                                                        </div>
                                                        <div style={CommonStyles.flexBetween}>
                                                            <span>Цель: {managerPlan} FTD</span>
                                                            <span style={CommonStyles.progressLabel}>
                                                                {managerValid}/{managerPlan}
                                                            </span>
                                                        </div>
                                                        <div className="progress-container" style={CommonStyles.marginBottom}>
                                                            <div 
                                                                className={`progress-bar ${progressClass}`} 
                                                                style={{width: `${MathUtils.clampProgress(progress)}%`}}
                                                            >
                                                                {progress}%
                                                            </div>
                                                        </div>
                                                        {managerValid >= managerPlan && managerPlan > 0 && (
                                                            <div style={CommonStyles.bonusBadge}>
                                                                ✅ Бонус $100
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                    {managers.filter(manager => !isAgentDisabled(monthKey, manager)).map(manager => {
                                        const managerData = monthData.managers[manager] || { total: 0, valid: 0, invalid: 0 };
                                        const managerConversion = managerData.total > 0 
                                            ? ((managerData.valid / managerData.total) * 100).toFixed(1) : 0;
                                        const otherManagers = managers.filter(m => m !== manager);
                                        const otherManagersValid = otherManagers.map(emp => ({
                                            emp,
                                            valid: monthData.managers[emp]?.valid || 0
                                        }));
                                        const workedDays = getWorkedDays(monthKey, manager);
                                        const isTeamLeader = ManagerUtils.isTeamLeader(manager);
                                        let teamValidForBonus = 0;
                                        if (isTeamLeader) {
                                            teamValidForBonus = totalValid - managerData.valid;
                                        }
                                        const managerPenalties = (monthData.penalties || []).filter(p => p.manager === manager);
                                        const penaltiesSum = DataHelpers.calculatePenaltiesSum(managerPenalties, manager);
                                        const managerBonuses = DataHelpers.calculateBonusesSum(monthData.bonuses || [], manager);
                                        const teamPlanBonus = isTeamLeader ? Calculator.getTeamPlanBonus(managers, initialManagers, goals, monthData.records, teamPlanBonusAmount, monthKey, disabledAgents) : 0;
                                        const salary = Calculator.calculateSalary({
                                            validDeposits: managerData.valid,
                                            invalidDeposits: managerData.invalid,
                                            tariffs,
                                            invalidBonusPerFTD,
                                            plannedDays: plannedD,
                                            manager,
                                            goals,
                                            otherManagersValid,
                                            teamLeaderPerFTD,
                                            workedDays,
                                            teamValidForBonus,
                                            penaltiesAmount: penaltiesSum,
                                            teamPlanBonus,
                                            managerBonuses,
                                            managerBaseRates
                                        });
                                        const bonus = Calculator.getBonusForGoal(goals, manager, managerData.valid, monthKey, disabledAgents);
                                        const totalWithBonus = salary.totalSalary + bonus + managerBonuses;
                                        const prevManagerData = prevMonthData ? prevMonthData.managers[manager] : null;
                                        const prevGoals = prevMonthData ? prevMonthData.goals : {};
                                        const prevMonthKey = prevMonthData?.monthKey;
                                        const prevOtherManagersValid = otherManagers.map(emp => ({
                                            emp,
                                            valid: prevMonthData ? prevMonthData.managers[emp]?.valid || 0 : 0
                                        }));
                                        const prevPlanned = prevMonthKey ? (plannedDays[prevMonthKey] || 22) : plannedD;
                                        const prevWorked = prevMonthKey ? getWorkedDays(prevMonthKey, manager) : 0;
                                        let prevTeamValidForBonus = 0;
                                        if (isTeamLeader && prevMonthData) {
                                            const prevTotalValid = Calculator.calculateStats(prevMonthData.records).valid;
                                            prevTeamValidForBonus = prevTotalValid - (prevManagerData ? prevManagerData.valid : 0);
                                        }
                                        const prevTeamPlanBonus = (prevManagerData && isTeamLeader) ? Calculator.getTeamPlanBonus(managers, initialManagers, prevGoals, prevMonthData ? prevMonthData.records : [], teamPlanBonusAmount, prevMonthKey, disabledAgents) : 0;
                                        const prevManagerPenalties = prevMonthData ? (prevMonthData.penalties || []).filter(p => p.manager === manager) : [];
                                        const prevPenaltiesSum = DataHelpers.calculatePenaltiesSum(prevManagerPenalties, manager);
                                        const prevManagerBonuses = prevMonthData ? (prevMonthData.bonuses || []).filter(b => b.manager === manager) : [];
                                        const prevManagerBonusesSum = DataHelpers.calculateBonusesSum(prevManagerBonuses, manager);
                                        const prevSalaryCalc = prevManagerData ? Calculator.calculateSalary({
                                            validDeposits: prevManagerData.valid,
                                            invalidDeposits: prevManagerData.invalid,
                                            tariffs,
                                            invalidBonusPerFTD,
                                            plannedDays: prevPlanned,
                                            manager,
                                            goals: prevGoals,
                                            otherManagersValid: prevOtherManagersValid,
                                            teamLeaderPerFTD,
                                            workedDays: prevWorked,
                                            teamValidForBonus: prevTeamValidForBonus,
                                            penaltiesAmount: prevPenaltiesSum,
                                            teamPlanBonus: prevTeamPlanBonus,
                                            managerBonuses: prevManagerBonusesSum,
                                            managerBaseRates
                                        }) : { totalSalary: 0 };
                                        const prevBonus = Calculator.getBonusForGoal(prevGoals, manager, prevManagerData ? prevManagerData.valid : 0, prevMonthKey, disabledAgents);
                                        const prevTotal = prevSalaryCalc.totalSalary + prevBonus + prevManagerBonusesSum;
                                        const deltaSalary = Calculator.calculateDelta(totalWithBonus, prevTotal);
                                        const isNewManager = ManagerUtils.isNewManager(manager, initialManagers);
                                        const renderManagerDelta = (delta) => {
                                            if (!comparePrevious || !prevManagerData) return null;
                                            return <DeltaDisplay delta={delta} />;
                                        };
                                        return (
                                            <div key={manager} style={CommonStyles.managerInfoCard}>
                                                <h5 style={{...CommonStyles.sectionTitle, display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                                                    <span>{manager}</span>
                                                    <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                                        {isTeamLeader && <span className="team-leader-badge">Тим-Лидер</span>}
                                                        {isNewManager && <span className="sale-badge">Сейл</span>}
                                                    </div>
                                                </h5>
                                                <div style={CommonStyles.statsGridSmall}>
                                                    <div><strong>Всего:</strong> {managerData.total}</div>
                                                    <div><strong>Валидные:</strong> {managerData.valid}</div>
                                                    <div><strong>Невалидные:</strong> {managerData.invalid}</div>
                                                    <div><strong>Конверсия:</strong> {managerConversion}%</div>
                                                    <div><strong>Посещаемость:</strong> {FormatUtils.formatDays(workedDays)}/{plannedD}</div>
                                                    <div><strong>Итоговая ставка:</strong> {FormatUtils.formatCurrency(salary.adjustedBaseRate)}</div>
                                                    {penaltiesSum > 0 && <div><strong>Штрафы:</strong> {FormatUtils.formatCurrency(penaltiesSum)}</div>}
                                                    {bonus > 0 && <div><strong>Бонус за план:</strong> {FormatUtils.formatCurrency(100, { showSign: true })}</div>}
                                                    {teamPlanBonus > 0 && <div><strong>Бонус за общий план:</strong> {FormatUtils.formatCurrency(teamPlanBonus, { showSign: true })}</div>}
                                                    {managerBonuses > 0 && <div><strong>Дополнительные бонусы:</strong> {FormatUtils.formatCurrency(managerBonuses, { showSign: true })}</div>}
                                                    {isTeamLeader && (
                                                        <>
                                                            <div><strong>Тим-лидер бонус:</strong> {FormatUtils.formatCurrency(salary.teamLeaderBonus, { showSign: true })}</div>
                                                        </>
                                                    )}
                                                    <div><strong>Итого:</strong> {FormatUtils.formatCurrency(totalWithBonus)}
                                                        {renderManagerDelta(deltaSalary)}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            );
                        })
                    )}
                </div>
            );
        };
        
        const TeamLeaderSalaryTab = () => {
            const { records, bonuses, monthlyGoals, managers, initialManagers, plannedDays, getWorkedDays, attendance } = useData();
            const { addNotification } = useNotification();
            const [selectedMonth, setSelectedMonth] = useSelectedMonth();
            const [isAuthorized, setIsAuthorized] = useState(() => {
                const stored = sessionStorage.getItem('teamLeaderSalaryAuthorized');
                return stored === 'true';
            });
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            
            const monthRecords = useMemo(() => 
                DateUtils.filterByMonth(records, selectedMonth), 
                [records, selectedMonth]
            );
            
            const monthBonuses = useMemo(() => 
                DateUtils.filterByMonth(bonuses || [], selectedMonth), 
                [bonuses, selectedMonth]
            );
            
            const goals = monthlyGoals[selectedMonth] || {};
            const plannedD = plannedDays[selectedMonth] || 22;
            const workedDays = getWorkedDays(selectedMonth, TEAM_LEADER_NAME);
            
            const salaryData = useMemo(() => {
                if (!isAuthorized) return null;
                return TeamLeaderSalaryCalculator.calculateSalary({
                    records: monthRecords,
                    bonuses: monthBonuses,
                    managers,
                    initialManagers,
                    goals,
                    selectedMonth
                });
            }, [monthRecords, monthBonuses, managers, initialManagers, goals, selectedMonth, isAuthorized]);
            
            const getCurrentPeriod = useMemo(() => {
                const now = new Date();
                const currentMonthKey = DateUtils.getCurrentMonthKey();
                
                if (selectedMonth !== currentMonthKey) {
                    return null;
                }
                
                const today = now.getDate();
                if (today >= 1 && today <= 10) return 1;
                if (today >= 11 && today <= 20) return 2;
                return 3;
            }, [selectedMonth]);
            
            const handlePasswordSubmit = (e) => {
                e.preventDefault();
                setError('');
                
                if (password === TEAM_LEADER_SALARY_PASSWORD) {
                    setIsAuthorized(true);
                    sessionStorage.setItem('teamLeaderSalaryAuthorized', 'true');
                    addNotification('Доступ разрешен', 'success');
                    setPassword('');
                } else {
                    setError('Неверный пароль');
                    addNotification('Неверный пароль', 'error');
                    setPassword('');
                }
            };
            
            const handleLogout = () => {
                setIsAuthorized(false);
                sessionStorage.removeItem('teamLeaderSalaryAuthorized');
                setPassword('');
                setError('');
            };
            
            if (!isAuthorized) {
                return (
                    <div style={{
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        minHeight: '60vh',
                        padding: '2rem'
                    }}>
                        <div style={{
                            background: 'rgba(255, 255, 255, 0.05)',
                            backdropFilter: 'blur(10px)',
                            borderRadius: '16px',
                            padding: '2.5rem',
                            maxWidth: '400px',
                            width: '100%',
                            border: '1px solid rgba(255, 255, 255, 0.1)',
                            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.1)'
                        }}>
                            <div style={{
                                textAlign: 'center',
                                marginBottom: '2rem'
                            }}>
                                <div style={{
                                    fontSize: '3rem',
                                    marginBottom: '1rem'
                                }}>🔒</div>
                                <h3 style={{
                                    margin: '0 0 0.5rem 0',
                                    color: 'var(--text)',
                                    fontSize: '1.5rem'
                                }}>Доступ ограничен</h3>
                                <p style={{
                                    color: 'var(--text-muted)',
                                    fontSize: '0.9rem',
                                    margin: 0
                                }}>Введите пароль для доступа к зарплате тим-лидера</p>
                            </div>
                            
                            <form onSubmit={handlePasswordSubmit}>
                                <div className="form-group">
                                    <label style={{
                                        display: 'block',
                                        marginBottom: '0.5rem',
                                        color: 'var(--text)',
                                        fontWeight: '500'
                                    }}>Пароль:</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="Введите пароль"
                                        style={{
                                            width: '100%',
                                            padding: '0.75rem 1rem',
                                            background: 'rgba(255, 255, 255, 0.1)',
                                            border: `1px solid ${error ? 'rgba(239, 68, 68, 0.5)' : 'rgba(255, 255, 255, 0.2)'}`,
                                            borderRadius: '8px',
                                            color: 'var(--text)',
                                            fontSize: '1rem',
                                            outline: 'none',
                                            transition: 'all 0.3s ease'
                                        }}
                                        autoFocus
                                        required
                                    />
                                    {error && (
                                        <div style={{
                                            color: '#ef4444',
                                            fontSize: '0.85rem',
                                            marginTop: '0.5rem'
                                        }}>{error}</div>
                                    )}
                                </div>
                                
                                <button
                                    type="submit"
                                    className="btn btn-primary"
                                    style={{
                                        width: '100%',
                                        marginTop: '1rem',
                                        padding: '0.75rem'
                                    }}
                                >
                                    Войти
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }
            
            if (!salaryData) {
                return null;
            }
            
            return (
                <div>
                    <div style={{
                        ...CommonStyles.flexBetween,
                        alignItems: 'center',
                        marginBottom: '1rem',
                        padding: '0.75rem 1rem',
                        background: 'rgba(79, 70, 229, 0.1)',
                        borderRadius: '8px',
                        border: '1px solid rgba(79, 70, 229, 0.3)'
                    }}>
                        <span style={{fontSize: '0.9rem', color: 'var(--text-muted)'}}>🔒 Доступ разрешен</span>
                        <button
                            onClick={handleLogout}
                            className="btn btn-secondary btn-sm"
                            style={{padding: '0.5rem 1rem', fontSize: '0.85rem'}}
                        >
                            Выйти
                        </button>
                    </div>
                    
                    <MonthSelector 
                        label="Месяц:" 
                        value={selectedMonth} 
                        onChange={(e) => setSelectedMonth(e.target.value)} 
                    />
                    
                    <div className="section" style={{
                        background: 'transparent',
                        border: 'none',
                        padding: 0
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '2rem',
                            padding: '1.5rem',
                            background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))',
                            borderRadius: '16px',
                            border: '1px solid rgba(102, 126, 234, 0.2)'
                        }}>
                            <div>
                                <h3 style={{
                                    margin: '0 0 0.5rem 0',
                                    fontSize: '1.8rem',
                                    fontWeight: '700',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.75rem'
                                }}>
                                    <span style={{fontSize: '2rem'}}>👑</span>
                                    <span style={{
                                        background: 'linear-gradient(135deg, #667eea, #764ba2)',
                                        WebkitBackgroundClip: 'text',
                                        WebkitTextFillColor: 'transparent',
                                        backgroundClip: 'text'
                                    }}>Зарплата тим-лидера</span>
                                </h3>
                                <p style={{
                                    margin: 0,
                                    color: 'var(--text-muted)',
                                    fontSize: '0.9rem'
                                }}>Детальный расчет заработной платы</p>
                            </div>
                            <div style={{
                                padding: '0.75rem 1.5rem',
                                background: 'rgba(102, 126, 234, 0.15)',
                                borderRadius: '12px',
                                border: '1px solid rgba(102, 126, 234, 0.3)',
                                backdropFilter: 'blur(10px)'
                            }}>
                                <span style={{
                                    fontWeight: '600',
                                    color: 'var(--primary)',
                                    fontSize: '1rem'
                                }}>{TEAM_LEADER_NAME}</span>
                            </div>
                        </div>
                        
                        <TeamLeaderSalaryBreakdown 
                            salaryData={salaryData}
                            workedDays={workedDays}
                            plannedD={plannedD}
                            selectedMonth={selectedMonth}
                            records={records}
                            monthlyGoals={monthlyGoals}
                            bonuses={bonuses}
                            managers={managers}
                            initialManagers={initialManagers}
                            plannedDays={plannedDays}
                            getWorkedDays={getWorkedDays}
                        />
                            
                            {salaryData.weeklyTargetBonus.totalTarget > 0 && (
                                <div style={{
                                    marginTop: '1.5rem',
                                    padding: '1.5rem',
                                    background: 'rgba(255, 255, 255, 0.03)',
                                    borderRadius: '16px',
                                    border: '1px solid rgba(255, 255, 255, 0.1)',
                                    backdropFilter: 'blur(10px)'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.75rem',
                                        marginBottom: '1.25rem'
                                    }}>
                                        <span style={{fontSize: '1.5rem'}}>📅</span>
                                        <h5 style={{
                                            margin: 0,
                                            fontSize: '1.1rem',
                                            fontWeight: '700',
                                            color: 'var(--text)'
                                        }}>Недельный таргет по периодам</h5>
                                    </div>
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))',
                                        gap: '1rem'
                                    }}>
                                        {salaryData.weeklyTargetBonus.periods.map((period, idx) => {
                                            const isActivePeriod = getCurrentPeriod === period.period;
                                            
                                            return (
                                            <div key={idx} style={{
                                                padding: '1.25rem',
                                                background: isActivePeriod
                                                    ? 'linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.15))'
                                                    : period.isCompleted 
                                                        ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1))' 
                                                        : 'linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1))',
                                                borderRadius: '12px',
                                                border: isActivePeriod
                                                    ? '3px solid rgba(59, 130, 246, 0.8)'
                                                    : `2px solid ${period.isCompleted ? 'rgba(16, 185, 129, 0.4)' : 'rgba(239, 68, 68, 0.4)'}`,
                                                transition: 'all 0.3s ease',
                                                position: 'relative',
                                                overflow: 'hidden',
                                                boxShadow: isActivePeriod 
                                                    ? '0 0 20px rgba(59, 130, 246, 0.4), 0 4px 12px rgba(59, 130, 246, 0.2)'
                                                    : 'none'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.transform = 'translateY(-4px)';
                                                e.currentTarget.style.boxShadow = isActivePeriod
                                                    ? '0 0 25px rgba(59, 130, 246, 0.5), 0 8px 20px rgba(59, 130, 246, 0.3)'
                                                    : period.isCompleted 
                                                        ? '0 10px 30px rgba(16, 185, 129, 0.3)' 
                                                        : '0 10px 30px rgba(239, 68, 68, 0.3)';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.transform = 'translateY(0)';
                                                e.currentTarget.style.boxShadow = isActivePeriod 
                                                    ? '0 0 20px rgba(59, 130, 246, 0.4), 0 4px 12px rgba(59, 130, 246, 0.2)'
                                                    : 'none';
                                            }}
                                            >
                                                <div style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'space-between',
                                                    marginBottom: '1rem'
                                                }}>
                                                    <div style={{
                                                        fontSize: '1rem',
                                                        fontWeight: '700',
                                                        color: 'var(--text)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '0.5rem',
                                                        flexWrap: 'wrap'
                                                    }}>
                                                        Период {period.period}
                                                        {isActivePeriod && (
                                                            <span style={{
                                                                fontSize: '0.7rem',
                                                                padding: '0.2rem 0.5rem',
                                                                background: 'rgba(59, 130, 246, 0.2)',
                                                                borderRadius: '6px',
                                                                color: '#3b82f6',
                                                                fontWeight: '600',
                                                                border: '1px solid rgba(59, 130, 246, 0.4)',
                                                                whiteSpace: 'nowrap'
                                                            }}>
                                                                🔵 Активный
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div style={{
                                                        fontSize: '1.5rem',
                                                        filter: period.isCompleted ? 'drop-shadow(0 0 8px rgba(16, 185, 129, 0.6))' : 'none'
                                                    }}>
                                                        {period.isCompleted ? '✅' : '❌'}
                                                    </div>
                                                </div>
                                                <div style={{
                                                    fontSize: '0.75rem',
                                                    color: 'var(--text-muted)',
                                                    marginBottom: '0.75rem',
                                                    opacity: 0.8
                                                }}>
                                                    {period.period === 1 ? '1-10 дни' : period.period === 2 ? '11-20 дни' : '21-31 дни'}
                                                </div>
                                                <div style={{
                                                    display: 'flex',
                                                    alignItems: 'baseline',
                                                    gap: '0.5rem',
                                                    marginBottom: '0.75rem'
                                                }}>
                                                    <span style={{
                                                        fontSize: '1.5rem',
                                                        fontWeight: '700',
                                                        color: period.isCompleted ? '#10b981' : '#ef4444'
                                                    }}>
                                                        {period.validCount}
                                                    </span>
                                                    <span style={{
                                                        fontSize: '1rem',
                                                        color: 'var(--text-muted)',
                                                        opacity: 0.7
                                                    }}>
                                                        / {period.target} депов
                                                    </span>
                                                </div>
                                                <div style={{
                                                    padding: '0.5rem 0.75rem',
                                                    background: period.isCompleted 
                                                        ? 'rgba(16, 185, 129, 0.2)' 
                                                        : 'rgba(239, 68, 68, 0.2)',
                                                    borderRadius: '8px',
                                                    textAlign: 'center',
                                                    fontSize: '0.9rem',
                                                    fontWeight: '600',
                                                    color: period.isCompleted ? '#10b981' : '#ef4444'
                                                }}>
                                                    {period.isCompleted ? (
                                                        <>+{FormatUtils.formatCurrency(period.bonus)}</>
                                                    ) : (
                                                        <>Не выполнено</>
                                                    )}
                                                </div>
                                            </div>
                                            );
                                        })}
                                    </div>
                                    {salaryData.weeklyTargetBonus.totalBonus > 0 && (
                                        <div style={{
                                            marginTop: '1.25rem',
                                            padding: '1rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            borderRadius: '12px',
                                            border: '1px solid rgba(59, 130, 246, 0.3)',
                                            textAlign: 'center'
                                        }}>
                                            <div style={{
                                                fontSize: '0.85rem',
                                                color: 'var(--text-muted)',
                                                marginBottom: '0.5rem'
                                            }}>
                                                Итоговый бонус за недельный таргет
                                            </div>
                                            <div style={{
                                                fontSize: '1.5rem',
                                                fontWeight: '700',
                                                color: '#3b82f6'
                                            }}>
                                                +{FormatUtils.formatCurrency(salaryData.weeklyTargetBonus.totalBonus)}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                    </div>
                </div>
            );
        };
        
        const SettingsTab = () => {
            const { records, tariffs, monthlyGoals, plannedDays, managers, initialManagers, invalidBonusPerFTD, teamLeaderPerFTD, teamPlanBonusAmount, managerBaseRates, updateTariff, resetTariffs, updateMonthlyGoal, initializeMonthGoals, updatePlannedDays, updateInvalidBonus, updateTeamLeaderPerFTD, updateTeamPlanBonusAmount, addManager, deleteManager, updateManagerBaseRate, exportData, importData, disabledAgents, toggleAgentDisabled, isAgentDisabled, penalties, bonuses, attendance } = useData();
            const { addNotification } = useNotification();
            const [newManagerName, setNewManagerName] = useState('');
            const [newManagerRate, setNewManagerRate] = useState(() => String(tariffs[0]?.baseRate ?? DEFAULT_BASE_RATE));
            const [managerRatesDraft, setManagerRatesDraft] = useState({});
            const [selectedMonth, setSelectedMonth] = useSelectedMonth();
            useEffect(() => {
                initializeMonthGoals(selectedMonth);
            }, [selectedMonth, initializeMonthGoals]);
            useEffect(() => {
                setManagerRatesDraft({});
            }, [managerBaseRates]);
            const goals = monthlyGoals[selectedMonth] || {};
            const handleGoalChange = (manager, value) => {
                const numValue = parseInt(value) || 0;
                if (numValue < 0) {
                    addNotification('Цель не может быть отрицательной', 'error');
                    return;
                }
                updateMonthlyGoal(selectedMonth, manager, numValue);
                addNotification('Цель обновлена', 'success');
            };
            const handleTariffChange = (index, field, value) => {
                const errors = updateTariff(index, field, value);
                if (errors) {
                    Object.values(errors).forEach(err => addNotification(err, 'error'));
                } else {
                    addNotification('Тариф обновлен', 'success');
                }
            };
            const handlePlannedDaysChange = (value) => {
                const numValue = parseInt(value) || 22;
                if (numValue < 0) {
                    addNotification('Плановых дней не может быть отрицательным', 'error');
                    return;
                }
                updatePlannedDays(selectedMonth, numValue);
                addNotification('Плановые дни обновлены', 'success');
            };
            const handleInvalidBonusChange = (value) => {
                const numValue = parseFloat(value) || 0;
                if (numValue < 0) {
                    addNotification('Бонус не может быть отрицательным', 'error');
                    return;
                }
                updateInvalidBonus(numValue);
                addNotification('Бонус обновлен', 'success');
            };
            const handleAddManager = () => {
                const name = newManagerName.trim();
                if (!name) {
                    addNotification('Введите имя менеджера', 'error');
                    return;
                }
                if (managers.includes(name)) {
                    addNotification('Менеджер уже существует', 'error');
                    return;
                }
                const rate = parseFloat(newManagerRate);
                if (Number.isNaN(rate) || rate < 0) {
                    addNotification('Введите корректную ставку (0 или больше)', 'error');
                    return;
                }
                addManager(name, rate, selectedMonth);
                setNewManagerName('');
                setNewManagerRate(String(tariffs[0]?.baseRate ?? DEFAULT_BASE_RATE));
                addNotification('Менеджер добавлен', 'success');
            };
            const handleDeleteManager = (manager) => {
                if (confirm(`Удалить менеджера ${manager}? Это удалит связанные записи и цели.`)) {
                    deleteManager(manager);
                    setManagerRatesDraft(prev => {
                        const updated = { ...prev };
                        delete updated[manager];
                        return updated;
                    });
                    addNotification('Менеджер удален', 'success');
                }
            };
            const handleManagerRateBlur = async (manager) => {
                if (!(manager in managerRatesDraft)) {
                    return;
                }
                const rawValue = managerRatesDraft[manager];
                if (rawValue === '') {
                    addNotification('Ставка не может быть пустой', 'error');
                    setManagerRatesDraft(prev => {
                        const updated = { ...prev };
                        delete updated[manager];
                        return updated;
                    });
                    return;
                }
                const success = await updateManagerBaseRate(manager, rawValue);
                if (success) {
                    addNotification('Ставка обновлена', 'success');
                    setManagerRatesDraft(prev => {
                        const updated = { ...prev };
                        delete updated[manager];
                        return updated;
                    });
                } else {
                    addNotification('Ставка должна быть неотрицательным числом', 'error');
                }
            };
            const handleExport = () => {
                exportData();
                addNotification('Данные сохранены в файл', 'success');
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (file) {
                    importData(
                        file,
                        (msg) => addNotification(msg, 'success'),
                        (msg) => addNotification(msg, 'error')
                    );
                }
            };
            const monthName = DateUtils.formatMonthWithYear(selectedMonth);
            return (
                <div>
                    <MonthSelector 
                        label="Месяц для настройки планов:" 
                        value={selectedMonth} 
                        onChange={(e) => setSelectedMonth(e.target.value)} 
                    />
                    <div className="section" style={{
                        background: 'linear-gradient(135deg, #10b981, #059669)',
                        color: 'white'
                    }}>
                        <h3 style={{margin: 0, fontSize: '1.4rem', color: 'white'}}>
                            🎯 Современная система настроек
                        </h3>
                        <p style={{margin: '0.5rem 0 0 0', opacity: 0.9}}>
                            Настраивайте тарифы, цели и параметры расчета зарплат
                        </p>
                    </div>
                    <div className="section">
                        <h3>📅 Плановые рабочие дни</h3>
                        <p style={CommonStyles.mutedTextWithMargin}>
                            Установите количество плановых рабочих дней для месяца (исключая выходные и праздники)
                        </p>
                        <div className="form-group">
                            <label>Для {monthName}:</label>
                            <input
                                type="number"
                                value={plannedDays[selectedMonth] || 22}
                                onChange={(e) => handlePlannedDaysChange(e.target.value)}
                                min="0"
                                style={{width: '100px'}}
                            />
                        </div>
                        <button
                            className="btn btn-primary"
                            style={{marginTop: '1rem'}}
                            onClick={() => addNotification('Плановые дни сохранены!', 'success')}
                        >
                            Сохранить
                        </button>
                    </div>
                    <div className="section">
                        <h3>👥 Управление менеджерами</h3>
                        <p style={CommonStyles.mutedTextWithMargin}>
                            Добавляйте или удаляйте менеджеров в команде
                        </p>
                        <div className="form-group" style={{display: 'flex', gap: '1rem', alignItems: 'flex-end'}}>
                            <div style={{flex: 1}}>
                                <label>Новый менеджер:</label>
                                <input
                                    type="text"
                                    value={newManagerName}
                                    onChange={(e) => setNewManagerName(e.target.value)}
                                    placeholder="Введите имя менеджера"
                                />
                            </div>
                            <div>
                                <label>Ставка ($):</label>
                                <input
                                    type="number"
                                    min="0"
                                    step="0.01"
                                    value={newManagerRate}
                                    onChange={(e) => setNewManagerRate(e.target.value)}
                                    style={{width: '110px'}}
                                />
                            </div>
                            <button className="btn btn-primary" onClick={handleAddManager}>
                                Добавить
                            </button>
                        </div>
                        <div className="manager-list" style={{marginTop: '1rem'}}>
                            {managers.map(manager => {
                                const isTeamLeader = manager === TEAM_LEADER_NAME;
                                const isNewManager = !initialManagers.includes(manager);
                                const displayRate = managerRatesDraft[manager] ?? (managerBaseRates[manager] !== undefined ? String(managerBaseRates[manager]) : '');
                                return (
                                    <div key={manager} className="manager-item">
                                        <span style={{flex: 1, display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                                            <span>{manager}</span>
                                            <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                                {isTeamLeader && <span className="team-leader-badge">Тим-Лидер</span>}
                                                {isNewManager && <span className="sale-badge">Сейл</span>}
                                            </div>
                                        </span>
                                        <div style={CommonStyles.flexColumnStartSmall}>
                                            <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Ставка ($)</span>
                                            <input
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                value={displayRate}
                                                onChange={(e) => setManagerRatesDraft(prev => ({ ...prev, [manager]: e.target.value }))}
                                                onBlur={() => handleManagerRateBlur(manager)}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter') {
                                                        e.preventDefault();
                                                        e.currentTarget.blur();
                                                    }
                                                }}
                                                style={{width: '110px'}}
                                            />
                                        </div>
                                        <button className="btn btn-danger btn-sm" onClick={() => handleDeleteManager(manager)}>
                                            Удалить
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <div className="section">
                        <h3>💰 Настройка тарифов</h3>
                        <p style={CommonStyles.mutedTextWithMargin}>
                            Настройте ставки и бонусы за FTD для разных диапазонов депозитов
                        </p>
                        {tariffs.map((tariff, index) => {
                            const rangeText = tariff.max === 999 ? `${tariff.min}+` : `${tariff.min}-${tariff.max}`;
                            return (
                                <div key={index} className="tariff-item">
                                    <div className="tariff-range">{rangeText} депозитов</div>
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                        gap: '1rem'
                                    }}>
                                        <div className="form-group">
                                            <label>Мин:</label>
                                            <input
                                                type="number"
                                                value={tariff.min || 0}
                                                onChange={(e) => handleTariffChange(index, 'min', e.target.value)}
                                                min="0"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Макс:</label>
                                            <input
                                                type="number"
                                                value={tariff.max || 0}
                                                onChange={(e) => handleTariffChange(index, 'max', e.target.value)}
                                                min="0"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Базовая ставка ($):</label>
                                            <input
                                                type="number"
                                                value={tariff.baseRate || 0}
                                                onChange={(e) => handleTariffChange(index, 'baseRate', e.target.value)}
                                                min="0"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Бонус за валидный FTD ($):</label>
                                            <input
                                                type="number"
                                                value={tariff.bonusPerFTD || 0}
                                                onChange={(e) => handleTariffChange(index, 'bonusPerFTD', e.target.value)}
                                                min="0"
                                            />
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        <div style={{marginTop: '1rem', display: 'flex', gap: '1rem'}}>
                            <button
                                className="btn btn-primary btn-animated active-scale"
                                onClick={() => addNotification('Тарифы сохранены!', 'success')}
                            >
                                <span className="icon-bounce">💾</span> Сохранить тарифы
                            </button>
                            <button
                                className="btn btn-secondary btn-animated active-scale"
                                onClick={async () => {
                                    if (confirm('Сбросить тарифы к умолчанию?')) {
                                        await resetTariffs();
                                        addNotification('Тарифы сброшены!', 'success');
                                    }
                                }}
                            >
                                <span className="icon-bounce">🔄</span> Сбросить к умолчанию
                            </button>
                        </div>
                    </div>
                    <div className="section">
                        <h3>🎯 Установка планов FTD за {monthName}</h3>
                        <p style={CommonStyles.mutedTextWithMargin}>
                            Установите целевые значения FTD для каждого менеджера
                        </p>
                        <div className="goal-setting">
                            {managers.map(manager => {
                                const isTeamLeader = manager === TEAM_LEADER_NAME;
                                const isNewManager = !initialManagers.includes(manager);
                                const disabled = isAgentDisabled(selectedMonth, manager);
                                return (
                                    <div key={manager} className="goal-item" style={{opacity: disabled ? 0.6 : 1}}>
                                        <span style={{minWidth: '140px', fontWeight: '600', display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                                            <span>{manager}:</span>
                                            <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                                {isTeamLeader && <span className="team-leader-badge">Тим-Лидер</span>}
                                                {isNewManager && <span className="sale-badge">Сейл</span>}
                                                {disabled && <span style={{background: '#ef4444', color: 'white', padding: '0.25rem 0.75rem', borderRadius: '9999px', fontSize: '0.8rem', fontWeight: '600'}}>Отключен</span>}
                                            </div>
                                        </span>
                                        <input
                                            type="number"
                                            value={goals[manager] || ''}
                                            onChange={(e) => handleGoalChange(manager, e.target.value)}
                                            min="0"
                                            style={{width: '80px'}}
                                            disabled={disabled}
                                        />
                                        <span style={{color: 'var(--text-muted)', fontSize: '0.9rem'}}>FTD в месяц</span>
                                        <button
                                            className={`btn ${disabled ? 'btn-primary' : 'btn-danger'} btn-sm`}
                                            onClick={() => {
                                                toggleAgentDisabled(selectedMonth, manager);
                                                addNotification(disabled ? 'Агент включен' : 'Агент отключен', 'success');
                                            }}
                                            style={{marginLeft: '1rem'}}
                                        >
                                            {disabled ? '✅ Включить' : '⛔ Отключить'}
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                        <p style={{...CommonStyles.mutedText, marginTop: '1rem', padding: '0.75rem', background: '#fef3c7', borderRadius: '8px', border: '1px solid #fbbf24'}}>
                            💡 <strong>Отключенные агенты:</strong> Таргет отключенного агента не учитывается в расчетах общего плана команды и статистики за выбранный месяц.
                        </p>
                    </div>
                    <div className="section">
                        <h3>💸 Бонус за невалидные FTD</h3>
                        <p style={CommonStyles.mutedText}>
                            Установите сумму бонуса за каждый невалидный депозит
                        </p>
                        <div className="form-group">
                            <label>Бонус за невалидный FTD ($):</label>
                            <input
                                type="number"
                                value={invalidBonusPerFTD}
                                onChange={(e) => handleInvalidBonusChange(e.target.value)}
                                min="0"
                                style={{width: '100px'}}
                            />
                        </div>
                        <button
                            className="btn btn-primary"
                            style={CommonStyles.marginTopSmall}
                            onClick={() => addNotification('Бонус за невалидные FTD сохранен!', 'success')}
                        >
                            Сохранить
                        </button>
                    </div>
                    <div className="section">
                        <h3>🔒 Резервное копирование</h3>
                        <p style={CommonStyles.mutedText}>
                            Сохраните или восстановите данные из localStorage в файл
                        </p>
                        <div style={CommonStyles.flexGap}>
                            <button className="btn btn-primary" onClick={handleExport}>
                                Сохранить данные в файл
                            </button>
                            <input
                                type="file"
                                accept=".json"
                                onChange={handleImport}
                                style={CommonStyles.hiddenInput}
                                id="import-file"
                            />
                            <label htmlFor="import-file" className="btn btn-secondary" style={CommonStyles.cursorPointer}>
                                Восстановить из файла
                            </label>
                        </div>
                    </div>
                    <div className="section" style={CommonStyles.warningSection}>
                        <h3 style={CommonStyles.warningTitle}>💡 Бонусная система</h3>
                        <p style={CommonStyles.warningText}>
                            За выполнение плана FTD менеджер получает дополнительный бонус <strong>$100</strong>.
                        </p>
                        <p style={CommonStyles.warningText}>
                            Для Тим-Лидер ({TEAM_LEADER_NAME}): +<strong>${teamLeaderPerFTD}</strong> за каждый валидный депозит, +<strong>100$</strong> за каждого сотрудника с выполненным планом.
                        </p>
                        <p style={CommonStyles.warningText}>
                            Бонус за общий план команды: <strong>${teamPlanBonusAmount}</strong> начисляется только тим-лидеру при выполнении общего плана команды и наличии 2 или более сейлов.
                        </p>
                        <p style={CommonStyles.warningText}>
                            За каждый невалидный депозит начисляется бонус <strong>${invalidBonusPerFTD}</strong>.
                        </p>
                        <p style={{...CommonStyles.warningText, marginBottom: 0}}>
                            Посещаемость: базовая ставка корректируется пропорционально отработанным дням ({plannedDays[selectedMonth] || 22} плановых).
                        </p>
                    </div>
                </div>
            );
        };
        
        const EditRecordForm = ({ 
            editForm, 
            setEditForm, 
            managers, 
            trafficOptions, 
            countryOptions, 
            onSave, 
            onCancel 
        }) => {
            return (
                                            <>
                                                <td>
                                                    <input
                                                        type="date"
                                                        value={editForm.date}
                                                        onChange={(e) => setEditForm({ ...editForm, date: e.target.value })}
                                                        required
                                                    />
                                                </td>
                                                <td>
                                                    <select
                                                        value={editForm.manager}
                                                        onChange={(e) => setEditForm({ ...editForm, manager: e.target.value })}
                                                        required
                                                    >
                                                        <option value="">Выберите менеджера</option>
                                                        {managers.map(m => <option key={m} value={m}>{m}</option>)}
                                                    </select>
                                                </td>
                                                <td>
                                                    <input
                                                        type="text"
                                                        value={editForm.clientId}
                                                        onChange={(e) => setEditForm({ ...editForm, clientId: e.target.value })}
                                                        required
                                                    />
                                                </td>
                                                <td>
                                                    <select
                                                        value={editForm.validity}
                                                        onChange={(e) => setEditForm({ ...editForm, validity: e.target.value })}
                                                        required
                                                    >
                                                        <option value="">Выберите</option>
                                                        <option value="valid">Валидный</option>
                                                        <option value="invalid">Невалидный</option>
                                                        <option value="pending">На рассмотрении</option>
                                                        <option value="not_counted">Не засчитано</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select
                                                        value={editForm.traffic}
                                                        onChange={(e) => setEditForm({ ...editForm, traffic: e.target.value })}
                                                        required
                                                    >
                                                        <option value="">Выберите трафик</option>
                                                        {trafficOptions.map(t => <option key={t} value={t}>{t}</option>)}
                                                    </select>
                                                </td>
                                                <td>
                                                    <select
                                                        value={editForm.country}
                                                        onChange={(e) => setEditForm({ ...editForm, country: e.target.value })}
                                                        required
                                                    >
                                                        <option value="">Выберите страну</option>
                                                        {countryOptions.map(c => <option key={c} value={c}>{c}</option>)}
                                                    </select>
                                                </td>
                                                <td>
                        <button className="btn btn-primary btn-sm btn-animated active-scale" onClick={onSave}>
                                                        <span className="icon-bounce">💾</span> Сохранить
                                                    </button>
                        <button className="btn btn-secondary btn-sm btn-animated active-scale" onClick={onCancel}>
                                                        <span className="icon-bounce">❌</span> Отмена
                                                    </button>
                                                </td>
                                            </>
            );
        };
        
        const RecordTableRow = ({ 
            record, 
            index, 
            isEditing, 
            editForm, 
            setEditForm, 
            onEdit, 
            onSave, 
            onCancel, 
            onDelete,
            managers,
            trafficOptions,
            countryOptions,
            initialManagers
        }) => {
            const isTeamLeader = ManagerUtils.isTeamLeader(record.manager);
            const isNewManager = ManagerUtils.isNewManager(record.manager, initialManagers);
            
            return (
                <tr key={record.id} className="table-row table-row-enter" style={{animationDelay: `${index * 0.1}s`}}>
                    {isEditing ? (
                        <EditRecordForm
                            editForm={editForm}
                            setEditForm={setEditForm}
                            managers={managers}
                            trafficOptions={trafficOptions}
                            countryOptions={countryOptions}
                            onSave={onSave}
                            onCancel={onCancel}
                        />
                                        ) : (
                                            <>
                                                <td>{DateUtils.formatDateShort(record.date)}</td>
                            <td>
                                {record.manager}
                                {isTeamLeader && <span className="team-leader-badge">Тим-Лидер</span>}
                                {isNewManager && <span className="sale-badge">Сейл</span>}
                            </td>
                                                <td>{record.clientId}</td>
                                                <td>
                                                    <Badge variant={
                                                        record.validity === 'valid' ? 'success' : 
                                                        record.validity === 'invalid' ? 'danger' : 
                                                        record.validity === 'not_counted' ? 'secondary' :
                                                        'warning'
                                                    }>
                                                        {record.validity === 'valid' ? 'Валидный' : 
                                                         record.validity === 'invalid' ? 'Невалидный' : 
                                                         record.validity === 'not_counted' ? 'Не засчитано' :
                                                         'На рассмотрении'}
                                                    </Badge>
                                                </td>
                                                <td>{record.traffic || trafficOptions[0]}</td>
                                                <td>{record.country || countryOptions[0]}</td>
                                                <td>
                                                    <button
                                                        className="btn btn-primary btn-sm btn-animated active-scale"
                                    onClick={() => onEdit(record)}
                                                    >
                                                        <span className="icon-bounce">✏️</span> Редактировать
                                                    </button>
                                                    <button
                                                        className="btn btn-danger btn-sm btn-animated active-scale"
                                                        onClick={() => onDelete(record.id)}
                                                    >
                                                        <span className="icon-bounce">🗑️</span> Удалить
                                                    </button>
                                                </td>
                                            </>
                                        )}
                                    </tr>
                                );
        };
        
        const SortableTable = ({ onDelete, monthFilter }) => {
            const { records, sortConfig, setSortConfig, updateRecord, managers, initialManagers, trafficOptions, countryOptions } = useData();
            const { addNotification } = useNotification();
            const [search, setSearch] = useState('');
            const [editId, setEditId] = useState(null);
            const [editForm, setEditForm] = useState({});
            
            const filteredRecords = useMemo(() => {
                let filtered = records;
                
                if (search.trim()) {
                    filtered = filtered.filter(record =>
                        record.clientId.toLowerCase().includes(search.toLowerCase())
                    );
                } else if (monthFilter) {
                    filtered = DateUtils.filterByMonth(filtered, monthFilter);
                }
                
                return filtered;
            }, [records, search, monthFilter]);
            
            const sortedRecords = useMemo(() => {
                return SortUtils.sortRecords(filteredRecords, sortConfig);
            }, [filteredRecords, sortConfig]);
            
            const handleSort = useCallback((key) => {
                const direction = SortUtils.getSortDirection(key, sortConfig);
                setSortConfig({ key, direction });
            }, [sortConfig, setSortConfig]);
            
            const handleEdit = useCallback((record) => {
                setEditId(record.id);
                setEditForm({ 
                    ...record,
                    traffic: record.traffic || trafficOptions[0],
                    country: record.country || countryOptions[0]
                });
            }, [trafficOptions, countryOptions]);
            
            const saveEdit = useCallback(() => {
                const validation = Validator.validateRecord(editForm);
                if (!validation.isValid) {
                    Object.values(validation.errors).forEach(err => addNotification(err, 'error'));
                    return;
                }
                updateRecord(editId, editForm);
                setEditId(null);
                setEditForm({});
                addNotification('Запись обновлена', 'success');
            }, [editForm, editId, updateRecord, addNotification]);
            
            const cancelEdit = useCallback(() => {
                setEditId(null);
                setEditForm({});
            }, []);
            
            const handleSearchChange = useCallback((e) => {
                setSearch(e.target.value);
            }, []);
            
            return (
                <div className="table-container">
                    <div className="form-group" style={{...CommonStyles.marginBottomSmall, maxWidth: '100%', width: '100%', boxSizing: 'border-box'}}>
                        <label>Поиск по ID клиента:</label>
                        <input
                            type="text"
                            value={search}
                            onChange={handleSearchChange}
                            placeholder="Введите ID клиента"
                            style={{
                                maxWidth: '100%', 
                                boxSizing: 'border-box',
                                transition: 'none',
                                transform: 'none',
                                boxShadow: 'none',
                                borderColor: 'var(--border)'
                            }}
                            onFocus={(e) => {
                                e.target.style.borderColor = 'var(--border)';
                                e.target.style.boxShadow = 'none';
                                e.target.style.transform = 'none';
                            }}
                            onBlur={(e) => {
                                e.target.style.borderColor = 'var(--border)';
                                e.target.style.boxShadow = 'none';
                                e.target.style.transform = 'none';
                            }}
                            onMouseEnter={(e) => {
                                e.target.style.borderColor = 'var(--border)';
                                e.target.style.boxShadow = 'none';
                                e.target.style.transform = 'none';
                            }}
                            onMouseLeave={(e) => {
                                e.target.style.borderColor = 'var(--border)';
                                e.target.style.boxShadow = 'none';
                                e.target.style.transform = 'none';
                            }}
                        />
                    </div>
                    <table className="table">
                        <thead>
                            <tr>
                                <th className={SortUtils.getSortClass('date', sortConfig)} onClick={() => handleSort('date')}>
                                    Дата
                                </th>
                                <th className={SortUtils.getSortClass('manager', sortConfig)} onClick={() => handleSort('manager')}>
                                    Менеджер
                                </th>
                                <th className={SortUtils.getSortClass('clientId', sortConfig)} onClick={() => handleSort('clientId')}>
                                    ID клиента
                                </th>
                                <th className={SortUtils.getSortClass('validity', sortConfig)} onClick={() => handleSort('validity')}>
                                    Валидность
                                </th>
                                <th className={SortUtils.getSortClass('traffic', sortConfig)} onClick={() => handleSort('traffic')}>
                                    Трафик
                                </th>
                                <th className={SortUtils.getSortClass('country', sortConfig)} onClick={() => handleSort('country')}>
                                    Страна
                                </th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedRecords.map((record, index) => (
                                <RecordTableRow
                                    key={record.id}
                                    record={record}
                                    index={index}
                                    isEditing={editId === record.id}
                                    editForm={editForm}
                                    setEditForm={setEditForm}
                                    onEdit={handleEdit}
                                    onSave={saveEdit}
                                    onCancel={cancelEdit}
                                    onDelete={onDelete}
                                    managers={managers}
                                    trafficOptions={trafficOptions}
                                    countryOptions={countryOptions}
                                    initialManagers={initialManagers}
                                />
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };
        const LoginLoadingAnimation = ({ progress, statusText }) => {
            return (
                <div className="login-loading-overlay">
                    
                    <div className="login-loading-content">
                        <div className="loading-logo-container">
                            <div className="loading-logo-glow" />
                            <div className="loading-logo">📊</div>
                        </div>
                        
                        <h1 className="loading-title">FTD Tracker</h1>
                        <p className="loading-subtitle">Выполняется вход в систему...</p>
                        
                        <div className="loading-progress-container">
                            <div className="loading-progress-bar">
                                <div 
                                    className="loading-progress-fill"
                                    style={{ width: `${progress}%` }}
                                />
                            </div>
                        </div>
                        
                        <div className="loading-spinner-container">
                            <div className="loading-spinner" />
                        </div>
                        
                        {statusText && (
                            <div className="loading-status-text">{statusText}</div>
                        )}
                    </div>
                </div>
            );
        };
        
        const Login = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isExiting, setIsExiting] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [showLoadingAnimation, setShowLoadingAnimation] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [loadingStatusText, setLoadingStatusText] = useState('');
            const { login } = useUser();
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setIsSubmitting(true);
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const user = users[username];
                const isPasswordValid = typeof user === 'string' 
                    ? user === password 
                    : user && user.password === password;
                
                if (isPasswordValid) {
                    if (typeof user === 'string') {
                        users[username] = { password: password };
                    }
                    login(username);
                    setShowLoadingAnimation(true);
                    
                    const statusMessages = [
                        'Проверка учетных данных...',
                        'Подключение к серверу...',
                        'Загрузка данных...',
                        'Инициализация системы...',
                        'Почти готово...'
                    ];
                    
                    for (let i = 0; i <= 100; i += 2) {
                        await new Promise(resolve => setTimeout(resolve, 30));
                        setLoadingProgress(i);
                        
                        if (i < 20) {
                            setLoadingStatusText(statusMessages[0]);
                        } else if (i < 40) {
                            setLoadingStatusText(statusMessages[1]);
                        } else if (i < 60) {
                            setLoadingStatusText(statusMessages[2]);
                        } else if (i < 80) {
                            setLoadingStatusText(statusMessages[3]);
                        } else {
                            setLoadingStatusText(statusMessages[4]);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    setIsExiting(true);
                    await new Promise(resolve => setTimeout(resolve, 400));
                    onLogin();
                } else {
                    setError('Неверный логин или пароль');
                    setIsSubmitting(false);
                }
            };
            
            if (showLoadingAnimation) {
                return <LoginLoadingAnimation progress={loadingProgress} statusText={loadingStatusText} />;
            }
            
            return (
                <div className={`login-glass-3d ${isExiting ? 'animate-fade-out' : ''}`}>
                    
                    {/* Glassmorphism карточка с 3D эффектом */}
                    <div className="glass-card-3d">
                        <div className="glass-card-inner">
                            <div className="glass-header-3d">
                                <div className="glass-icon-3d">
                                    <div className="icon-3d-wrapper">
                                        <div className="icon-3d">📊</div>
                                        <div className="icon-glow-3d"></div>
                                    </div>
                                </div>
                                <h1 className="glass-title-3d">FTD Tracker</h1>
                                <div className="glass-subtitle">Система учета и аналитики</div>
                            </div>
                            
                            <div className="glass-content-3d">
                                <form onSubmit={handleSubmit} className="glass-form-3d">
                                    <div className="glass-input-wrapper-3d">
                                        <div className="glass-input-container">
                                            <input 
                                                type="text"
                                                id="username"
                                                value={username}
                                                onChange={e => setUsername(e.target.value)}
                                                placeholder=" "
                                                required
                                                disabled={isSubmitting}
                                                className="glass-input-3d"
                                            />
                                            <label htmlFor="username" className="glass-label-3d">👤 Логин</label>
                                            <div className="glass-input-line"></div>
                                        </div>
                                    </div>
                                    
                                    <div className="glass-input-wrapper-3d">
                                        <div className="glass-input-container">
                                            <input 
                                                type={showPassword ? 'text' : 'password'}
                                                id="password"
                                                value={password}
                                                onChange={e => setPassword(e.target.value)}
                                                placeholder=" "
                                                required
                                                disabled={isSubmitting}
                                                className="glass-input-3d"
                                            />
                                            <label htmlFor="password" className="glass-label-3d">🔒 Пароль</label>
                                            <button
                                                type="button"
                                                className="glass-password-toggle"
                                                onClick={() => setShowPassword(!showPassword)}
                                                tabIndex={-1}
                                            >
                                                {showPassword ? '👁️' : '👁️‍🗨️'}
                                            </button>
                                            <div className="glass-input-line"></div>
                                        </div>
                                    </div>
                                    
                                    {error && (
                                        <div className="glass-error-3d animate-shake">
                                            <span className="error-icon-3d">⚠️</span>
                                            {error}
                                        </div>
                                    )}
                                    
                                    <button 
                                        type="submit" 
                                        className={`glass-button-3d ${isSubmitting ? 'loading' : ''}`}
                                        disabled={isSubmitting}
                                    >
                                        <span className="button-content-3d">
                                            {isSubmitting ? (
                                                <>
                                                    <span className="button-spinner-3d">🔄</span>
                                                    <span>Вход...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <span>🚪</span>
                                                    <span>Войти</span>
                                                </>
                                            )}
                                        </span>
                                        <div className="button-ripple-3d"></div>
                                    </button>
                                </form>
                                
                                <div className="glass-footer-3d">
                                    <div className="security-badge-3d">
                                        <span>🔐</span>
                                        <span>Безопасный вход</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Glassmorphism эффект - отражение */}
                        <div className="glass-reflection"></div>
                    </div>
                </div>
            );
        };
        const App = () => {
            const [activeTab, setActiveTab] = useState('general-plan');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [isAppLoading, setIsAppLoading] = useState(true);
            const { currentUser, logout: userLogout } = useUser();
            const { 
                records, 
                monthlyGoals, 
                managers, 
                disabledAgents, 
                penalties, 
                bonuses, 
                tariffs, 
                plannedDays, 
                attendance, 
                initialManagers, 
                managerBaseRates, 
                invalidBonusPerFTD, 
                teamLeaderPerFTD, 
                teamPlanBonusAmount,
                createBackup
            } = useData();
            
            const tabs = useMemo(() => [
                { id: 'general-plan', label: '🏆 Общий план', component: GeneralPlanTab },
                { id: 'data-entry', label: 'Ввод данных', component: DataEntryTab },
                { id: 'attendance', label: '📅 Посещаемость', component: AttendanceTab },
                { id: 'statistics', label: 'Статистика', component: StatisticsTab },
                { id: 'monthly-stats', label: 'По месяцам', component: MonthlyStatsTab },
                { id: 'team-leader-salary', label: '💰 Зарплата тим-лидера', component: TeamLeaderSalaryTab },
                { id: 'settings', label: '⚙️ Настройки', component: SettingsTab }
            ], []);
            
            useEffect(() => {
                const loadAppData = async () => {
                    try {
                        const [loadedActiveTab, loggedIn, loginTime] = await Promise.all([
                            StorageUtils.getItem('activeTab', 'general-plan'),
                            StorageUtils.getItem('loggedIn', false),
                            StorageUtils.getItem('loginTime', 0)
                        ]);
                        
                        setActiveTab(loadedActiveTab);
                        
                        const twoHours = 2 * 60 * 60 * 1000;
                        if (loggedIn && Date.now() - loginTime < twoHours) {
                            setIsLoggedIn(true);
                        } else {
                            await StorageUtils.removeItem('loggedIn');
                            await StorageUtils.removeItem('loginTime');
                            setIsLoggedIn(false);
                        }
                        
                        setIsAppLoading(false);
                    } catch (error) {
('Ошибка загрузки данных приложения:', error);
                        setIsAppLoading(false);
                    }
                };
                
                loadAppData();
            }, []);
            
            useEffect(() => {
                if (isLoggedIn) {
                    const twoHours = 2 * 60 * 60 * 1000;
                    const timeout = setTimeout(async () => {
                        await StorageUtils.removeItem('loggedIn');
                        await StorageUtils.removeItem('loginTime');
                        setIsLoggedIn(false);
                    }, twoHours);
                    return () => clearTimeout(timeout);
                }
            }, [isLoggedIn]);
            
            useEffect(() => {
                if (!isLoggedIn) return; 
                if (!tabs || tabs.length === 0) return;
                const tabExists = tabs.some(tab => tab.id === activeTab);
                if (!tabExists) {
                    setActiveTab(tabs[0].id);
                    StorageUtils.setItem('activeTab', tabs[0].id);
                }
            }, [isLoggedIn, activeTab, tabs]);
            
            const handleLogin = async () => {
                await StorageUtils.setItem('loggedIn', true);
                await StorageUtils.setItem('loginTime', Date.now());
                setIsLoggedIn(true);
            };
            
            const handleLogout = async () => {
                await StorageUtils.removeItem('loggedIn');
                await StorageUtils.removeItem('loginTime');
                userLogout();
                setIsLoggedIn(false);
            };
            
            if (isAppLoading) {
                return (
                    <div className="animate-fade-in" style={{
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        height: '100vh',
                        fontSize: '1.2rem',
                        color: 'var(--primary)',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                    }}>
                        <div className="animate-scale-in" style={{ textAlign: 'center' }}>
                            <div className="loading-spinner" style={{ marginBottom: '1rem', fontSize: '2rem' }}>🔄</div>
                            <div className="animate-fade-in">Инициализация приложения<span className="loading-dots"></span></div>
                        </div>
                    </div>
                );
            }
            
            if (!isLoggedIn) {
                return <Login onLogin={handleLogin} />;
            }
            
            const handleTabChange = async (tabId) => {
                setActiveTab(tabId);
                await StorageUtils.setItem('activeTab', tabId);
            };
            
            const ActiveComponent = tabs.find(tab => tab.id === activeTab)?.component || GeneralPlanTab;
            
            return (
                <div className="container animate-fade-in">
                    <div className="card card-animated">
                        <div className="header">
                            <h1 className="animate-scale-in">📊 FTD Statistics Tracker</h1>
                            <p className="animate-fade-in">Современная система учета статистики и расчета зарплат менеджеров</p>
                            <button 
                                className="btn btn-danger btn-animated active-scale" 
                                style={{position: 'absolute', top: '1rem', right: '1rem'}} 
                                onClick={handleLogout}
                            >
                                <span className="icon-bounce">🚪</span> Выход
                            </button>
                        </div>
                        <div className="tabs">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    className={`tab active-scale ${activeTab === tab.id ? 'active' : ''}`}
                                    onClick={() => handleTabChange(tab.id)}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                        <div className="content">
                            <div className={`tab-content animate-fade-in ${activeTab ? 'active' : ''}`}>
                                <ActiveComponent />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        try {
            const rootElement = document.getElementById('root');
            if (!rootElement) {
                throw new Error('Элемент root не найден');
            }
            
            ReactDOM.render(
                <ErrorBoundary>
                    <NotificationProvider>
                        <UserProvider>
                            <DataProvider>
                                <App />
                            </DataProvider>
                        </UserProvider>
                    </NotificationProvider>
                </ErrorBoundary>, 
                rootElement
            );
        } catch (error) {
('Ошибка инициализации React:', error);
        }
    </script>
</body>
</html>